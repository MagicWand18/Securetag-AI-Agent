const express = require('express');
const DOMPurify = require('isomorphic-dompurify');
const { JSDOM } = require('jsdom');

const app = express();

// Configuración de DOMPurify con jsdom para sanitizar SVG
const window = new JSDOM('').window;
const purify = DOMPurify(window);

// Lista explícita de atributos SVG permitidos (se excluyen animate y eventos)
const ALLOWED_SVG_TAGS = [
  'svg', 'g', 'path', 'rect', 'circle', 'ellipse', 'line', 'polyline', 'polygon',
  'text', 'tspan', 'defs', 'clipPath', 'mask', 'linearGradient', 'radialGradient',
  'stop', 'pattern', 'use'
];

const ALLOWED_SVG_ATTRS = [
  'width', 'height', 'viewBox', 'fill', 'stroke', 'stroke-width', 'd', 'x', 'y',
  'cx', 'cy', 'r', 'x1', 'y1', 'x2', 'y2', 'points', 'transform', 'id', 'class'
  // NO se incluyen atributos de animación como 'animate', 'from', 'to', 'dur',
  // ni atributos de evento (onload, onclick, etc.)
];

app.get('/view-svg', (req, res) => {
  const userSvg = req.query.svg || '<svg><text>No SVG</text></svg>';

  // Sanitización estricta del SVG, bloqueando atributos de animación y eventos
  const sanitizedSvg = purify.sanitize(userSvg, {
    ALLOWED_TAGS: ALLOWED_SVG_TAGS,
    ALLOWED_ATTR: ALLOWED_SVG_ATTRS,
    // Elimina cualquier atributo que empiece por "on" (onload, onclick, etc.)
    FORBID_ATTR: [/^on/i],
    // Opcionalmente, se puede forzar el namespace SVG
    USE_PROFILES: { svg: true }
  });

  const html = `<!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8" />
      <title>Vista SVG</title>
    </head>
    <body>
      <h1>Vista de SVG (SEGURO)</h1>
      <div id="svg-container">
        ${sanitizedSvg}
      </div>
    </body>
  </html>`;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
});

app.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001/view-svg?svg=...');
});
