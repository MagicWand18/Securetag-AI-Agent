const express = require('express');
const createDOMPurify = require('dompurify');
const { JSDOM } = require('jsdom');

const app = express();

// Configuración de DOMPurify en entorno Node.js
const window = new JSDOM('').window;
const DOMPurify = createDOMPurify(window);

// Lista blanca estricta de elementos y atributos SVG permitidos
// Se EXCLUYEN explícitamente <animate>, <set>, <animateTransform>, eventos on*, xlink:href con javascript:, etc.
DOMPurify.setConfig({
  ALLOWED_TAGS: [
    'svg', 'g', 'path', 'circle', 'rect', 'line', 'polyline', 'polygon',
    'ellipse', 'text', 'tspan', 'defs', 'linearGradient', 'radialGradient',
    'stop', 'clipPath', 'mask', 'pattern', 'use'
  ],
  ALLOWED_ATTR: [
    'width', 'height', 'viewBox', 'fill', 'stroke', 'stroke-width',
    'd', 'cx', 'cy', 'r', 'x', 'y', 'x1', 'y1', 'x2', 'y2',
    'points', 'transform', 'id', 'class', 'style', 'href'
  ],
  // Bloquea cualquier atributo que empiece por "on" (onload, onbegin, onclick, etc.)
  FORBID_ATTR: [/^on/i],
  // Bloquea elementos de animación que se usaron en el bug de Roundcube
  FORBID_TAGS: ['animate', 'set', 'animateTransform', 'animateMotion'],
  // Sanitiza URLs potencialmente peligrosas
  ALLOW_UNKNOWN_PROTOCOLS: false
});

app.get('/preview', (req, res) => {
  const rawSvgContent = req.query.svg || '';

  // Sanitización robusta del SVG antes de incrustarlo en el HTML
  const sanitizedSvg = DOMPurify.sanitize(rawSvgContent, { USE_PROFILES: { svg: true } });

  const html = `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8" />
        <title>Vista previa SVG (segura)</title>
      </head>
      <body>
        <h1>Vista previa de imagen SVG</h1>
        <div id="svg-container">
          ${sanitizedSvg}
        </div>
      </body>
    </html>
  `;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
});

app.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001');
});
