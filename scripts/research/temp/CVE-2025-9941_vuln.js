const express = require('express');
const multer = require('multer');
const path = require('path');

const app = express();

// === CONFIGURACIÓN VULNERABLE ===
// Sube cualquier archivo sin validar tipo, tamaño ni ruta
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    // Directorio accesible públicamente
    cb(null, path.join(__dirname, 'public', 'uploads'));
  },
  filename: function (req, file, cb) {
    // Usa el nombre original del archivo (riesgo de sobrescritura / path tricks)
    cb(null, file.originalname);
  }
});

const upload = multer({ storage: storage });

app.post('/register', upload.single('uimage'), (req, res) => {
  // Simula registro de usuario con imagen de perfil
  const { username, email } = req.body;

  // No se valida el tipo de archivo subido
  // No se valida el tamaño
  // No se valida la extensión
  // No se valida que sea realmente una imagen

  if (!req.file) {
    return res.status(400).send('Image is required');
  }

  // Ruta final del archivo accesible desde la web
  const imageUrl = `/uploads/${req.file.filename}`;

  // Aquí se podría guardar en BD el usuario + imageUrl
  // ... (omitido por simplicidad)

  res.json({
    message: 'User registered (INSECURE FILE UPLOAD)',
    username,
    email,
    imageUrl
  });
});

app.listen(3000, () => {
  console.log('Vulnerable app listening on port 3000');
});
