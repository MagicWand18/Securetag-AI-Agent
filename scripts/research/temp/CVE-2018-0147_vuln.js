const express = require('express');
const bodyParser = require('body-parser');
const vm = require('vm');

// Simulación de un servicio que "deserializa" datos de usuario
// y ejecuta lógica basada en ellos (similar a deserialización insegura en Java)

const app = express();
app.use(bodyParser.json());

// Mapa de "clases" disponibles en el sistema
const handlers = {
  "User": function (data) {
    this.username = data.username;
    this.role = data.role || 'user';
  },
  "AdminTask": function (data) {
    this.task = data.task;
  }
};

// FUNCIÓN VULNERABLE: deserializa y ejecuta código arbitrario
function insecureDeserializeAndExecute(payload) {
  // El cliente envía un objeto con un campo "type" y "data"
  // Ejemplo esperado:
  // { "type": "User", "data": { "username": "alice" } }

  const type = payload.type;
  const data = payload.data || {};

  // 1) Se permite que el cliente elija el "tipo" libremente
  // 2) Se permite que el cliente envíe un campo especial "__code" que se ejecuta

  // Si el payload contiene "__code", se ejecuta en un contexto con acceso a 'require'
  if (typeof payload.__code === 'string') {
    // DESERIALIZACIÓN / EJECUCIÓN INSEGURA DE CONTENIDO CONTROLADO POR EL USUARIO
    // Esto es análogo a deserializar un objeto Java con un gadget que ejecuta comandos.
    const context = {
      require: require,
      console: console,
      process: process,
      payload: payload,
      handlers: handlers
    };

    // vm.runInNewContext no es seguro si se exponen objetos potentes como 'require' o 'process'
    vm.runInNewContext(payload.__code, context); // VULNERABLE: RCE
  }

  // Instanciación dinámica basada en el tipo proporcionado por el usuario
  if (!handlers[type]) {
    throw new Error('Tipo no soportado: ' + type);
  }

  const Obj = handlers[type];
  const instance = new Obj(data);
  return instance;
}

app.post('/api/deserialize', (req, res) => {
  try {
    const payload = req.body;
    const result = insecureDeserializeAndExecute(payload);
    res.json({ ok: true, result });
  } catch (err) {
    console.error('Error en deserialización insegura:', err);
    res.status(400).json({ ok: false, error: 'Error procesando el objeto' });
  }
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});

/*
Ejemplo de payload malicioso (RCE):

POST /api/deserialize
Content-Type: application/json

{
  "type": "User",
  "data": { "username": "attacker" },
  "__code": "require('child_process').exec('id', (e,so,se)=>console.log(so));"
}

Esto permite a un atacante remoto no autenticado ejecutar comandos arbitrarios.
*/
