const http = require('http');
const url = require('url');
const vm = require('vm');

// Servidor HTTP sencillo que "deserializa" datos de usuario de forma insegura
// simulando un caso de deserialización insegura similar al de CVE-2018-0147
// (ejecución de comandos arbitrarios a partir de datos controlados por el usuario).

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (req.method === 'POST' && parsedUrl.pathname === '/api/deserialize') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      try {
        // VULNERABILIDAD: deserialización/ejecución directa de datos controlados por el usuario
        // El cliente envía un "objeto serializado" como código JavaScript en texto plano.
        // Aquí se evalúa directamente con vm.runInThisContext, lo que permite RCE.
        // Ejemplo de payload malicioso: {"payload":"require('child_process').execSync('id').toString()"}

        const parsed = JSON.parse(body);
        const userPayload = parsed.payload; // controlado por el usuario

        // Uso inseguro de vm.runInThisContext con datos sin validar
        const result = vm.runInThisContext(userPayload); // RCE potencial

        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ status: 'ok', result }));
      } catch (err) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Invalid payload', details: err.message }));
      }
    });
  } else {
    res.writeHead(404, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'Not found' }));
  }
});

server.listen(3000, () => {
  console.log('Insecure deserialization demo server listening on port 3000');
});
