rules:
  - id: synthetic-cve202555743
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible vulnerabilidad similar a CVE-2025-55743: subida de archivos con multer
      sin validación robusta en el servidor. El código confía en el nombre original
      y/o en el mimetype controlado por el cliente, y almacena el archivo en una
      ruta potencialmente pública. Un atacante puede subir contenido arbitrario
      (por ejemplo, scripts .php, .js o binarios) cambiando extensión y cabeceras,
      lo que puede derivar en ejecución remota de código, XSS o exposición de datos.
      Valida el tipo MIME y el contenido real del archivo en el servidor, restringe
      las extensiones permitidas y evita servir directamente los archivos subidos.
    patterns:
      # 1) Detectar configuración de multer.diskStorage con filename basado en file.originalname
      - pattern-inside: |
          const $MULTER = require('multer');
          ...
      - pattern-either:
          - patterns:
              - pattern: |
                  $STORAGE = $MULTER.diskStorage({
                    ...
                    filename: ($REQ, $FILE, $CB) => {
                      ...
                      $CB(..., ...$FILE.originalname...);
                    }
                    ...
                  });
          - patterns:
              - pattern: |
                  $STORAGE = $MULTER.diskStorage({
                    ...
                    filename: function ($REQ, $FILE, $CB) {
                      ...
                      $CB(..., ...$FILE.originalname...);
                    }
                    ...
                  });
      # 2) Detectar uso de multer con ese storage
      - pattern-either:
          - pattern: |
              const $UPLOAD = $MULTER({ storage: $STORAGE, ... });
          - pattern: |
              let $UPLOAD = $MULTER({ storage: $STORAGE, ... });
          - pattern: |
              var $UPLOAD = $MULTER({ storage: $STORAGE, ... });
      # 3) Detectar ruta Express que usa upload.single / upload.array / upload.any
      - pattern-either:
          - pattern: |
              $APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES, ...$REST) => {
                ...
              });
          - pattern: |
              $APP.$METHOD($ROUTE, $UPLOAD.array($FIELD, ...), ($REQ, $RES, ...$REST) => {
                ...
              });
          - pattern: |
              $APP.$METHOD($ROUTE, $UPLOAD.any(), ($REQ, $RES, ...$REST) => {
                ...
              });
      # 4) Indicio adicional de confianza en mimetype controlado por el cliente
      - pattern-either:
          - pattern: |
              console.log(...$REQ.file.mimetype...);
          - pattern: |
              console.log(...$REQ.files[$IDX].mimetype...);
          - pattern: |
              $LOG(...$REQ.file.mimetype...);
          - pattern: |
              $LOG(...$REQ.files[$IDX].mimetype...);
    metadata:
      cwe: "CWE-434: Unrestricted Upload of File with Dangerous Type"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-55743"