const express = require('express');
const DOMPurify = require('isomorphic-dompurify');
const app = express();

// Función segura que "normaliza" el cuerpo del mensaje HTML
// eliminando scripts y atributos peligrosos
function message_body_safe(rawHtml) {
  // En lugar de desanitizar, se aplica una sanitización estricta
  // que elimina scripts, eventos on*, URLs javascript:, etc.
  return DOMPurify.sanitize(rawHtml, {
    ALLOWED_TAGS: [
      'a', 'b', 'strong', 'i', 'em', 'p', 'br', 'ul', 'ol', 'li',
      'span', 'div', 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'
    ],
    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'style']
  });
}

app.get('/mail/show', (req, res) => {
  const attackerControlledHtml = req.query.body || '<p>Hola</p>';

  // Se sanitiza el cuerpo del mensaje antes de mostrarlo
  const safeBody = message_body_safe(attackerControlledHtml);

  // SEGURO: el HTML mostrado ha sido sanitizado; no se ejecutan scripts
  res.send(`
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8" />
        <title>Mensaje</title>
      </head>
      <body>
        <h1>Contenido del mensaje</h1>
        <div id="message-body">
          ${safeBody}
        </div>
      </body>
    </html>
  `);
});

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
