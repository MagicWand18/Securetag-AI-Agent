const express = require('express');
const bodyParser = require('body-parser');

// Simulación de almacenamiento de preferencias por usuario
// userId -> { deceptiveAppScanning: boolean, role: 'primary' | 'secondary' }
const userSettings = new Map();

// Inicializamos un usuario primario y uno secundario en el mismo dispositivo
userSettings.set('primaryUser', {
  deceptiveAppScanning: true,
  role: 'primary'
});

userSettings.set('secondaryUser', {
  deceptiveAppScanning: false,
  role: 'secondary'
});

const app = express();
app.use(bodyParser.json());

/**
 * Vulnerabilidad inspirada en CVE-2025-26435:
 * Un usuario secundario puede desactivar la protección de "deceptiveAppScanning"
 * del usuario primario debido a un error de lógica en la actualización del estado.
 */

// Función que simula obtener el usuario "actual" desde un header
function getCurrentUserId(req) {
  // En un entorno real esto vendría de un token de sesión / JWT / etc.
  return req.headers['x-user-id'];
}

// Endpoint vulnerable: permite a cualquier usuario del dispositivo
// actualizar la preferencia global de escaneo de apps engañosas.
app.post('/settings/content-protection/toggle', (req, res) => {
  const currentUserId = getCurrentUserId(req);
  const currentUser = userSettings.get(currentUserId);

  if (!currentUser) {
    return res.status(401).json({ error: 'Usuario no autenticado' });
  }

  const { deceptiveAppScanning } = req.body;

  // --- LÓGICA VULNERABLE ---
  // Se asume erróneamente que si el usuario actual pertenece al mismo dispositivo,
  // puede modificar la configuración "global" (la del usuario primario).
  // No se valida que el usuario sea realmente el primario.

  const primaryUserId = 'primaryUser';
  const primaryUser = userSettings.get(primaryUserId);

  if (!primaryUser) {
    return res.status(500).json({ error: 'Usuario primario no encontrado' });
  }

  // Cualquier usuario (incluido el secundario) puede cambiar la preferencia
  primaryUser.deceptiveAppScanning = !!deceptiveAppScanning;

  return res.json({
    message: 'Preferencia de escaneo de apps engañosas actualizada (GLOBAL)',
    updatedBy: currentUserId,
    primaryUserSettings: primaryUser
  });
});

app.get('/settings/:userId', (req, res) => {
  const user = userSettings.get(req.params.userId);
  if (!user) {
    return res.status(404).json({ error: 'Usuario no encontrado' });
  }
  res.json(user);
});

if (require.main === module) {
  const port = 3000;
  app.listen(port, () => {
    console.log(`Servidor vulnerable escuchando en http://localhost:${port}`);
    console.log('Usuarios iniciales:', Object.fromEntries(userSettings));
  });
}

module.exports = app;