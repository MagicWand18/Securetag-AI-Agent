rules:
  - id: synthetic-cve202558745
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible explotación de CVE-2025-58745: carga de archivos Excel validando
      únicamente el MIME type declarado por el cliente (`file.mimetype`) en
      `multer.fileFilter`, sin validar extensión ni contenido real. Un atacante
      puede subir un archivo malicioso (por ejemplo, un webshell `.php`) con
      magic bytes y/o cabeceras manipuladas para que parezca un Excel y quede
      accesible o ejecutable en el servidor.
    metadata:
      cve: "CVE-2025-58745"
      source: "CISA_KEV"
      category: "file-upload"
      likelihood: "high"
      impact: "high"
      confidence: "medium"
    patterns:
      - pattern-inside: |
          const $MULTER = require('multer');
          ...
      - pattern-inside: |
          const $STORAGE = $MULTER.diskStorage({
            ...
          });
      - pattern-inside: |
          const $UPLOAD = $MULTER({
            storage: $STORAGE,
            fileFilter: ($REQ, $FILE, $CB) => {
              ...
            }
          });
      - pattern: |
          fileFilter: ($REQ, $FILE, $CB) => {
            const $ALLOWED = [...];
            if ($ALLOWED.includes($FILE.mimetype)) {
              return $CB(null, true);
            }
            return $CB(new Error(...));
          }
      - pattern-not: |
          fileFilter: ($REQ, $FILE, $CB) => {
            ...
            if ($ALLOWED.includes($FILE.mimetype) && $FILE.originalname.endsWith('.xlsx')) {
              return $CB(null, true);
            }
            ...
          }