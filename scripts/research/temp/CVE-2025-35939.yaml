rules:
  - id: synthetic-cve202535939
    languages: [javascript, typescript]
    message: >
      Posible explotación de CVE-2025-35939: un valor de configuración asumido como
      "inmutable" se sobreescribe con datos controlados externamente (por ejemplo,
      req.body.*) y luego se usa como ruta de archivo en una operación de escritura
      (fs.writeFile / fs.writeFileSync). Esto permite a un atacante redirigir la
      escritura a archivos arbitrarios (p.ej. PHP u otros ejecutables) y lograr
      ejecución de código o modificación persistente del sistema. Valida y restringe
      estrictamente las rutas configurables y evita que parámetros web reconfiguren
      valores críticos.
    severity: ERROR
    metadata:
      cve: "CVE-2025-35939"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express"]
    patterns:
      # 1) Detectar objeto de configuración "inmutable" (let/var) con propiedad de ruta
      - pattern: |
          let $CONF = {
            ...,
            $KEY: $VAL,
            ...
          };
      - metavariable-pattern:
          metavariable: $VAL
          pattern-either:
            - pattern: path.join(..., ...)
            - pattern: $EXPR
      # 2) Detectar actualización de esa propiedad desde datos externos (req.body / req.query / req.params)
      - pattern-either:
          - pattern: |
              if (typeof $REQ.body.$FIELD === 'string') {
                $CONF.$KEY = $REQ.body.$FIELD;
              }
          - pattern: |
              if (typeof $REQ.query.$FIELD === 'string') {
                $CONF.$KEY = $REQ.query.$FIELD;
              }
          - pattern: |
              if (typeof $REQ.params.$FIELD === 'string') {
                $CONF.$KEY = $REQ.params.$FIELD;
              }
          - pattern: |
              $CONF.$KEY = $REQ.body.$FIELD;
          - pattern: |
              $CONF.$KEY = $REQ.query.$FIELD;
          - pattern: |
              $CONF.$KEY = $REQ.params.$FIELD;
      # 3) Uso posterior de esa propiedad como ruta en una operación de escritura de archivo
      - pattern-either:
          - pattern: |
              const $TARGET = $CONF.$KEY;
              fs.writeFile($TARGET, $DATA, ...);
          - pattern: |
              let $TARGET = $CONF.$KEY;
              fs.writeFile($TARGET, $DATA, ...);
          - pattern: |
              var $TARGET = $CONF.$KEY;
              fs.writeFile($TARGET, $DATA, ...);
          - pattern: |
              fs.writeFile($CONF.$KEY, $DATA, ...);
          - pattern: |
              const $TARGET = $CONF.$KEY;
              fs.writeFileSync($TARGET, $DATA, ...);
          - pattern: |
              let $TARGET = $CONF.$KEY;
              fs.writeFileSync($TARGET, $DATA, ...);
          - pattern: |
              var $TARGET = $CONF.$KEY;
              fs.writeFileSync($TARGET, $DATA, ...);
          - pattern: |
              fs.writeFileSync($CONF.$KEY, $DATA, ...);
    fix: >
      No permitas que parámetros web (req.body, req.query, req.params) modifiquen
      directamente rutas de archivos de configuración. Usa rutas constantes o
      listas blancas predefinidas y valida estrictamente cualquier entrada antes
      de usarla en operaciones de escritura de archivos.