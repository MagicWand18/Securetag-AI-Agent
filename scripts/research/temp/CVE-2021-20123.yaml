rules:
  - id: synthetic-cve202120123
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible vulnerabilidad de Path Traversal similar a CVE-2021-20123: se usa
      directamente un parámetro controlado por el usuario para construir una ruta
      de archivo con `path.join` y luego se lee el archivo con `fs.readFile`
      (o APIs similares). Un atacante puede enviar valores como `../../etc/passwd`
      para acceder a archivos arbitrarios fuera del directorio previsto. Valida y
      normaliza el nombre de archivo (p. ej. restringiendo a una lista blanca,
      comprobando que la ruta resultante permanece dentro del directorio base, y
      rechazando secuencias `..`).
    metadata:
      cve: "CVE-2021-20123"
      source: "CISA_KEV"
      category: security
      technology: [nodejs, express]
      likelihood: HIGH
      impact: HIGH
      confidence: MEDIUM
    patterns:
      - pattern-either:
          # Patrón 1: flujo directo de req.query.* a path.join(BASE_DIR, userInput) y fs.readFile
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                $USER_INPUT = $REQ.query.$PARAM;
                ...
                $FILE_PATH = require('path').join($BASE_DIR, $USER_INPUT);
                ...
                require('fs').readFile($FILE_PATH, ...);
                ...
              })
          # Patrón 2: flujo directo de req.query.* a path.join(BASE_DIR, userInput) y fs.readFile con path importado
          - pattern: |
              const path = require('path');
              ...
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                $USER_INPUT = $REQ.query.$PARAM;
                ...
                $FILE_PATH = path.join($BASE_DIR, $USER_INPUT);
                ...
                require('fs').readFile($FILE_PATH, ...);
                ...
              })
          # Patrón 3: flujo directo de req.query.* a path.join(BASE_DIR, userInput) y fs.readFile con fs importado
          - pattern: |
              const fs = require('fs');
              ...
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                $USER_INPUT = $REQ.query.$PARAM;
                ...
                $FILE_PATH = require('path').join($BASE_DIR, $USER_INPUT);
                ...
                fs.readFile($FILE_PATH, ...);
                ...
              })
          # Patrón 4: flujo directo de req.query.* a path.join(BASE_DIR, userInput) y fs.readFile con path y fs importados
          - pattern: |
              const fs = require('fs');
              const path = require('path');
              ...
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                $USER_INPUT = $REQ.query.$PARAM;
                ...
                $FILE_PATH = path.join($BASE_DIR, $USER_INPUT);
                ...
                fs.readFile($FILE_PATH, ...);
                ...
              })
      # Excluir casos donde se hace una validación explícita de '..' en el input
      - pattern-not: |
          if ($USER_INPUT.includes('..')) {
            ...
          }
      - pattern-not: |
          if ($USER_INPUT.indexOf('..') !== -1) {
            ...
          }