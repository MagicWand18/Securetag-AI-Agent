rules:
  - id: synthetic-cve20256554
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Ejecución de código JavaScript controlado por el usuario mediante `vm.runInNewContext`
      con un sandbox laxo. Esto permite que un atacante envíe HTML/JS especialmente
      diseñado (por ejemplo, dentro de `<script>...</script>`) que se ejecuta directamente
      en el motor V8. En presencia de vulnerabilidades del motor (p.ej. type confusion),
      este patrón puede permitir escape de sandbox y lectura/escritura arbitraria de
      memoria, como en CVE-2025-6554. Valida, restringe o elimina la ejecución directa
      de código proporcionado por el usuario.
    metadata:
      cve: "CVE-2025-6554"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "vm"]
      cwe: ["CWE-94", "CWE-95"]
      references:
        - "https://nodejs.org/api/vm.html"
    patterns:
      - pattern-either:
          # Caso directo: vm.runInNewContext(userCode, sandbox, ...)
          - pattern: |
              vm.runInNewContext($USER_CODE, $SANDBOX, $OPTS)
          # Caso con alias: const v = require('vm'); v.runInNewContext(...)
          - pattern: |
              $VM.runInNewContext($USER_CODE, $SANDBOX, $OPTS)
      - pattern-inside: |
          const $VM = require('vm');
          ...
      - pattern-not: |
          vm.runInNewContext($USER_CODE, $SANDBOX, { ...secureContext })
      - metavariable-pattern:
          metavariable: $USER_CODE
          pattern: $REQ_BODY
      - pattern-inside: |
          $SERVER = require('http');
          ...
          $SERVER.createServer(($REQ, $RES) => {
            ...
          })
    fix: >
      Evita ejecutar código controlado por el usuario con `vm.runInNewContext`. En su
      lugar, usa un motor de plantillas seguro, una lista blanca de operaciones o un
      intérprete restringido. Si necesitas aislamiento, considera procesos separados
      con límites estrictos en lugar de `vm`.