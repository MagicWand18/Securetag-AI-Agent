const http = require('http');
const fs = require('fs');
const path = require('path');

// Servidor muy simple que expone un endpoint similar a CrashFileDownloadServlet
// Vulnerable a directory traversal usando ..\ o ../ en el parámetro fileName

const BASE_DIR = path.join(__dirname, 'logs'); // Directorio "esperado" de logs

const server = http.createServer((req, res) => {
  if (!req.url.startsWith('/CrashFileDownloadServlet')) {
    res.statusCode = 404;
    return res.end('Not found');
  }

  const url = new URL(req.url, 'http://localhost');
  const fileName = url.searchParams.get('fileName');

  if (!fileName) {
    res.statusCode = 400;
    return res.end('Missing fileName');
  }

  // VULNERABILIDAD: se concatena directamente el parámetro fileName
  // Un atacante puede usar ..\ o ../ para escapar de BASE_DIR y leer archivos arbitrarios
  const filePath = path.join(BASE_DIR, fileName); // No se valida que permanezca dentro de BASE_DIR

  fs.readFile(filePath, (err, data) => {
    if (err) {
      res.statusCode = 404;
      return res.end('File not found');
    }

    res.statusCode = 200;
    res.setHeader('Content-Type', 'application/octet-stream');
    res.end(data);
  });
});

server.listen(3000, () => {
  console.log('Vulnerable server listening on http://localhost:3000');
});
