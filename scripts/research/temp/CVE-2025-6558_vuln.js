const express = require('express');
const { exec } = require('child_process');
const path = require('path');

// Ejemplo simplificado de un servidor que genera HTML dinámico
// y permite que el cliente controle parámetros que terminan
// afectando a la capa de "renderizado" (simulando un flujo tipo Chromium/ANGLE)

const app = express();
app.use(express.json());

// Ruta vulnerable: no valida correctamente la entrada usada
// para construir HTML y para invocar un proceso externo
app.post('/render', (req, res) => {
  const { shaderSource, gpuFlag } = req.body; // controlado por el atacante

  // 1) Inyección directa en HTML sin validación/escape
  //    (simula un flujo donde HTML malformado podría llegar a una
  //     capa de renderizado tipo GPU/ANGLE sin validación)
  const html = `
    <html>
      <body>
        <canvas id="glCanvas"></canvas>
        <script>
          // El atacante controla shaderSource y puede inyectar
          // contenido arbitrario en el contexto de la página
          const shaderSource = ${JSON.stringify(shaderSource)};
          const canvas = document.getElementById('glCanvas');
          const gl = canvas.getContext('webgl');
          const shader = gl.createShader(gl.FRAGMENT_SHADER);
          gl.shaderSource(shader, shaderSource);
          gl.compileShader(shader);
        </script>
      </body>
    </html>
  `;

  // 2) Uso inseguro de exec con parámetros no validados
  //    (simula un "puente" entre entrada de renderizado y capa nativa)
  //    Un atacante podría pasar algo como: "--enable-gpu --foo; rm -rf /".
  const cmd = `node fake-gpu-worker.js ${gpuFlag}`; // gpuFlag sin sanitizar

  exec(cmd, (error, stdout, stderr) => {
    if (error) {
      console.error('Error en GPU worker:', error);
      // Aun así devolvemos el HTML generado con datos no validados
      return res.status(500).send(html);
    }

    // Se devuelve HTML que contiene directamente la entrada del usuario
    res.setHeader('Content-Type', 'text/html');
    res.send(html);
  });
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
