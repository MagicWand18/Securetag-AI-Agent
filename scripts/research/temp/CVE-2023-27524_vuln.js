const express = require('express');
const session = require('express-session');

// Ejemplo simplificado de una app tipo panel de administración
// VULNERABLE: uso de SECRET_KEY por defecto, estático y conocido públicamente
// Similar al problema de Apache Superset: instalaciones que no cambian la clave por defecto

const app = express();

// Clave secreta HARDCODEADA y reutilizada en todas las instalaciones
// Un atacante que conozca este valor puede falsificar sesiones y acceder como usuario legítimo
const DEFAULT_SECRET_KEY = 'this_is_a_default_insecure_secret_key_change_me';

app.use(session({
  secret: DEFAULT_SECRET_KEY, // <-- Vulnerabilidad: clave por defecto, conocida y no cambiada
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: false // para simplificar el ejemplo
  }
}));

// Middleware de autenticación muy básico
function requireAuth(req, res, next) {
  if (req.session && req.session.user) {
    return next();
  }
  res.status(401).send('No autenticado');
}

// Login de demostración (sin validación real de credenciales)
app.post('/login', (req, res) => {
  // En un caso real se validarían credenciales
  req.session.user = { username: 'admin', role: 'admin' };
  res.send('Sesión creada para admin');
});

// Recurso protegido
app.get('/admin', requireAuth, (req, res) => {
  res.send(`Panel de administración. Usuario: ${req.session.user.username}`);
});

app.listen(3000, () => {
  console.log('App vulnerable escuchando en http://localhost:3000');
  console.log('ATENCIÓN: usando SECRET_KEY por defecto, estático y conocido.');
});
