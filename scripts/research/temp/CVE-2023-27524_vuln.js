const express = require('express');
const session = require('express-session');

// Ejemplo vulnerable inspirado en CVE-2023-27524:
// Uso de SECRET_KEY por defecto, estático y conocido públicamente.
// Si el atacante conoce esta clave, puede forjar cookies de sesión válidas
// y autenticarse como otros usuarios.

const app = express();

// Clave secreta por defecto (hardcodeada y conocida)
const DEFAULT_SECRET_KEY = 'THIS_IS_THE_DEFAULT_SECRET_KEY_CHANGE_ME';

app.use(session({
  secret: DEFAULT_SECRET_KEY, // VULNERABLE: clave por defecto, fija y conocida
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: false // para simplificar el ejemplo (no usar en producción)
  }
}));

// Simula un login muy simple
app.post('/login', (req, res) => {
  // En un caso real se validarían credenciales
  req.session.user = {
    id: 1,
    username: 'admin',
    role: 'admin'
  };
  res.send('Sesión creada para admin');
});

// Ruta protegida que requiere sesión válida
app.get('/admin', (req, res) => {
  if (!req.session.user || req.session.user.role !== 'admin') {
    return res.status(401).send('No autorizado');
  }
  res.send(`Panel admin para: ${req.session.user.username}`);
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
  console.log('ATENCIÓN: Usando SECRET_KEY por defecto y conocido.');
});
