rules:
  - id: synthetic-cve202555745
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible CSV/Formula Injection (CVE-2025-55745): se están escribiendo
      datos controlados por el usuario directamente en un archivo CSV que luego
      es servido como descarga HTTP. Aplicaciones como Excel pueden interpretar
      celdas que comienzan con "=", "+", "-", "@" u otros prefijos peligrosos
      como fórmulas, permitiendo la ejecución de funciones como HYPERLINK,
      WEBSERVICE, etc. Esto puede llevar a robo de datos, ejecución de comandos
      locales o exfiltración cuando el usuario abre el CSV. Sanitiza o
      escapa los valores antes de escribirlos al CSV (por ejemplo, anteponiendo
      un apóstrofo o filtrando prefijos peligrosos).
    metadata:
      cwe: "CWE-1236: Improper Neutralization of Formula Elements in a CSV File"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "MEDIUM"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-55745"
    patterns:
      # 1) Estamos dentro de un handler HTTP (Express u otro router similar)
      - pattern-inside: |
          $APP.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          })
      # 2) Se construye un string CSV acumulando filas en una variable
      - pattern-inside: |
          let $CSV = $HEADERS;
          ...
          $CSV += $ROW;
          ...
      # 3) La variable CSV se escribe a disco con fs.writeFile / writeFileSync
      - pattern-inside: |
          const $FS = require('fs');
          ...
          $FS.writeFile($FILEPATH, $CSV, ...);
      # 4) El archivo CSV se sirve como descarga HTTP
      - pattern-inside: |
          const $PATH = require('path');
          ...
          const $FILEPATH = $PATH.join(...);
          ...
          $FS.createReadStream($FILEPATH).pipe($RES);
      # 5) La fila CSV se construye con interpolación de variables potencialmente no sanitizadas
      - pattern: |
          $CSV += `${...$PARTS}`;
      # 6) Excluir casos donde se aplique una sanitización explícita básica para fórmulas
      - pattern-not: |
          $CSV += `${...$PARTS}.replace(/^[=+\-@]/, "'")`;