const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Configuración "inmutable" asumida (pero controlada externamente)
// En un entorno real esto podría venir de un archivo .json, .env o incluso de una petición previa
let assumedImmutableConfig = {
  uploadDir: path.join(__dirname, 'uploads'),
  templateFile: path.join(__dirname, 'cache', 'compiled-template.php')
};

// Ruta insegura: permite que un parámetro web "reconfigure" un valor asumido como inmutable
app.post('/config/update', (req, res) => {
  // Vulnerabilidad: control externo de un parámetro que se asume inmutable
  // El cliente puede cambiar la ruta de un archivo local conocido
  if (typeof req.body.templateFile === 'string') {
    assumedImmutableConfig.templateFile = req.body.templateFile; // <-- control externo
  }

  res.json({ status: 'ok', config: assumedImmutableConfig });
});

// Ruta que escribe contenido en el archivo "inmutable" (pero ya controlado por el atacante)
app.post('/render', (req, res) => {
  const { content } = req.body;

  // Se asume que templateFile es seguro y no se valida
  const targetFile = assumedImmutableConfig.templateFile;

  // Vulnerabilidad: el atacante puede hacer que esto apunte a un archivo PHP u otro archivo ejecutable
  // y escribir contenido arbitrario (por ejemplo, código PHP) en una ubicación conocida del servidor.
  fs.writeFile(targetFile, content || '', (err) => {
    if (err) {
      console.error('Error writing file:', err);
      return res.status(500).send('Error');
    }
    res.send('Template updated');
  });
});

app.listen(3000, () => {
  console.log('Vulnerable app listening on port 3000');
});
