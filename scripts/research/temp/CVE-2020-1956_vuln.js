const express = require('express');
const { exec } = require('child_process');

const app = express();
app.use(express.json());

// Endpoint "similar" a una API de administración que construye comandos dinámicos
// VULNERABLE: inyección de comandos del SO (similar a CVE-2020-1956 en espíritu)
app.post('/kylin/query', (req, res) => {
  const { project, sql } = req.body;

  // Validaciones superficiales (insuficientes)
  if (!project || !sql) {
    return res.status(400).json({ error: 'Missing project or sql' });
  }

  // Construcción insegura de un comando de shell con datos controlados por el usuario
  // Un atacante podría inyectar: "; rm -rf /" u otros comandos
  const cmd = `kylin.sh query --project "${project}" --sql "${sql}"`;

  exec(cmd, (error, stdout, stderr) => {
    if (error) {
      console.error('Command execution error:', error);
      return res.status(500).json({ error: 'Internal error' });
    }

    if (stderr) {
      console.error('Command stderr:', stderr);
    }

    // Devolvemos la salida del comando directamente
    res.json({ output: stdout });
  });
});

app.listen(3000, () => {
  console.log('Vulnerable Kylin-like API listening on port 3000');
});
