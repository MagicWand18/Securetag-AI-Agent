const express = require('express');
const mysql = require('mysql2');

// Ejemplo simplificado de endpoint similar a un login / recuperación de credenciales
// Vulnerabilidad tipo CVE-2024-6670: SQL Injection que permite extraer contraseñas

const app = express();
app.use(express.json());

// Conexión a base de datos (ejemplo)
const db = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'monitoring_app'
});

// Endpoint vulnerable: no requiere autenticación y concatena directamente el input en la query
app.get('/api/user-info', (req, res) => {
  const username = req.query.username || '';

  // VULNERABLE: concatenación directa de parámetros de usuario en la consulta SQL
  // Un atacante puede usar algo como:
  //   ?username=' OR '1'='1' UNION SELECT id, encrypted_password FROM users --
  // para extraer contraseñas cifradas si la app está configurada con un solo usuario
  const sql = `SELECT id, username, encrypted_password FROM users WHERE username = '${username}'`;

  db.query(sql, (err, results) => {
    if (err) {
      console.error('DB error:', err);
      return res.status(500).json({ error: 'Internal server error' });
    }

    // En este ejemplo, si solo hay un usuario, el atacante puede recuperar su contraseña cifrada
    if (results.length === 0) {
      return res.status(404).json({ error: 'User not found' });
    }

    // También es mala práctica devolver encrypted_password directamente, pero se deja
    // para ilustrar el impacto de la inyección.
    res.json({
      id: results[0].id,
      username: results[0].username,
      encrypted_password: results[0].encrypted_password
    });
  });
});

app.listen(3000, () => {
  console.log('Vulnerable server listening on port 3000');
});
