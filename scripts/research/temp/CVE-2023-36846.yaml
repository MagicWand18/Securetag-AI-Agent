rules:
  - id: synthetic-cve202336846
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible subida arbitraria de ficheros sin autenticación ni validación usando
      express-fileupload. CVE-2023-36846 describe escenarios donde un endpoint
      accesible sin control de acceso permite a un atacante subir ficheros
      controlados (nombre, tipo y contenido) a directorios dentro de la
      aplicación (p.ej. `public/uploads`), lo que facilita ejecución de código,
      plantillas maliciosas o sobrescritura de recursos. Asegura autenticación,
      validación estricta de tipo/extensión, saneo de nombre de fichero y
      restricciones de ruta antes de llamar a `mv()` o métodos equivalentes.
    metadata:
      cve: "CVE-2023-36846"
      source: "CISA_KEV"
      category: "file-upload"
      likelihood: "high"
      references:
        - "https://www.cisa.gov/known-exploited-vulnerabilities-catalog"
    patterns:
      - pattern-either:
          # 1) Uso de express-fileupload sin autenticación ni validación previa
          - pattern: |
              const express = require('express');
              const fileUpload = require('express-fileupload');
              ...
              const app = express();
              app.use(fileUpload(...));
              ...
              app.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                if (!$REQ.files || !$REQ.files.$FILE) {
                  ...
                }
                const $UPLOADED = $REQ.files.$FILE;
                ...
                $UPLOADED.mv($TARGET, ...);
                ...
              });
          # 2) Variante async/await o funciones async
          - pattern: |
              const express = require('express');
              const fileUpload = require('express-fileupload');
              ...
              const app = express();
              app.use(fileUpload(...));
              ...
              app.$METHOD($ROUTE, async ($REQ, $RES) => {
                ...
                if (!$REQ.files || !$REQ.files.$FILE) {
                  ...
                }
                const $UPLOADED = $REQ.files.$FILE;
                ...
                $UPLOADED.mv($TARGET, ...);
                ...
              });
      # Restringimos a rutas típicamente públicas y sin middleware de auth
      - metavariable-pattern:
          metavariable: $METHOD
          pattern-either:
            - pattern: "post"
            - pattern: "all"
      - metavariable-pattern:
          metavariable: $ROUTE
          pattern-either:
            - pattern: "'/user.php'"
            - pattern: "'/upload'"
            - pattern: "'/upload.php'"
            - pattern: "'/file'"
            - pattern: "'/files'"
    pattern-not:
      # Excluir casos donde se vea explícitamente una comprobación de autenticación básica
      - pattern: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            if ($REQ.user || $REQ.isAuthenticated && $REQ.isAuthenticated()) {
              ...
            }
            ...
          })
      - pattern: |
          app.$METHOD($ROUTE, ($REQ, $RES, $NEXT) => {
            if ($REQ.user || $REQ.isAuthenticated && $REQ.isAuthenticated()) {
              ...
            }
            ...
          })