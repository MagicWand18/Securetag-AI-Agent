const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));

// Función de saneo muy básica para evitar inyección de código PHP
function sanitizeForPhpString(value) {
  if (typeof value !== 'string') return '';
  // Escapar comillas simples y barras invertidas
  let sanitized = value.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
  // Opcional: eliminar etiquetas PHP para evitar "<?php" dentro de los valores
  sanitized = sanitized.replace(/<\?(php|=)?/gi, '').replace(/\?>/g, '');
  return sanitized;
}

app.post('/setup', (req, res) => {
  const configPath = path.join(__dirname, 'config.php');

  // Validar y sanear entradas
  const siteNameRaw = req.body.siteName || 'Mi Sitio';
  const dbHostRaw = req.body.dbHost || 'localhost';
  const dbUserRaw = req.body.dbUser || 'root';
  const dbPassRaw = req.body.dbPass || '';

  const siteName = sanitizeForPhpString(siteNameRaw);
  const dbHost = sanitizeForPhpString(dbHostRaw);
  const dbUser = sanitizeForPhpString(dbUserRaw);
  const dbPass = sanitizeForPhpString(dbPassRaw);

  // Alternativa más segura: guardar la configuración en JSON/YAML y que PHP la lea
  // en lugar de generar código PHP ejecutable. Aquí se muestra la versión PHP
  // pero con valores saneados para ilustrar la corrección.
  const phpConfig = `<?php
  $config = array();
  $config['site_name'] = '${siteName}';
  $config['db_host'] = '${dbHost}';
  $config['db_user'] = '${dbUser}';
  $config['db_pass'] = '${dbPass}';
?>`;

  fs.writeFile(configPath, phpConfig, { encoding: 'utf8', mode: 0o600 }, (err) => {
    if (err) {
      console.error('Error al escribir config.php:', err);
      return res.status(500).send('Error al generar configuración');
    }
    res.send('Archivo de configuración generado de forma segura');
  });
});

app.listen(3000, () => {
  console.log('Servidor de setup seguro escuchando en http://localhost:3000');
});
}