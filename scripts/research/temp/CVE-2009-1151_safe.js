const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));

// Función de escape para valores que se insertan en código PHP
function phpStringEscape(value) {
  if (typeof value !== 'string') return '';
  // Escapa comillas simples y barras invertidas para evitar romper la cadena PHP
  return value
    .replace(/\\/g, '\\\\')   // \\ -> \\\\
    .replace(/'/g, "\\'");     // '  -> \\'
}

// Validación básica de campos esperados (whitelisting / restricciones)
function sanitizeInput(value, maxLen = 100) {
  if (typeof value !== 'string') return '';
  value = value.trim();
  if (value.length > maxLen) {
    value = value.slice(0, maxLen);
  }
  // Ejemplo: solo permitimos caracteres alfanuméricos, guiones, puntos y espacios
  return value.replace(/[^a-zA-Z0-9_.\- ]/g, '');
}

app.post('/setup', (req, res) => {
  const configPath = path.join(__dirname, 'config.php');

  // Sanitizar y validar entradas
  const siteNameRaw = req.body.siteName || 'Mi Sitio';
  const dbHostRaw  = req.body.dbHost  || 'localhost';
  const dbUserRaw  = req.body.dbUser  || 'root';
  const dbPassRaw  = req.body.dbPass  || '';

  const siteName = phpStringEscape(sanitizeInput(siteNameRaw, 80));
  const dbHost   = phpStringEscape(sanitizeInput(dbHostRaw, 80));
  const dbUser   = phpStringEscape(sanitizeInput(dbUserRaw, 80));
  const dbPass   = phpStringEscape(sanitizeInput(dbPassRaw, 80));

  // En lugar de permitir que el usuario inyecte código PHP arbitrario,
  // solo insertamos valores como literales de cadena correctamente escapados.
  const phpConfig = `<?php
  $config = array(
    'site_name' => '${siteName}',
    'db_host'   => '${dbHost}',
    'db_user'   => '${dbUser}',
    'db_pass'   => '${dbPass}'
  );
?>`;

  fs.writeFile(configPath, phpConfig, { encoding: 'utf8', flag: 'w' }, (err) => {
    if (err) {
      console.error('Error al escribir config.php:', err);
      return res.status(500).send('Error al generar configuración');
    }

    res.send('Archivo de configuración generado de forma segura.');
  });
});

app.listen(3000, () => {
  console.log('Servidor de setup seguro escuchando en http://localhost:3000');
});
}