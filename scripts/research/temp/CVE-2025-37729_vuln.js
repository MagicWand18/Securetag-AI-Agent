const express = require('express');
const bodyParser = require('body-parser');
const { Jinjava } = require('jinjava-js'); // Supongamos un binding JS de Jinjava

// Configuración básica de Express
const app = express();
app.use(bodyParser.json());

// Instancia global del motor de plantillas Jinjava
const jinjava = new Jinjava();

// Contexto con información sensible y funciones peligrosas
const templateContext = {
  // Datos sensibles que no deberían ser accesibles desde plantillas controladas por el usuario
  internalConfig: {
    elasticApiKey: process.env.ELASTIC_API_KEY,
    adminToken: process.env.ADMIN_TOKEN,
    clusterUrl: process.env.CLUSTER_URL || 'https://ece.internal.local'
  },
  // Función que ejecuta comandos en el entorno de Elastic/ECE
  ece: {
    runAdminCommand: async (cmd) => {
      // Ejemplo simplificado de ejecución de comando administrativo
      console.log('[ECE] Ejecutando comando administrativo:', cmd);
      // Aquí podría llamarse a la API interna de ECE con privilegios de admin
      return { status: 'ok', executed: cmd };
    }
  }
};

// Ruta vulnerable: permite que un usuario admin envíe una "plantilla" arbitraria
// que será evaluada por Jinjava con acceso al contexto completo.
app.post('/admin/render-template', async (req, res) => {
  try {
    const { template } = req.body;

    // VALIDACIÓN INSUFICIENTE: solo se comprueba que el usuario sea admin a nivel de app,
    // pero no se restringe qué variables/funciones de Jinjava puede usar.
    const isAdmin = req.headers['x-admin'] === 'true';
    if (!isAdmin) {
      return res.status(403).json({ error: 'Forbidden' });
    }

    if (typeof template !== 'string' || template.length > 5000) {
      return res.status(400).json({ error: 'Invalid template' });
    }

    // VULNERABILIDAD (similar a CVE-2025-37729):
    // Se evalúa directamente una cadena de plantilla controlada por el usuario
    // con acceso a variables sensibles y funciones que pueden emitir comandos.
    const rendered = await jinjava.render(template, templateContext);

    res.json({ rendered });
  } catch (err) {
    console.error('Error rendering template:', err);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Ejemplo de payload malicioso que un atacante con acceso admin podría enviar:
// {
//   "template": "API Key: {{ internalConfig.elasticApiKey }}\n" +
//               "Admin Token: {{ internalConfig.adminToken }}\n" +
//               "{% set r = ece.runAdminCommand('DELETE /clusters/secret-cluster') %}{{ r }}"
// }
// Esto permitiría exfiltrar secretos y ejecutar comandos administrativos.

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server listening on port ${PORT}`);
});
