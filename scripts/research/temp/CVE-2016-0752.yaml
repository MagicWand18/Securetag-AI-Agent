rules:
  - id: synthetic-cve20160752
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible vulnerabilidad de directory traversal similar a CVE-2016-0752:
      se construye una ruta de archivo a partir de datos controlados por el
      usuario (por ejemplo, parámetros de URL) y se pasa directamente a
      funciones de lectura de archivos sin validación ni normalización
      adecuada. Un atacante puede usar secuencias como "../" para acceder a
      archivos arbitrarios fuera del directorio previsto, lo que facilita la
      explotación remota (alta probabilidad de explotación según contexto de
      amenaza).
    metadata:
      cve: "CVE-2016-0752"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express", "http"]
      likelihood_of_exploit: "high"
    patterns:
      - pattern-either:
          # Patrón 1: lectura directa con fs.readFile
          - pattern: |
              $FS.readFile($PATH, ...);
          # Patrón 2: lectura síncrona
          - pattern: |
              $FS.readFileSync($PATH, ...);
      - pattern-inside: |
          const http = require('http');
          ...
      - pattern-inside: |
          const $FS = require('fs');
          ...
      - pattern-inside: |
          const $PATHMOD = require('path');
          ...
      - pattern-inside: |
          const $TEMPLATES_DIR = $PATHMOD.join(__dirname, ...);
          ...
      - pattern-inside: |
          const server = http.createServer(($REQ, $RES) => {
            ...
          });
      - pattern-inside: |
          const $URLOBJ = new URL($REQ.url, `http://${$REQ.headers.host}`);
          ...
      - pattern-inside: |
          const $TEMPLATE_NAME = $URLOBJ.searchParams.get($PARAM) || ...;
          ...
      - pattern-inside: |
          const $TEMPLATE_PATH = $PATHMOD.join($TEMPLATES_DIR, $TEMPLATE_NAME + $SUFFIX);
          ...
      - pattern: |
          $FS.readFile($TEMPLATE_PATH, ...);
    fix: >
      Valida y normaliza el parámetro de plantilla antes de construir la ruta.
      Por ejemplo, restringe a una lista blanca de nombres permitidos o verifica
      que la ruta resultante permanezca dentro de TEMPLATES_DIR usando
      path.resolve y comprobando que el prefijo coincida con el directorio
      esperado.