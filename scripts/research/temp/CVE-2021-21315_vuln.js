const express = require('express');
const bodyParser = require('body-parser');
const path = require('path');

const app = express();
app.use(bodyParser.json());

// Simulación de un "plugin loader" vulnerable similar al patrón de CVE-2021-21315
// El parámetro "name" se usa directamente para construir una ruta de require dinámica
// permitiendo que un atacante cargue módulos arbitrarios del sistema

app.post('/run-plugin', (req, res) => {
  const { name, options } = req.body || {};

  // VULNERABILIDAD: uso directo de input del usuario en require
  // Un atacante puede enviar, por ejemplo, "name": "child_process" y luego usarlo
  // para ejecutar comandos del sistema, o rutas relativas para cargar código arbitrario.
  try {
    const pluginPath = name; // sin validación ni lista blanca
    const plugin = require(pluginPath); // require dinámico controlado por el usuario

    // Supongamos que el plugin exporta una función "run" que recibe options
    if (typeof plugin.run !== 'function') {
      return res.status(400).json({ error: 'Plugin inválido' });
    }

    // El plugin puede ejecutar código arbitrario en el servidor
    const result = plugin.run(options || {});
    res.json({ ok: true, result });
  } catch (err) {
    console.error('Error al cargar/ejecutar plugin:', err);
    res.status(500).json({ error: 'Error interno' });
  }
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
