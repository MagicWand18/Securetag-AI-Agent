const express = require('express');
const bodyParser = require('body-parser');
const crypto = require('crypto');

// Versión segura: la API "experimental" ahora requiere autenticación basada en token
// y se deshabilita por defecto si no se configura explícitamente.

const app = express();
app.use(bodyParser.json());

// Base de datos en memoria de "tareas" (DAGs / jobs)
const tasks = {
  "daily_report": { enabled: true, lastRun: null },
  "sync_users": { enabled: true, lastRun: null }
};

// Configuración de seguridad
// La API experimental está DESACTIVADA por defecto y requiere un token de acceso.
const ENABLE_EXPERIMENTAL_API = process.env.ENABLE_EXPERIMENTAL_API === 'true';
const API_TOKEN = process.env.EXPERIMENTAL_API_TOKEN || crypto.randomBytes(16).toString('hex');

// Middleware de control de acceso a la API experimental
function requireExperimentalApiEnabled(req, res, next) {
  if (!ENABLE_EXPERIMENTAL_API) {
    return res.status(403).json({ error: 'Experimental API is disabled' });
  }
  next();
}

// Middleware de autenticación simple por token (p.ej. en cabecera Authorization: Bearer <token>)
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({ error: 'Missing or invalid Authorization header' });
  }

  const token = authHeader.substring('Bearer '.length).trim();
  if (token !== API_TOKEN) {
    return res.status(403).json({ error: 'Invalid API token' });
  }

  next();
}

// Aplicamos ambos middlewares a la API experimental
const experimentalRouter = express.Router();
experimentalRouter.use(requireExperimentalApiEnabled);
experimentalRouter.use(authenticateToken);

// Listar tareas (protegido)
experimentalRouter.get('/tasks', (req, res) => {
  res.json({ tasks });
});

// Disparar una tarea por nombre (protegido)
experimentalRouter.post('/tasks/:taskId/trigger', (req, res) => {
  const { taskId } = req.params;
  const task = tasks[taskId];

  if (!task) {
    return res.status(404).json({ error: 'Task not found' });
  }

  if (!task.enabled) {
    return res.status(400).json({ error: 'Task is disabled' });
  }

  task.lastRun = new Date().toISOString();
  console.log(`[SECURE EXPERIMENTAL API] Task triggered: ${taskId}`);
  res.json({ message: `Task '${taskId}' triggered`, task });
});

// Modificar configuración de una tarea (protegido)
experimentalRouter.put('/tasks/:taskId/config', (req, res) => {
  const { taskId } = req.params;
  const task = tasks[taskId];

  if (!task) {
    return res.status(404).json({ error: 'Task not found' });
  }

  const { enabled } = req.body;
  if (typeof enabled === 'boolean') {
    task.enabled = enabled;
  }

  console.log(`[SECURE EXPERIMENTAL API] Task config updated: ${taskId}, enabled=${task.enabled}`);
  res.json({ message: `Task '${taskId}' updated`, task });
});

// Montamos el router bajo el prefijo /api/experimental
app.use('/api/experimental', experimentalRouter);

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Secure orchestration API listening on port ${PORT}`);
  console.log(`Experimental API enabled: ${ENABLE_EXPERIMENTAL_API}`);
  if (ENABLE_EXPERIMENTAL_API) {
    console.log(`Use token (EXPERIMENTAL_API_TOKEN): ${API_TOKEN}`);
  }
});
