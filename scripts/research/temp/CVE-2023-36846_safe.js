const express = require('express');
const fileUpload = require('express-fileupload');
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');

const app = express();
app.use(fileUpload());

// Middleware de autenticación sencillo (ejemplo)
function requireAuth(req, res, next) {
  // En un entorno real, validarías un token, cookie de sesión, etc.
  const apiKey = req.header('X-API-Key');
  if (!apiKey || apiKey !== process.env.UPLOAD_API_KEY) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
}

// Lista blanca de extensiones permitidas
const ALLOWED_EXTENSIONS = new Set(['.jpg', '.jpeg', '.png', '.gif', '.pdf']);

// Directorio de subida aislado, no servido directamente por el servidor web
const uploadDir = path.join(__dirname, 'data', 'user_uploads');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true, mode: 0o700 });
}

app.post('/user.php', requireAuth, async (req, res) => {
  if (!req.files || !req.files.file) {
    return res.status(400).json({ error: 'No file uploaded' });
  }

  const uploadedFile = req.files.file;

  // Validar tamaño máximo (ej. 5 MB)
  const MAX_SIZE = 5 * 1024 * 1024;
  if (uploadedFile.size > MAX_SIZE) {
    return res.status(413).json({ error: 'File too large' });
  }

  // Validar extensión
  const originalExt = path.extname(uploadedFile.name).toLowerCase();
  if (!ALLOWED_EXTENSIONS.has(originalExt)) {
    return res.status(400).json({ error: 'Invalid file type' });
  }

  // Generar nombre de fichero seguro, no controlado por el usuario
  const safeName = crypto.randomBytes(16).toString('hex') + originalExt;

  // Construir ruta de forma segura, sin permitir path traversal
  const targetPath = path.join(uploadDir, safeName);

  // Comprobación adicional: asegurar que la ruta final sigue dentro de uploadDir
  const normalized = path.normalize(targetPath);
  if (!normalized.startsWith(uploadDir + path.sep)) {
    return res.status(400).json({ error: 'Invalid path' });
  }

  uploadedFile.mv(targetPath, (err) => {
    if (err) {
      console.error('Error saving file:', err);
      return res.status(500).json({ error: 'Internal server error' });
    }

    // Devolver solo metadatos seguros
    res.status(201).json({
      message: 'File uploaded successfully',
      fileId: safeName
    });
  });
});

app.listen(3000, () => {
  console.log('Secure app listening on port 3000');
});
