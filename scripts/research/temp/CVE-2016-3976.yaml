rules:
  - id: synthetic-cve20163976
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible vulnerabilidad de traversal de directorios al construir rutas de archivos
      con entrada de usuario sin validación (similar a CVE-2016-3976). Un atacante puede
      usar secuencias como "../" o "..\\" en parámetros (por ejemplo, "fileName") para
      escapar del directorio base y leer archivos arbitrarios del sistema. Dado el alto
      contexto de explotación (probabilidad ~81.5%), valida y normaliza el nombre de
      archivo, restringe a un directorio permitido y bloquea patrones de traversal.
    metadata:
      cve: "CVE-2016-3976"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express", "http"]
      likelihood_of_exploit: "high"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2016-3976"
      description: >
        Detecta patrones donde se construyen rutas de archivos con datos de entrada
        del usuario (por ejemplo, parámetros de consulta HTTP) usando path.join o
        concatenación directa, sin validación, lo que puede permitir directory traversal
        similar a CVE-2016-3976.
    patterns:
      - pattern-either:
          # Caso 1: path.join(BASE_DIR, user_input)
          - pattern: |
              $HTTP.createServer(($REQ, $RES) => {
                ...
                const $PARSED = $URL.parse($REQ.$PROP, true);
                ...
                const $FILENAME = $PARSED.$QPROP.$PARAM;
                ...
                const $FILEPATH = $PATH.join($BASEDIR, $FILENAME);
                ...
                $FS.readFile($FILEPATH, ...);
                ...
              });
          # Caso 2: path.join(BASE_DIR, user_input) en cualquier contexto
          - pattern: |
              const $FILENAME = $EXPR.$QPROP.$PARAM;
              ...
              const $FILEPATH = $PATH.join($BASEDIR, $FILENAME);
              ...
              $FS.readFile($FILEPATH, ...);
          # Caso 3: uso directo de query param en path.join + fs.readFile
          - pattern: |
              const $FILEPATH = $PATH.join($BASEDIR, $REQ.$PROP.$QPROP.$PARAM);
              ...
              $FS.readFile($FILEPATH, ...);
    pattern-sources:
      - pattern: $URL.parse($REQ.$PROP, true).$QPROP.$PARAM
      - pattern: $REQ.$PROP.$QPROP.$PARAM
    pattern-sinks:
      - pattern: $FS.readFile($PATH.join($BASEDIR, $FILENAME), ...)
    options:
      symbolic_propagation: true