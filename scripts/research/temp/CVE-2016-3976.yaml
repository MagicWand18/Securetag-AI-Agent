rules:
  - id: synthetic-cve20163976
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible vulnerabilidad de directory traversal similar a CVE-2016-3976:
      se concatena directamente un parámetro controlado por el usuario a una
      ruta base (por ejemplo, BASE_DIR) y se usa en operaciones de lectura de
      archivos (fs.readFile / fs.readFileSync / fs.createReadStream) sin
      validar que la ruta resultante permanezca dentro del directorio esperado.
      Un atacante puede usar secuencias como "../" o "..\" para escapar del
      directorio y leer archivos arbitrarios. Valida y normaliza la ruta antes
      de usarla o restringe explícitamente el acceso a un directorio seguro.
    patterns:
      - pattern-inside: |
          const $FS = require('fs');
          ...
      - pattern-inside: |
          $FS.$READFUNC($FILEPATH, ...);
      - pattern-either:
          - pattern: |
              $FILEPATH = require('path').join($BASEDIR, $USERINPUT);
          - pattern: |
              $FILEPATH = $PATHMOD.join($BASEDIR, $USERINPUT);
      - pattern-not: |
          $FILEPATH = $PATHMOD.join($BASEDIR, $USERINPUT);
          if (!$FILEPATH.startsWith($BASEDIR)) {
            ...
          }
      - pattern-not: |
          $FILEPATH = $PATHMOD.join($BASEDIR, $USERINPUT);
          if (!$FILEPATH.includes('..')) {
            ...
          }
    metadata:
      cwe: "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2016-3976"