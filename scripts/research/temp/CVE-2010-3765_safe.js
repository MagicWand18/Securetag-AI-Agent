// Versión segura: en lugar de abrir automáticamente contenido HTML/JS
// arbitrario en un navegador (que podría ser vulnerable a CVE-2010-3765 u
// otros fallos del motor), el servidor almacena el contenido de forma
// controlada y sólo lo sirve como texto, sin ejecución automática ni
// lanzamiento de un navegador.

const http = require('http');
const fs = require('fs');
const path = require('path');

const STORAGE_DIR = path.join(__dirname, 'stored_content');
if (!fs.existsSync(STORAGE_DIR)) {
  fs.mkdirSync(STORAGE_DIR);
}

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/store-content') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      // Se almacena el contenido recibido como texto plano, sin ejecutarlo
      // ni abrirlo automáticamente en ningún navegador.
      const id = Date.now().toString();
      const filePath = path.join(STORAGE_DIR, `${id}.txt`);

      // Sanitización básica: limitar tamaño y tipo
      if (body.length > 100000) {
        res.writeHead(413, { 'Content-Type': 'text/plain' });
        return res.end('Contenido demasiado grande');
      }

      fs.writeFile(filePath, body, 'utf8', (err) => {
        if (err) {
          console.error('Error al guardar contenido:', err);
          res.writeHead(500, { 'Content-Type': 'text/plain' });
          return res.end('Error interno');
        }

        // Se devuelve un identificador para que el usuario pueda recuperar
        // el contenido de forma segura (p. ej. para inspección manual).
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ id }));
      });
    });
  } else if (req.method === 'GET' && req.url.startsWith('/content/')) {
    // Recuperar contenido almacenado y servirlo como texto plano
    const id = req.url.replace('/content/', '').replace(/[^0-9]/g, '');
    const filePath = path.join(STORAGE_DIR, `${id}.txt`);

    fs.readFile(filePath, 'utf8', (err, data) => {
      if (err) {
        res.writeHead(404, { 'Content-Type': 'text/plain' });
        return res.end('No encontrado');
      }

      // Importante: se sirve como text/plain para evitar ejecución en el
      // navegador del cliente. No se lanza ningún navegador desde el servidor.
      res.writeHead(200, { 'Content-Type': 'text/plain; charset=utf-8' });
      res.end(data);
    });
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('Not found');
  }
});

server.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
