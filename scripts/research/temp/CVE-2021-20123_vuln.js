const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();

// Simula un endpoint tipo "DownloadFileServlet" vulnerable a Path Traversal
// Ejemplo de ataque: GET /DownloadFileServlet?file=../../../../etc/passwd
app.get('/DownloadFileServlet', (req, res) => {
  const fileParam = req.query.file; // entrada controlada por el usuario
  if (!fileParam) return res.status(400).send('Missing file parameter');

  // VULNERABLE: concatena directamente la ruta base con el parÃ¡metro del usuario
  // permitiendo secuencias ../ para escapar del directorio previsto.
  const baseDir = '/var/vigorconnect/downloads';
  const targetPath = path.join(baseDir, fileParam);

  // VULNERABLE: no valida que targetPath permanezca dentro de baseDir
  fs.readFile(targetPath, (err, data) => {
    if (err) return res.status(404).send('File not found');
    res.setHeader('Content-Type', 'application/octet-stream');
    res.send(data);
  });
});

app.listen(3000, () => console.log('Listening on http://localhost:3000'));
