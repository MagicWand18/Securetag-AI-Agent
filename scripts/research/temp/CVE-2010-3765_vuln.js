// NOTA IMPORTANTE:
// CVE-2010-3765 es una vulnerabilidad específica del motor de renderizado de Mozilla
// (Firefox/SeaMonkey/Thunderbird) relacionada con nsCSSFrameConstructor y manejo
// interno de frames. No es reproducible directamente en Node.js, ya que Node no
// incluye ese motor ni su API interna.
//
// El siguiente ejemplo ilustra un patrón de riesgo relacionado: permitir que un
// atacante controle directamente código JavaScript que se ejecuta en un motor
// de navegador (por ejemplo, lanzando Firefox con JavaScript arbitrario). Esto
// puede hacer explotable cualquier vulnerabilidad del motor (incluida
// CVE-2010-3765) si el navegador es vulnerable.

const http = require('http');
const { exec } = require('child_process');

// Servidor HTTP inseguro que permite a un cliente remoto enviar código JS
// para ser abierto automáticamente en un navegador vulnerable (p. ej. Firefox
// antiguo) sin validación ni sanitización.

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/open-in-browser') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      // body se espera que sea código HTML/JS controlado por el cliente
      // Se guarda en un archivo temporal y se abre con Firefox sin ningún
      // tipo de validación. Si el Firefox es vulnerable a CVE-2010-3765,
      // el atacante puede intentar explotar el bug del motor.

      const fs = require('fs');
      const path = require('path');

      const tmpFile = path.join(__dirname, 'tmp_exploit.html');

      // VULNERABILIDAD LÓGICA: aceptar contenido HTML/JS arbitrario y
      // abrirlo automáticamente en un navegador potencialmente vulnerable.
      fs.writeFileSync(tmpFile, body, 'utf8');

      // Uso inseguro de exec con ruta fija a un navegador antiguo
      // (ejemplo simplificado). Si el navegador tiene CVE-2010-3765,
      // el atacante puede explotar la corrupción de memoria.
      exec(`firefox "${tmpFile}"`, (error) => {
        if (error) {
          console.error('Error al abrir Firefox:', error);
        }
      });

      res.writeHead(200, { 'Content-Type': 'text/plain' });
      res.end('Contenido recibido y abierto en el navegador.');
    });
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('Not found');
  }
});

server.listen(3000, () => {
  console.log('Servidor inseguro escuchando en http://localhost:3000');
});
