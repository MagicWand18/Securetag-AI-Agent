const express = require('express');
const bodyParser = require('body-parser');
const ldap = require('ldapjs');

// Versión SEGURA del ejemplo anterior: se valida y escapa el filtro LDAP
// para evitar LDAP Injection.

const app = express();
app.use(bodyParser.json());

const client = ldap.createClient({
  url: 'ldap://localhost:389'
});

function fakeAuth(req, res, next) {
  req.user = { id: '123', role: 'user' };
  next();
}

// Función de escape básica para filtros LDAP (RFC 4515)
// Escapa caracteres especiales: * ( ) \ NUL
function escapeLdapFilter(value) {
  if (typeof value !== 'string') return '';
  return value
    .replace(/\\/g, '\\5c')
    .replace(/\*/g, '\\2a')
    .replace(/\(/g, '\\28')
    .replace(/\)/g, '\\29')
    .replace(/\0/g, '\\00');
}

// Validar que el filtro solo contenga un subconjunto seguro de caracteres
// (por ejemplo, para un valor de atributo simple). En un caso real, se
// debería usar una librería o un builder de filtros LDAP.
function validateSimpleFilter(filter) {
  // Permitir solo letras, números, guion, guion bajo y punto.
  return /^[A-Za-z0-9_.-]*$/.test(filter);
}

app.post('/api/ldap/command', fakeAuth, (req, res) => {
  const { commandName, username } = req.body;

  if (!commandName || typeof commandName !== 'string') {
    return res.status(400).json({ error: 'commandName requerido' });
  }

  if (!username || typeof username !== 'string') {
    return res.status(400).json({ error: 'username requerido' });
  }

  // En lugar de aceptar un filtro arbitrario, aceptamos solo un parámetro
  // de negocio (por ejemplo, username) y construimos el filtro de forma segura.
  if (!validateSimpleFilter(username)) {
    return res.status(400).json({ error: 'username contiene caracteres no permitidos' });
  }

  const baseDN = 'ou=users,dc=example,dc=com';

  // Escapar el valor antes de interpolarlo en el filtro LDAP
  const safeUsername = escapeLdapFilter(username);
  const ldapFilter = `(&(objectClass=person)(uid=${safeUsername}))`;

  const opts = {
    filter: ldapFilter,
    scope: 'sub',
    attributes: ['cn', 'uid', 'mail']
  };

  client.search(baseDN, opts, (err, searchRes) => {
    if (err) {
      console.error('Error en búsqueda LDAP:', err);
      return res.status(500).json({ error: 'Error en búsqueda LDAP' });
    }

    const entries = [];

    searchRes.on('searchEntry', (entry) => {
      entries.push(entry.object);
    });

    searchRes.on('error', (err) => {
      console.error('Error en stream LDAP:', err);
      res.status(500).json({ error: 'Error en stream LDAP' });
    });

    searchRes.on('end', () => {
      res.json({
        command: commandName,
        filterUsed: ldapFilter,
        results: entries
      });
    });
  });
});

app.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001');
});
