rules:
  - id: synthetic-cve20259990
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible Local File Inclusion / Path Traversal (CVE-2025-9990): se construye una ruta de archivo
      a partir de datos de la petición HTTP sin validación adecuada y se pasa directamente a una
      operación de lectura/inclusión de archivos. Un atacante puede usar valores como
      `../../../../etc/passwd` para leer archivos arbitrarios del sistema o, en entornos de
      inclusión de plantillas, ejecutar código remoto. Valida y restringe el parámetro a un
      conjunto de rutas/plantillas permitidas antes de usarlo.
    metadata:
      cve: "CVE-2025-9990"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express", "http"]
      vulnerability: ["lfi", "path-traversal"]
    patterns:
      - pattern-either:
          # Caso 1: Node http.createServer con req.url / url.parse
          - pattern: |
              const http = require('http');
              ...
              http.createServer((REQ, RES) => {
                ...
                const $PARSED = url.parse(REQ.url, true);
                ...
                const $USER = $PARSED.query[$KEY] || ...;
                ...
                const $BASEDIR = path.join(...);
                ...
                const $TARGET = path.join($BASEDIR, $USER);
                ...
                fs.readFile($TARGET, ...);
                ...
              });
          # Caso 2: uso genérico de path.join(baseDir, userInput) seguido de fs.readFile
          - pattern: |
              const $USER = ...;
              ...
              const $BASEDIR = path.join(...);
              ...
              const $TARGET = path.join($BASEDIR, $USER);
              ...
              fs.readFile($TARGET, ...);
      # Evitar falsos positivos obvios cuando el segundo argumento es claramente constante
      - pattern-not: |
          const $USER = "...";
          ...
          const $BASEDIR = path.join(...);
          ...
          const $TARGET = path.join($BASEDIR, $USER);
          ...
          fs.readFile($TARGET, ...);
    fix: >
      No construyas rutas de archivo directamente desde parámetros de la petición. En su lugar,
      valida el valor contra una lista blanca de nombres permitidos y resuelve la ruta final
      comparándola con un directorio base conocido, rechazando cualquier intento de traversal
      (../) u otras rutas absolutas.