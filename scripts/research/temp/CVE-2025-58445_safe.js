const express = require('express');
const app = express();

// Metadatos internos (no se exponen públicamente)
const internalBuildInfo = {
  name: 'my-terraform-webhook-service',
  version: '1.3.7',              // se mantiene interno
  commit: 'a1b2c3d4e5f6',
  buildDate: '2025-11-30T10:15:00Z',
  goVersion: 'go1.23.1',
  os: process.platform,
  arch: process.arch,
  dependencies: {
    express: '4.21.0',
    axios: '1.7.0',
    'terraform-lib': '0.9.3'
  }
};

// Función auxiliar para exponer solo información genérica
function getPublicStatus() {
  return {
    status: 'ok',
    // Información mínima necesaria para monitoreo externo
    uptimeSeconds: Math.floor(process.uptime()),
    // Versión genérica/no precisa para evitar fingerprinting exacto
    serviceVersion: '1.x',
    // No se exponen versiones de runtime, dependencias ni commit hashes
    environment: process.env.NODE_ENV === 'production' ? 'prod' : 'non-prod'
  };
}

// ENDPOINT SEGURO: no expone detalles de versión ni dependencias
app.get('/status', (req, res) => {
  res.json(getPublicStatus());
});

// Ejemplo de endpoint interno protegido para diagnóstico (opcional)
// Solo accesible con un token de administración
app.get('/internal/status', (req, res) => {
  const adminToken = process.env.ADMIN_STATUS_TOKEN;
  const authHeader = req.headers['authorization'] || '';

  if (!adminToken || authHeader !== `Bearer ${adminToken}`) {
    return res.status(403).json({ error: 'forbidden' });
  }

  // Aquí sí se puede exponer información detallada, pero solo a administradores
  res.json({
    status: 'ok',
    uptimeSeconds: Math.floor(process.uptime()),
    buildInfo: internalBuildInfo
  });
});

// Resto de la app (simulación de webhook de PR de Terraform)
app.post('/webhook', express.json(), (req, res) => {
  // lógica de procesamiento de PR de Terraform...
  res.status(202).json({ received: true });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Service listening on port ${PORT}`);
});
