rules:
  - id: synthetic-cve20255419
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible explotación relacionada con CVE-2025-5419: se está ejecutando código
      JavaScript derivado de HTML controlado por el usuario mediante `eval`. Este
      patrón (extraer scripts inline de un DOM construido a partir de entrada
      externa y luego evaluarlos) permite que un atacante suministre HTML/JS
      especialmente diseñado que, en motores vulnerables, puede desencadenar
      corrupción de memoria (por ejemplo, OOB read/write). Evita usar `eval` sobre
      datos derivados de HTML no confiable; utiliza un motor de plantillas seguro
      o un sandbox apropiado.
    metadata:
      cve: "CVE-2025-5419"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "jsdom"]
      likelihood: "HIGH"
      impact: "CRITICAL"
      references:
        - "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-5419"
    patterns:
      - pattern-either:
          # Caso directo: eval(inlineJs) donde inlineJs proviene de una función que procesa HTML
          - pattern: |
              function $EXTRACT_HTML_SCRIPTS($HTML) {
                ...
                $INLINE_JS = ...
                ...
                return $INLINE_JS;
              }

              ...

              $USER_HTML = $REQ_BODY;
              $INLINE_JS_2 = $EXTRACT_HTML_SCRIPTS($USER_HTML);
              eval($INLINE_JS_2);
          # Caso genérico: eval($X) donde $X proviene de una función que usa JSDOM y querySelectorAll('script')
          - pattern: |
              $CODE = $EXTRACT($HTML);
              eval($CODE);
          - pattern: |
              eval($EXTRACT($HTML));
      - pattern-inside: |
          const { JSDOM } = require('jsdom');
          ...
      - pattern-inside: |
          function $EXTRACT($HTML) {
            ...
            const $DOM = new JSDOM($HTML);
            ...
            $SCRIPTS = $DOM.window.document.querySelectorAll('script');
            ...
          }
      - pattern-not: |
          eval("...")