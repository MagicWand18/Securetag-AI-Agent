rules:
  - id: synthetic-cve20091151
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible vulnerabilidad similar a CVE-2009-1151: se está generando un archivo
      PHP de configuración que incluye directamente datos controlados por el usuario
      (por ejemplo, desde req.body) dentro de código PHP. Si un atacante puede
      inyectar comillas o código PHP en estos valores, el archivo resultante será
      interpretado por el intérprete PHP, permitiendo ejecución remota de código.
      Valida y escapa estrictamente cualquier dato antes de escribirlo en archivos
      PHP que luego serán incluidos o ejecutados por el servidor.
    patterns:
      - pattern-inside: |
          fs.writeFile($CONFIG_PATH, $CONTENT, ...)
      - pattern: |
          `<?php
          $... = $...(
            $... => '${...}',
            ...
          );
          ?>`
      - pattern-inside: |
          const $CONTENT = `<?php
          $... = $...(
            $... => '${...}',
            ...
          );
          ?>`;
      - pattern-either:
          - pattern: |
              const $REQ = require('express');
              ...
              $APP.$METHOD(..., (req, res, ...) => {
                ...
                $VAR = req.body.$FIELD || $DEFAULT;
                ...
              });
          - pattern: |
              $APP.$METHOD(..., (req, res, ...) => {
                ...
                $VAR = req.body.$FIELD || $DEFAULT;
                ...
              });
    metadata:
      cwe: "CWE-94: Improper Control of Generation of Code ('Code Injection')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2009-1151"