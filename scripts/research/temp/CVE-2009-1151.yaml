rules:
  - id: synthetic-cve20091151
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible generación de archivo PHP con contenido controlado por el usuario
      (similar a CVE-2009-1151). Datos provenientes de la petición HTTP se
      interpolan directamente en una plantilla PHP que luego se escribe a disco.
      Si el archivo es servido por el intérprete PHP, un atacante puede inyectar
      código PHP arbitrario (por ejemplo, usando valores como `"; phpinfo(); //`)
      y lograr ejecución remota de código. Valida, escapa o evita generar código
      ejecutable a partir de entrada de usuario.
    metadata:
      cve: "CVE-2009-1151"
      source: "CISA_KEV"
      category: "code-injection"
      technology: ["nodejs", "express", "php"]
    patterns:
      # 1) Identificar un handler HTTP típico de Express que recibe req/res
      - pattern-either:
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, function ($REQ, $RES) {
                ...
              })
      # 2) Dentro del handler, construir una cadena que empiece con "<?php"
      #    y contenga interpolación de variables (template literal)
      - pattern: |
          const $CONF = `<?php
          ... $INTERP ...
          `;
      # 3) Asegurar que la variable interpolada proviene de la petición (req.body / req.query / req.params)
      - pattern-either:
          - pattern: |
              const $INTERP = $REQ.body.$FIELD || ...;
          - pattern: |
              const $INTERP = $REQ.query.$FIELD || ...;
          - pattern: |
              const $INTERP = $REQ.params.$FIELD || ...;
      # 4) El contenido PHP generado se escribe a disco
      - pattern-either:
          - pattern: fs.writeFile($PATH, $CONF, ...);
          - pattern: fs.writeFileSync($PATH, $CONF, ...);
      # 5) El archivo destino aparenta ser un script PHP
      - pattern: |
          $PATH = path.join(..., "config.php");
    fix: >
      No generes archivos PHP a partir de entrada de usuario. Si necesitas
      configuración dinámica, almacénala en formatos de datos (JSON, YAML, env)
      y no en código ejecutable. Si no puedes evitarlo, aplica una lista blanca
      estricta y escapa/valida exhaustivamente todos los valores antes de
      escribirlos.