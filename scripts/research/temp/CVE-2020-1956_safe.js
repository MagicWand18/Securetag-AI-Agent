const express = require('express');
const { spawn } = require('child_process');

const app = express();
app.use(express.json());

// Lista blanca de proyectos permitidos (ejemplo)
const ALLOWED_PROJECTS = new Set(['sales', 'marketing', 'finance']);

// Función de validación básica de SQL (ejemplo simplificado)
function isValidSql(sql) {
  if (typeof sql !== 'string') return false;
  if (sql.length === 0 || sql.length > 2000) return false;
  // Ejemplo: no permitir múltiples sentencias separadas por ';'
  if (sql.includes(';')) return false;
  return true;
}

// Endpoint seguro: evita inyección de comandos del SO
app.post('/kylin/query', (req, res) => {
  const { project, sql } = req.body;

  if (!project || !sql) {
    return res.status(400).json({ error: 'Missing project or sql' });
  }

  // Validar proyecto contra lista blanca
  if (!ALLOWED_PROJECTS.has(project)) {
    return res.status(400).json({ error: 'Invalid project' });
  }

  // Validar SQL (ejemplo simplificado; en producción usar un parser/validador real)
  if (!isValidSql(sql)) {
    return res.status(400).json({ error: 'Invalid SQL' });
  }

  // Uso de spawn con argumentos separados en lugar de concatenar un comando de shell
  // No se invoca un intérprete de shell, por lo que no se interpretan metacaracteres
  const args = ['query', '--project', project, '--sql', sql];
  const child = spawn('kylin.sh', args, { shell: false });

  let stdoutData = '';
  let stderrData = '';

  child.stdout.on('data', (data) => {
    stdoutData += data.toString();
  });

  child.stderr.on('data', (data) => {
    stderrData += data.toString();
  });

  child.on('error', (err) => {
    console.error('Failed to start process:', err);
    res.status(500).json({ error: 'Internal error' });
  });

  child.on('close', (code) => {
    if (code !== 0) {
      console.error('kylin.sh exited with code', code, 'stderr:', stderrData);
      return res.status(500).json({ error: 'Query failed' });
    }

    // Devolver salida procesada; opcionalmente parsear JSON/CSV en lugar de texto crudo
    res.json({ output: stdoutData });
  });
});

app.listen(3000, () => {
  console.log('Safe Kylin-like API listening on port 3000');
});
