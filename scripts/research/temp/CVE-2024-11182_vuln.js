const http = require('http');
const url = require('url');

// Simula un visor web de correos que muestra el cuerpo HTML tal cual llega
// Vulnerabilidad: XSS al renderizar contenido HTML de correo sin sanitizar

const emails = {
  "1": {
    subject: "Bienvenido",
    // Un atacante puede enviar un correo con <script> malicioso
    htmlBody: '<h1>Hola</h1><p>Gracias por registrarte</p>'
  }
};

http.createServer((req, res) => {
  const parsed = url.parse(req.url, true);

  if (parsed.pathname === '/email') {
    const id = parsed.query.id || '1';
    const email = emails[id];

    if (!email) {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      return res.end('Email no encontrado');
    }

    // VULNERABLE: se inyecta el cuerpo HTML del correo directamente en la página
    // sin ningún tipo de sanitización o filtrado.
    // Un correo con `<script>alert("XSS")</script>` se ejecutará en el navegador.
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>Visor de correo</title>
        </head>
        <body>
          <h2>Asunto: ${email.subject}</h2>
          <hr />
          <div id="email-body">
            ${email.htmlBody} <!-- XSS: contenido HTML de correo sin sanitizar -->
          </div>
        </body>
      </html>
    `);
  } else {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('Use /email?id=1 para ver un correo');
  }
}).listen(3000, () => {
  console.log('Servidor de ejemplo escuchando en http://localhost:3000');
});
