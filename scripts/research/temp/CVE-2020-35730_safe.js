const express = require('express');
const app = express();
const he = require('he'); // npm install he

// Versión segura: valida esquemas de URL y escapa contenido antes de insertarlo en HTML.

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Permitir solo esquemas seguros (http/https/mailto, etc.)
function isSafeUrl(url) {
  try {
    const u = new URL(url, 'http://example.com');
    const allowedProtocols = ['http:', 'https:', 'mailto:'];
    return allowedProtocols.includes(u.protocol);
  } catch (e) {
    return false;
  }
}

app.post('/render-email', (req, res) => {
  const plainTextBody = req.body.body || '';

  // Primero escapamos todo el cuerpo para neutralizar cualquier HTML existente
  let safeBody = he.encode(plainTextBody, { useNamedReferences: true });

  // Luego, de forma controlada, detectamos URLs y las convertimos en enlaces
  safeBody = safeBody.replace(/(https?:\/\/\S+)/g, (match) => {
    // match está escapado porque viene de safeBody, así que necesitamos
    // la versión "raw" para validar el esquema, pero nunca la insertamos sin escapar.
    const rawUrl = match;

    if (!isSafeUrl(rawUrl)) {
      // Si no es una URL segura, la dejamos como texto plano escapado
      return he.encode(rawUrl, { useNamedReferences: true });
    }

    const href = he.encode(rawUrl, { useNamedReferences: true });
    const text = he.encode(rawUrl, { useNamedReferences: true });
    return `<a href="${href}">${text}</a>`;
  });

  // Manejo seguro de pseudo-etiquetas [linkref:...] con validación y escape
  safeBody = safeBody.replace(/\[linkref:([^\]]+?)\]/g, (m, rawUrl) => {
    // rawUrl viene de texto plano, lo validamos y escapamos
    if (!isSafeUrl(rawUrl)) {
      // Si no es seguro, lo mostramos como texto literal
      return he.encode(`[linkref:${rawUrl}]`, { useNamedReferences: true });
    }

    const href = he.encode(rawUrl, { useNamedReferences: true });
    const text = he.encode(rawUrl, { useNamedReferences: true });
    return `<a href="${href}">${text}</a>`;
  });

  // Envolvemos el contenido ya escapado/sanitizado en una plantilla HTML
  res.send(`<!DOCTYPE html>
<html>
  <head><title>Vista de correo (segura)</title></head>
  <body>
    <h1>Mensaje</h1>
    <div>${safeBody}</div>
  </body>
</html>`);
});

app.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001');
});
