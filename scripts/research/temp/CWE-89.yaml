rules:
  - id: synthetic-cwe89
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible SQL Injection (CWE-89): se está construyendo dinámicamente una consulta SQL
      concatenando valores potencialmente controlados por el usuario en la cadena de la query.
      Esto permite que un atacante altere la consulta SQL enviada a la base de datos. Usa
      consultas parametrizadas/preparadas (placeholders) en lugar de concatenar valores.
    metadata:
      cwe: "CWE-89"
      category: security
      technology:
        - mysql
        - mysql2
        - node
        - express
    patterns:
      - pattern-either:
          # Asignación de query vulnerable
          - pattern: |
              $CONN = require('mysql2');
              ...
              $CONNECTION.$QUERY_METHOD($QUERY, ...);
          - pattern: |
              $CONN = require('mysql');
              ...
              $CONNECTION.$QUERY_METHOD($QUERY, ...);
      - pattern-inside: |
          const express = require('express');
          ...
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          });
      - pattern: |
          const $QUERY = $SQL + $EXPR;
    fix: >
      Usa consultas parametrizadas, por ejemplo:
      const query = "SELECT * FROM users WHERE id = ?";
      connection.query(query, [userId], ...);