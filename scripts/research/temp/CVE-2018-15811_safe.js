const express = require('express');
const crypto = require('crypto');

// VersiÃ³n segura: uso de algoritmo fuerte (AES-256-GCM), claves aleatorias y manejo correcto de IV/tag

const app = express();
app.use(express.json());

// En un entorno real, la clave debe venir de variables de entorno seguras o un KMS
const STRONG_KEY = crypto.randomBytes(32); // 256 bits

function strongEncryptParam(plainText) {
  const iv = crypto.randomBytes(12); // 96 bits recomendado para GCM
  const cipher = crypto.createCipheriv('aes-256-gcm', STRONG_KEY, iv);

  let encrypted = cipher.update(plainText, 'utf8', 'base64');
  encrypted += cipher.final('base64');
  const authTag = cipher.getAuthTag();

  // Empaquetamos iv + tag + ciphertext en un solo token
  const payload = Buffer.concat([
    iv,
    authTag,
    Buffer.from(encrypted, 'base64')
  ]).toString('base64');

  return payload;
}

function strongDecryptParam(token) {
  const data = Buffer.from(token, 'base64');

  const iv = data.subarray(0, 12); // 12 bytes
  const authTag = data.subarray(12, 28); // 16 bytes
  const cipherText = data.subarray(28);

  const decipher = crypto.createDecipheriv('aes-256-gcm', STRONG_KEY, iv);
  decipher.setAuthTag(authTag);

  let decrypted = decipher.update(cipherText, undefined, 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}

app.get('/profile', (req, res) => {
  const { token } = req.query;

  if (!token) {
    return res.status(400).send('Missing token');
  }

  try {
    const userId = strongDecryptParam(token);

    res.json({
      userId,
      message: 'Perfil de usuario recuperado con cifrado fuerte (SEGURO)'
    });
  } catch (e) {
    return res.status(400).send('Invalid token');
  }
});

app.post('/generate-token', (req, res) => {
  const { userId } = req.body;
  if (!userId) {
    return res.status(400).send('Missing userId');
  }

  const token = strongEncryptParam(String(userId));
  res.json({ token });
});

app.listen(3001, () => {
  console.log('Secure app listening on port 3001');
});
