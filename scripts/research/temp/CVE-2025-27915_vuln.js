const express = require('express');
const fs = require('fs');
const path = require('path');

// Ejemplo simplificado de "visor" de invitaciones ICS en una app web
// Vulnerable a XSS similar a CVE-2025-27915: inserta HTML del ICS sin sanitizar

const app = express();
const PORT = 3000;

// Middleware para parsear body simple (no es relevante para la vulnerabilidad)
app.use(express.urlencoded({ extended: true }));

// Ruta que "muestra" el contenido de un archivo ICS subido previamente
app.get('/view-ics', (req, res) => {
  const icsFile = req.query.file || 'invite.ics';
  const icsPath = path.join(__dirname, 'uploads', icsFile);

  if (!fs.existsSync(icsPath)) {
    return res.status(404).send('ICS file not found');
  }

  const icsContent = fs.readFileSync(icsPath, 'utf8');

  // --- PARTE VULNERABLE ---
  // Supongamos que el ICS puede contener una descripción en HTML
  // y que el servidor "confía" en ese contenido y lo inserta directamente
  // en la página. Un atacante puede incluir algo como:
  // <div ontoggle="alert('XSS')"></div>
  // o cualquier otro atributo/evento JS.

  // Extrae una pseudo-descripción del ICS (muy simplificado)
  const descriptionMatch = icsContent.match(/DESCRIPTION:(.*)/);
  const descriptionHtml = descriptionMatch ? descriptionMatch[1] : 'No description';

  // Renderizado directo sin sanitización -> XSS
  const html = `
    <!DOCTYPE html>
    <html lang="es">
    <head>
      <meta charset="UTF-8" />
      <title>Invitación ICS</title>
    </head>
    <body>
      <h1>Detalle de la invitación</h1>
      <div id="description">
        ${descriptionHtml}
      </div>
      <p>Si ves contenido extraño aquí, podría ser malicioso.</p>
    </body>
    </html>
  `;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
});

app.listen(PORT, () => {
  console.log(`Servidor vulnerable escuchando en http://localhost:${PORT}`);
});
