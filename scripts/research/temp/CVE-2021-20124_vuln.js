const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();

// Simula un endpoint tipo "WebServlet" de descarga de archivos.
// Vulnerable: permite path traversal usando ../ para leer archivos arbitrarios.
app.get('/WebServlet', (req, res) => {
  const action = req.query.action;
  if (action !== 'download') return res.status(400).send('Invalid action');

  // Ej: /WebServlet?action=download&file=../../../../etc/passwd
  const fileParam = req.query.file;
  if (!fileParam) return res.status(400).send('Missing file');

  // Directorio base "esperado" (pero NO se valida correctamente)
  const baseDir = path.join(__dirname, 'downloads');

  // ❌ Vulnerabilidad: join/normalize sin verificación permite escapar de baseDir
  const requestedPath = path.join(baseDir, fileParam);

  fs.readFile(requestedPath, (err, data) => {
    if (err) return res.status(404).send('Not found');
    res.setHeader('Content-Type', 'application/octet-stream');
    res.send(data);
  });
});

app.listen(3000, () => console.log('Listening on http://localhost:3000'));
