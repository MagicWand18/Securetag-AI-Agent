rules:
  - id: synthetic-cve202411680
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible endpoint de configuración crítica sin autenticación ni control de acceso
      (CVE-2024-11680). Este handler HTTP permite modificar opciones globales de la
      aplicación (por ejemplo, permitir registros, cambiar directorios de subida,
      correos de administración, etc.) directamente desde el cuerpo de la petición
      (`req.body`) y las persiste en disco. Un atacante remoto puede enviar una
      petición POST a este endpoint para alterar la configuración de seguridad
      (p.ej. activar registros, cambiar `uploadDir` a una ruta servida como estática
      y subir código malicioso), lo que facilita la toma de control de la aplicación
      y la ejecución de código arbitrario. Asegura que este endpoint requiera
      autenticación fuerte, autorización por rol y validación estricta de los campos
      permitidos antes de aplicar cambios de configuración.
    metadata:
      cve: "CVE-2024-11680"
      source: "CISA_KEV"
      category: security
      technology:
        - express
        - nodejs
      likelihood: HIGH
      impact: HIGH
      cwe:
        - "CWE-284: Improper Access Control"
        - "CWE-269: Improper Privilege Management"
      references:
        - "https://www.cisa.gov/known-exploited-vulnerabilities-catalog"
    patterns:
      - pattern-either:
          # Patrón 1: handler POST que toma req.body y lo mezcla directamente en un objeto de configuración
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $NEWCONF = $REQ.body;
                ...
                Object.assign($CONF, $NEWCONF);
                ...
              });
          # Patrón 2: variante donde se usa req.body directamente en Object.assign
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                Object.assign($CONF, $REQ.body);
                ...
              });
      - metavariable-pattern:
          metavariable: $METHOD
          pattern-either:
            - pattern: post
            - pattern: put
            - pattern: patch
      - metavariable-pattern:
          metavariable: $ROUTE
          pattern-regex: "(?i)options|config|settings|setup|admin"
      - pattern-not: |
          $APP.$METHOD($ROUTE, ($REQ, $RES, $NEXT) => {
            ...
            if ($AUTHCHECK) {
              ...
              const $NEWCONF = $REQ.body;
              ...
              Object.assign($CONF, $NEWCONF);
              ...
            }
            ...
          });
      - pattern-not: |
          $APP.$METHOD($ROUTE, ($REQ, $RES, $NEXT) => {
            ...
            if ($REQ.isAuthenticated() || $REQ.user || $REQ.session || $REQ.headers['authorization']) {
              ...
              const $NEWCONF = $REQ.body;
              ...
              Object.assign($CONF, $NEWCONF);
              ...
            }
            ...
          });