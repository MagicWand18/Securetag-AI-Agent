const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// Directorio base de vistas
const VIEWS_DIR = path.join(__dirname, 'views');

// Lista blanca de plantillas permitidas (mapeo lógico -> archivo físico)
const ALLOWED_TEMPLATES = {
  'text/html': 'index.html',
  'application/json': 'index.json',
  'text/plain': 'index.txt'
};

// Versión segura: NO usa directamente el valor de Accept como ruta de archivo
app.get('/page', (req, res) => {
  const acceptHeader = (req.headers['accept'] || '').split(',')[0].trim();

  // Selecciona la plantilla a partir de una lista blanca
  const templateName = ALLOWED_TEMPLATES[acceptHeader] || ALLOWED_TEMPLATES['text/html'];

  const filePath = path.join(VIEWS_DIR, templateName);

  // Verificación adicional: el archivo debe permanecer dentro de VIEWS_DIR
  const normalizedPath = path.normalize(filePath);
  if (!normalizedPath.startsWith(VIEWS_DIR + path.sep)) {
    return res.status(400).send('Invalid template path');
  }

  fs.readFile(normalizedPath, 'utf8', (err, data) => {
    if (err) {
      return res.status(404).send('Template not found');
    }

    // Establece el Content-Type de forma controlada
    const contentType = acceptHeader in ALLOWED_TEMPLATES ? acceptHeader : 'text/html';
    res.setHeader('Content-Type', `${contentType}; charset=utf-8`);
    res.send(data);
  });
});

app.listen(PORT, () => {
  console.log(`Secure server listening on port ${PORT}`);
});
