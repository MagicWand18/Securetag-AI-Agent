const express = require('express');
const { execFile } = require('child_process');

// Versión corregida: aplica control de autorización estricto y validación de entrada.

const app = express();
app.use(express.json());

const GPU_MICRONODES = {
  "render": "gpu_micronode_render",
  "encode": "gpu_micronode_encode",
  "decode": "gpu_micronode_decode"
};

const USERS = {
  "alice": { role: "admin", allowedMicronodes: ["render", "encode", "decode"] },
  "bob": { role: "user", allowedMicronodes: ["render"] }
};

// Lista blanca de comandos de secuencia permitidos
const ALLOWED_SEQUENCE_CMDS = [
  'INIT',
  'DRAW',
  'FLUSH',
  'ENCODE_FRAME',
  'DECODE_FRAME',
  'SHUTDOWN'
];

function isValidSequence(sequence) {
  if (!Array.isArray(sequence) || sequence.length === 0) return false;
  return sequence.every(cmd => typeof cmd === 'string' && ALLOWED_SEQUENCE_CMDS.includes(cmd));
}

app.post('/gpu/command', (req, res) => {
  const { username, micronode, sequence } = req.body;

  // Autenticación
  const user = USERS[username];
  if (!user) {
    return res.status(401).json({ error: 'Unknown user' });
  }

  // Autorización por micronode
  if (!user.allowedMicronodes.includes(micronode)) {
    return res.status(403).json({ error: 'User not allowed to access this micronode' });
  }

  // Validar micronode contra lista blanca
  const micronodeBin = GPU_MICRONODES[micronode];
  if (!micronodeBin) {
    return res.status(400).json({ error: 'Invalid micronode' });
  }

  // Validar secuencia de comandos
  if (!isValidSequence(sequence)) {
    return res.status(400).json({ error: 'Invalid or unsupported command sequence' });
  }

  // En lugar de concatenar, usar execFile con argumentos separados
  const args = [
    '--micronode', micronodeBin,
    '--sequence', JSON.stringify(sequence)
  ];

  execFile('gpu_driver_cli', args, (error, stdout, stderr) => {
    if (error) {
      // No exponer detalles internos del driver
      return res.status(500).json({ error: 'GPU command failed' });
    }
    res.json({ ok: true, output: stdout });
  });
});

app.listen(3000, () => {
  console.log('Secure GPU control service listening on port 3000');
});
