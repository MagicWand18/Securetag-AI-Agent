rules:
  - id: synthetic-cve20195418
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible vulnerabilidad similar a CVE-2019-5418: contenido de archivos se lee desde
      el sistema de ficheros usando rutas derivadas directa o indirectamente de cabeceras
      HTTP (por ejemplo, 'Accept') y se envía sin validación al cliente. Esto puede
      permitir path traversal y divulgación arbitraria de archivos si un atacante
      controla el valor de la cabecera. Valida y restringe estrictamente las rutas
      permitidas antes de leer y devolver archivos.
    metadata:
      cve: CVE-2019-5418
      source: CISA_KEV
      category: security
      technology: [nodejs, express]
      likelihood: HIGH
      impact: HIGH
      vulnerability_class: [Path Traversal, File Disclosure]
    patterns:
      - pattern-either:
          # Caso 1: uso directo de req.headers[...] en fs.readFile
          - pattern: |
              $FS.readFile($PATH, ...);
          - pattern: |
              $FS.readFileSync($PATH, ...);
      - pattern-inside: |
          app.$METHOD($ROUTE, ($REQ, $RES, ... ) => {
            ...
          });
      - pattern-inside: |
          const express = require('express');
          ...
      - pattern-inside: |
          const $REQ_HEADERS = $REQ.headers;
          ...
      - pattern-either:
          - pattern-inside: |
              const $HDR = $REQ.headers[$KEY];
              ...
          - pattern-inside: |
              const $HDR = $REQ.headers[$KEY] || $FALLBACK;
              ...
      - pattern-either:
          # La ruta usada por fs.readFile proviene (directa o indirectamente) de una cabecera
          - pattern-inside: |
              const $HDR = $REQ.headers[$KEY] || $FALLBACK;
              ...
              const $TEMPLATE = $HDR.split(',')[0].trim();
              ...
              const $PATH = $PATHLIB.join($BASE, $TEMPLATE);
              ...
          - pattern-inside: |
              const $HDR = $REQ.headers[$KEY] || $FALLBACK;
              ...
              const $PATH = $PATHLIB.join($BASE, $HDR);
              ...
      - metavariable-pattern:
          metavariable: $FS
          pattern: |
            require('fs')
      - metavariable-pattern:
          metavariable: $PATHLIB
          pattern: |
            require('path')