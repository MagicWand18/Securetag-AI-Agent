const http = require('http');
const url = require('url');
const fs = require('fs');
const path = require('path');

// Servidor HTTP muy simple que imita el comportamiento vulnerable del parámetro `portal_type`
// Vulnerabilidad: Local File Inclusion (LFI) / Path Traversal
// - No valida ni restringe el parámetro `portal_type`
// - Permite incluir y ejecutar (en este caso, leer y devolver) archivos arbitrarios del sistema

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (parsedUrl.pathname === '/helpdesk/portal') {
    // Parámetro vulnerable similar a `portal_type` en el plugin de WordPress
    const portalType = parsedUrl.query.portal_type || 'default.php';

    // RUTA BASE (similar a un directorio de plantillas del plugin)
    const baseDir = path.join(__dirname, 'portals');

    // VULNERABLE: concatenación directa del parámetro a la ruta
    // Un atacante puede usar: ?portal_type=../../../../etc/passwd
    const targetFile = path.join(baseDir, portalType);

    fs.readFile(targetFile, 'utf8', (err, data) => {
      if (err) {
        res.statusCode = 500;
        return res.end('Error loading portal: ' + err.message);
      }

      // En un entorno PHP esto equivaldría a un include/require de un archivo controlado por el usuario
      // permitiendo ejecución de código. Aquí solo lo devolvemos como texto para simplificar.
      res.statusCode = 200;
      res.setHeader('Content-Type', 'text/html; charset=utf-8');
      res.end(data);
    });
  } else {
    res.statusCode = 404;
    res.end('Not found');
  }
});

server.listen(3000, () => {
  console.log('Vulnerable helpdesk portal listening on http://localhost:3000');
});
