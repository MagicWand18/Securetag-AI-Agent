const express = require('express');
const session = require('express-session');
const crypto = require('crypto');

// Ejemplo corregido: la clave secreta NO es un valor por defecto estático
// Se fuerza el uso de una clave fuerte y específica por despliegue

const app = express();

// Cargar la clave secreta desde variable de entorno o configuración segura
// Si no existe, se genera una clave fuerte en tiempo de despliegue (no en código fuente)
function getSessionSecret() {
  const envSecret = process.env.SESSION_SECRET;
  if (envSecret && envSecret.length >= 32) {
    return envSecret;
  }

  // En un entorno real, se debería fallar el arranque si no hay SECRET configurado
  // Aquí generamos una clave aleatoria solo para el ejemplo
  console.warn('[ADVERTENCIA] SESSION_SECRET no configurado. Generando clave aleatoria solo para desarrollo.');
  return crypto.randomBytes(48).toString('hex');
}

const SESSION_SECRET = getSessionSecret();

app.use(session({
  secret: SESSION_SECRET, // Clave única por despliegue, no conocida públicamente
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production'
  }
}));

function requireAuth(req, res, next) {
  if (req.session && req.session.user) {
    return next();
  }
  res.status(401).send('No autenticado');
}

app.post('/login', (req, res) => {
  // En un caso real se validarían credenciales
  req.session.user = { username: 'admin', role: 'admin' };
  res.send('Sesión creada para admin');
});

app.get('/admin', requireAuth, (req, res) => {
  res.send(`Panel de administración. Usuario: ${req.session.user.username}`);
});

app.listen(3000, () => {
  console.log('App segura escuchando en http://localhost:3000');
  console.log('Usando SESSION_SECRET configurado de forma segura.');
});
