const express = require('express');
const session = require('express-session');
const crypto = require('crypto');

// Ejemplo seguro: inspirado en la corrección de CVE-2023-27524
// 1) NO usar claves por defecto ni hardcodeadas.
// 2) Obligar a configurar SECRET_KEY vía entorno o configuración segura.
// 3) Opcional: generar una clave aleatoria en desarrollo si no se define.

const app = express();

// Cargar SECRET_KEY desde variable de entorno o gestor de secretos
let secretKey = process.env.SESSION_SECRET;

if (!secretKey) {
  // En producción, forzar fallo si no está configurado
  if (process.env.NODE_ENV === 'production') {
    throw new Error('SESSION_SECRET no configurado. Configure una clave secreta fuerte.');
  }

  // En desarrollo, generar una clave aleatoria efímera
  secretKey = crypto.randomBytes(32).toString('hex');
  console.warn('[DEV] SESSION_SECRET no definido. Generando clave aleatoria temporal.');
}

app.use(session({
  secret: secretKey, // SEGURO: clave no por defecto, no hardcodeada
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax'
  }
}));

// Simula un login muy simple (igual que en el ejemplo vulnerable)
app.post('/login', (req, res) => {
  // En un caso real se validarían credenciales
  req.session.user = {
    id: 1,
    username: 'admin',
    role: 'admin'
  };
  res.send('Sesión creada para admin');
});

// Ruta protegida que requiere sesión válida
app.get('/admin', (req, res) => {
  if (!req.session.user || req.session.user.role !== 'admin') {
    return res.status(401).send('No autorizado');
  }
  res.send(`Panel admin para: ${req.session.user.username}`);
});

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
  console.log('Usando SESSION_SECRET configurado de forma segura.');
});
