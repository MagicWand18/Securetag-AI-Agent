const express = require('express');
const fs = require('fs');
const crypto = require('crypto');
const app = express();
app.use(express.json());

// Simulación de almacenamiento en memoria de workspaces y sesiones
const workspaces = new Map();
// Estructura: { id, ownerUserId, isPrebuilt, claimedBy }

// Almacén separado de sesiones con expiración
const sessions = new Map();
// Estructura: { token, userId, workspaceId, expiresAt, revoked }

function generateSecureToken() {
  return crypto.randomBytes(32).toString('hex');
}

function createSession(userId, workspaceId, ttlMs = 1000 * 60 * 60) {
  const token = generateSecureToken();
  const session = {
    token,
    userId,
    workspaceId,
    expiresAt: Date.now() + ttlMs,
    revoked: false
  };
  sessions.set(token, session);
  return token;
}

function revokeSessionsForWorkspace(workspaceId) {
  for (const session of sessions.values()) {
    if (session.workspaceId === workspaceId) {
      session.revoked = true;
    }
  }
}

function validateSession(token, workspaceId, userId) {
  const session = sessions.get(token);
  if (!session) return false;
  if (session.revoked) return false;
  if (session.workspaceId !== workspaceId) return false;
  if (session.userId !== userId) return false;
  if (session.expiresAt < Date.now()) return false;
  return true;
}

// Endpoint que crea un workspace preconstruido (prebuilt)
app.post('/prebuilds', (req, res) => {
  const workspaceId = `ws_${Date.now()}`;
  const prebuildUserId = 'prebuilds-system-user';

  // Se crea el workspace preconstruido SIN exponer ni persistir tokens de sesión
  const ws = {
    id: workspaceId,
    ownerUserId: prebuildUserId,
    isPrebuilt: true,
    claimedBy: null
  };

  workspaces.set(workspaceId, ws);

  // CÓDIGO SEGURO: la plantilla solo contiene metadatos, nunca tokens de sesión
  const templateData = {
    workspace_id: workspaceId,
    coder_workspace_owner: {
      id: prebuildUserId
      // NO se incluye session_token
    }
  };

  fs.writeFileSync(`./templates/${workspaceId}.json`, JSON.stringify(templateData, null, 2));

  res.json({
    message: 'Prebuilt workspace created',
    workspaceId
  });
});

// Endpoint para reclamar un workspace preconstruido
app.post('/workspaces/:id/claim', (req, res) => {
  const workspaceId = req.params.id;
  const userId = req.body.userId;

  const ws = workspaces.get(workspaceId);
  if (!ws || !ws.isPrebuilt) {
    return res.status(404).json({ error: 'Workspace not found or not prebuilt' });
  }

  // Al reclamar el workspace:
  // 1. Se revocan TODAS las sesiones asociadas al workspace (incluida la del usuario de prebuilds)
  // 2. Se genera una nueva sesión solo para el usuario que reclama
  revokeSessionsForWorkspace(workspaceId);

  ws.ownerUserId = userId;
  ws.claimedBy = userId;
  ws.isPrebuilt = false; // ya no es prebuilt una vez reclamado
  workspaces.set(workspaceId, ws);

  const newSessionToken = createSession(userId, workspaceId);

  res.json({
    message: 'Workspace claimed',
    workspaceId,
    sessionToken: newSessionToken
  });
});

// Middleware de autenticación basado en sesión segura
function authWorkspace(req, res, next) {
  const workspaceId = req.params.id;
  const token = req.headers['x-session-token'];
  const userId = req.headers['x-user-id'];

  if (!token || !userId) {
    return res.status(401).json({ error: 'Missing auth headers' });
  }

  const ws = workspaces.get(workspaceId);
  if (!ws) {
    return res.status(404).json({ error: 'Workspace not found' });
  }

  // CÓDIGO SEGURO: se valida que el token pertenezca al usuario y al workspace,
  // y que no esté revocado ni expirado.
  if (!validateSession(token, workspaceId, userId)) {
    return res.status(401).json({ error: 'Invalid or expired session token' });
  }

  req.workspace = ws;
  req.userId = userId;
  next();
}

// Endpoint que simula acceso a un workspace usando un token de sesión seguro
app.get('/workspaces/:id', authWorkspace, (req, res) => {
  const ws = req.workspace;
  res.json({
    id: ws.id,
    ownerUserId: ws.ownerUserId,
    claimedBy: ws.claimedBy,
    isPrebuilt: ws.isPrebuilt
  });
});

app.listen(3001, () => {
  console.log('Secure server listening on port 3001');
});
