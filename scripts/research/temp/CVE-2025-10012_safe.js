const express = require('express');
const mysql = require('mysql2');

// Conexión (ejemplo) - misma BD
const db = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'ieducar'
});

const app = express();

// Versión segura de la misma funcionalidad
// Mitigación: uso de consultas preparadas + validación del parámetro
app.get('/educar_historico_escolar_lst.php', (req, res) => {
  const ref_cod_aluno_raw = req.query.ref_cod_aluno;

  // Validación básica: debe ser un entero positivo
  const ref_cod_aluno = parseInt(ref_cod_aluno_raw, 10);
  if (Number.isNaN(ref_cod_aluno) || ref_cod_aluno <= 0) {
    return res.status(400).send('Parâmetro ref_cod_aluno inválido');
  }

  // CONSULTA SEGURA CON PLACEHOLDERS
  const sql = 'SELECT * FROM historico_escolar WHERE ref_cod_aluno = ?';

  db.execute(sql, [ref_cod_aluno], (err, results) => {
    if (err) {
      console.error('DB error:', err);
      return res.status(500).send('Erro ao buscar histórico escolar');
    }

    res.json({
      aluno: ref_cod_aluno,
      historico: results
    });
  });
});

app.listen(3000, () => {
  console.log('Servidor seguro rodando na porta 3000');
});
