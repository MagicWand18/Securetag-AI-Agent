rules:
  - id: synthetic-cve20259941
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible carga de archivos insegura asociada a CVE-2025-9941: se usa
      `multer.diskStorage` para guardar archivos subidos en un directorio
      accesible públicamente usando `file.originalname` como nombre final,
      sin validación de tipo, tamaño o extensión. Un atacante puede subir
      archivos maliciosos (por ejemplo, scripts ejecutables) y acceder a
      ellos directamente vía HTTP, lo que puede derivar en ejecución de
      código, defacement o exfiltración de datos. Valida estrictamente el
      tipo de archivo, tamaño, extensión y evita usar el nombre original
      del archivo en rutas públicas.
    metadata:
      cve: "CVE-2025-9941"
      source: "CISA_KEV"
      category: security
      technology:
        - express
        - nodejs
        - multer
    patterns:
      - pattern-either:
          # Patrón 1: configuración de diskStorage con destino en carpeta pública y uso de originalname
          - pattern: |
              const $M = require('multer');
              ...
              const $STORAGE = $M.diskStorage({
                destination: function ($REQ, $FILE, $CB) {
                  $CB(null, $DEST);
                },
                filename: function ($REQ2, $FILE2, $CB2) {
                  $CB2(null, $FILE2.originalname);
                }
              });
          # Patrón 2: uso de multer.diskStorage con filename basado en originalname (forma más genérica)
          - pattern: |
              $MULTER.diskStorage({
                ...
                filename: function ($REQ, $FILE, $CB) {
                  $CB(..., $FILE.originalname);
                }
              })
      # Debe existir un uso de `upload.single(...)` o similar en una ruta Express (indica endpoint de subida)
      - pattern-either:
          - pattern: |
              $APP.post($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES) => {
                ...
              })
          - pattern: |
              $APP.post($ROUTE, $UPLOAD.single($FIELD), function ($REQ, $RES) {
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES) => {
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), function ($REQ, $RES) {
                ...
              })
    fix: >
      No uses `file.originalname` directamente como nombre final ni guardes
      archivos subidos en rutas públicas sin validación. Genera nombres
      aleatorios seguros, aplica filtros de tipo MIME/extensión, límites de
      tamaño y, si es posible, almacena los archivos fuera del árbol
      público de la aplicación.