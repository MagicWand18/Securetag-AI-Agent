rules:
  - id: synthetic-cve20259942
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible carga de archivos sin restricciones asociada a CVE-2025-9942:
      se detecta uso de `multer.diskStorage` con `destination` y `filename`
      personalizados, combinado con un endpoint que acepta `upload.single(...)`
      sin validación explícita de tipo, extensión o tamaño del archivo.
      Un atacante remoto podría subir ficheros arbitrarios (por ejemplo, scripts
      ejecutables o webshells) a un directorio del servidor, lo que puede
      derivar en ejecución de código, sobreescritura de archivos o exposición
      de datos sensibles. Revise que:
      - se limite el tipo de archivo (mimetype/extensión),
      - se impongan límites de tamaño,
      - se renombre el archivo de forma segura,
      - y el directorio de subida no sea accesible directamente desde la web.
    metadata:
      cve: "CVE-2025-9942"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express", "multer"]
      likelihood: "high"
      impact: "high"
      references:
        - "https://www.npmjs.com/package/multer"
    patterns:
      - pattern-either:
          # Patrón 1: configuración de diskStorage insegura (usa file.originalname)
          - pattern: |
              const $M = require('multer');
              ...
              const $STORAGE = $M.diskStorage({
                destination: (req, file, cb) => {
                  cb(null, $UPLOAD_DIR);
                },
                filename: (req, file, cb) => {
                  cb(null, file.originalname);
                }
              });
              const $UPLOAD = $M({ storage: $STORAGE });
          # Patrón 2: variante con import y sin require directo
          - pattern: |
              import $M from 'multer';
              ...
              const $STORAGE = $M.diskStorage({
                destination: (req, file, cb) => {
                  cb(null, $UPLOAD_DIR);
                },
                filename: (req, file, cb) => {
                  cb(null, file.originalname);
                }
              });
              const $UPLOAD = $M({ storage: $STORAGE });
      - pattern-either:
          # Uso del middleware de subida en un endpoint Express sin validaciones posteriores
          - pattern: |
              const $EXP = require('express');
              ...
              const $APP = $EXP();
              ...
              $APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), (req, res) => {
                ...
              });
          - pattern: |
              import $EXP from 'express';
              ...
              const $APP = $EXP();
              ...
              $APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), (req, res) => {
                ...
              });
    fix: >
      Use `multer` con validación estricta de tipo y tamaño (por ejemplo, usando
      `fileFilter` y `limits`), renombre los archivos con identificadores
      generados de forma segura en lugar de `file.originalname`, y asegúrese de
      que el directorio de subida no sea servible directamente por el servidor
      web.