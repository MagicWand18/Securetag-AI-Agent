const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.json());

// Ruta de "exportación rápida" vulnerable a CSV/Formula Injection
app.post('/quick-export', (req, res) => {
  // Datos enviados por el usuario, por ejemplo, desde un formulario PIM
  const products = req.body.products || [];

  // Cabeceras CSV
  let csv = 'id,name,description,price\n';

  // VULNERABILIDAD: se escriben los valores tal cual, sin sanitizar
  products.forEach(p => {
    const id = p.id || '';
    const name = (p.name || '').replace(/"/g, '""');
    const description = (p.description || '').replace(/"/g, '""');
    const price = p.price || '';

    // Si el usuario envía algo como: =HYPERLINK("http://attacker","Click")
    // en el campo "description", Excel lo interpretará como fórmula
    csv += `${id},"${name}","${description}",${price}\n`;
  });

  const filePath = path.join(__dirname, 'export.csv');
  fs.writeFile(filePath, csv, (err) => {
    if (err) {
      return res.status(500).json({ error: 'Error generating CSV' });
    }

    res.setHeader('Content-Type', 'text/csv');
    res.setHeader('Content-Disposition', 'attachment; filename="export.csv"');
    fs.createReadStream(filePath).pipe(res);
  });
});

app.listen(3000, () => {
  console.log('Vulnerable CSV export server running on port 3000');
});
