const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// Configuración segura: el endpoint de heapdump está DESHABILITADO por defecto
// y sólo puede habilitarse explícitamente mediante variable de entorno.
const ENABLE_HEAPDUMP_ENDPOINT = process.env.ENABLE_HEAPDUMP_ENDPOINT === 'true';

// Middleware de autenticación muy simple (ejemplo)
function requireAdminToken(req, res, next) {
  const token = req.headers['x-admin-token'];
  const expected = process.env.ADMIN_TOKEN || 'cambia-este-token-en-produccion';

  if (!token || token !== expected) {
    return res.status(403).json({ error: 'Acceso denegado' });
  }

  next();
}

// Versión segura del endpoint de heapdump:
// 1) Deshabilitado por defecto.
// 2) Protegido con autenticación.
// 3) Opcionalmente restringido a entorno no productivo.
if (ENABLE_HEAPDUMP_ENDPOINT && process.env.NODE_ENV !== 'production') {
  app.get('/heapdump', requireAdminToken, (req, res) => {
    const heapdumpPath = path.join(__dirname, 'heapdump.hprof');

    if (!fs.existsSync(heapdumpPath)) {
      // En un caso real se generaría el heapdump bajo demanda con una librería
      fs.writeFileSync(heapdumpPath, 'SIMULATED_HEAP_DUMP_BINARY_DATA');
    }

    res.setHeader('Content-Type', 'application/octet-stream');
    res.setHeader('Content-Disposition', 'attachment; filename="heapdump.hprof"');

    fs.createReadStream(heapdumpPath).pipe(res);
  });
}

app.get('/', (req, res) => {
  if (ENABLE_HEAPDUMP_ENDPOINT && process.env.NODE_ENV !== 'production') {
    res.send('Aplicación en ejecución. Endpoint de diagnóstico protegido disponible en /heapdump');
  } else {
    res.send('Aplicación en ejecución. Endpoint de heapdump deshabilitado.');
  }
});

app.listen(PORT, () => {
  console.log(`Servidor escuchando en http://localhost:${PORT}`);
});
}