rules:
  - id: synthetic-cve20169563
    languages:
      - javascript
      - typescript
    message: >
      Posible vulnerabilidad XXE (XML External Entity) al usar xml2js.Parser sin
      deshabilitar entidades externas ni DTD, similar al CVE-2016-9563. Si el
      XML proviene de entrada controlada por el usuario (por ejemplo, peticiones
      HTTP), un atacante puede definir entidades externas (p.ej. SYSTEM
      "file:///etc/passwd") y forzar al parser a resolverlas, lo que puede
      conducir a lectura de archivos locales, SSRF u otras filtraciones de
      informaciÃ³n sensible.
    severity: ERROR
    metadata:
      cwe: "CWE-611: Improper Restriction of XML External Entity Reference"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2016-9563"
    patterns:
      - pattern: |
          new xml2js.Parser($OPTS)
      - pattern-not: |
          new xml2js.Parser({
            ...,
            explicitCharkey: $X,
            ...
          })
      - pattern-inside: |
          $HTTP = require('http');
          ...
          $HTTP.createServer(($REQ, $RES) => {
            ...
            $REQ.on('data', $CHUNK => {
              $BODY += $CHUNK.toString();
            });
            ...
            $PARSER = new xml2js.Parser($OPTS);
            ...
            $PARSER.parseString($BODY, ($ERR, $RESULT) => {
              ...
            });
            ...
          });