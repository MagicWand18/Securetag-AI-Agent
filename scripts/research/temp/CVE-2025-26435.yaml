rules:
  - id: synthetic-cve202526435
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible vulnerabilidad similar a CVE-2025-26435: un usuario autenticado no
      primario puede modificar configuraciones globales o de otro usuario sin
      verificación de rol o propiedad. En el patrón detectado, la petición se
      autentica usando un identificador de usuario (`$CURR_ID`), pero la
      actualización se aplica siempre sobre un usuario "primario" o distinto
      (`$PRIMARY_ID`) sin comprobar que el usuario actual tenga rol primario ni
      que `$CURR_ID === $PRIMARY_ID`. Esto permite que un usuario secundario
      desactive protecciones (por ejemplo, `deceptiveAppScanning`) del usuario
      primario o de todo el dispositivo, reproduciendo el contexto de
      explotación descrito en CVE-2025-26435 (escalada lógica entre perfiles
      del mismo dispositivo).
    metadata:
      cve: "CVE-2025-26435"
      source: "CISA_KEV"
      category: "access-control"
      technology: ["express", "nodejs"]
      likelihood: "high"
      impact: "high"
      description: >
        Detección de endpoints donde un usuario autenticado puede modificar
        configuraciones globales o de otro usuario (p.ej. usuario primario del
        dispositivo) sin verificación de rol o identidad, análogo a
        CVE-2025-26435.
    patterns:
      - pattern-either:
          # Caso 1: ID primario hardcodeado
          - pattern: |
              app.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $CURR_ID = $GET_CURRENT_USER_ID($REQ);
                const $CURR_USER = $USER_SETTINGS.get($CURR_ID);
                ...
                const $PRIMARY_ID = $PRIMARY_LITERAL;
                const $PRIMARY_USER = $USER_SETTINGS.get($PRIMARY_ID);
                ...
                $PRIMARY_USER.$SETTING = $VALUE;
                ...
              })
          # Caso 2: ID primario derivado pero distinto del actual
          - pattern: |
              app.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $CURR_ID = $GET_CURRENT_USER_ID($REQ);
                const $CURR_USER = $USER_SETTINGS.get($CURR_ID);
                ...
                const $PRIMARY_ID = ...;
                const $PRIMARY_USER = $USER_SETTINGS.get($PRIMARY_ID);
                ...
                $PRIMARY_USER.$SETTING = $VALUE;
                ...
              })
      - pattern-not: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
            const $CURR_ID = $GET_CURRENT_USER_ID($REQ);
            const $CURR_USER = $USER_SETTINGS.get($CURR_ID);
            ...
            const $PRIMARY_ID = $CURR_ID;
            const $PRIMARY_USER = $USER_SETTINGS.get($PRIMARY_ID);
            ...
            $PRIMARY_USER.$SETTING = $VALUE;
            ...
          })
      - pattern-not: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
            const $CURR_ID = $GET_CURRENT_USER_ID($REQ);
            const $CURR_USER = $USER_SETTINGS.get($CURR_ID);
            ...
            if ($CURR_USER.role !== 'primary' && $CURR_USER.role !== "admin") {
              return $RES.status(403).json(...);
            }
            const $PRIMARY_ID = ...;
            const $PRIMARY_USER = $USER_SETTINGS.get($PRIMARY_ID);
            ...
            $PRIMARY_USER.$SETTING = $VALUE;
            ...
          })
    options:
      symbolic_propagation: true