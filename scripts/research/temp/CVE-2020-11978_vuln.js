const express = require('express');
const { exec } = require('child_process');

const app = express();
app.use(express.json());

// Ejemplo vulnerable inspirado en CVE-2020-11978 (inyecci칩n de comandos)
// "trigger" remoto que permite ejecutar comandos arbitrarios
app.post('/trigger_task', (req, res) => {
  const { task_id, params } = req.body || {};

  // Supongamos que el "task_id" se usa para construir un comando de sistema
  // y que "params" contiene argumentos adicionales controlados por el usuario.
  // Esto es an치logo a un DAG que permite pasar comandos arbitrarios.

  if (!task_id) {
    return res.status(400).json({ error: 'task_id requerido' });
  }

  // VULNERABILIDAD: concatenaci칩n directa de entrada de usuario en un comando shell
  // Un atacante puede enviar algo como:
  // task_id: "list_files" y params: "&& rm -rf /" (u otro comando malicioso)
  const baseCommand = `airflow run example_dag ${task_id}`;
  const extraArgs = params || '';

  const finalCommand = `${baseCommand} ${extraArgs}`; // <- Inyecci칩n de comandos

  console.log('[DEBUG] Ejecutando comando:', finalCommand);

  exec(finalCommand, (error, stdout, stderr) => {
    if (error) {
      console.error('Error al ejecutar comando:', error);
      return res.status(500).json({ error: 'Fallo al ejecutar tarea' });
    }

    res.json({
      message: 'Tarea ejecutada',
      command: finalCommand,
      stdout,
      stderr
    });
  });
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
