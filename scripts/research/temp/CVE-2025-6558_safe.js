const express = require('express');
const { spawn } = require('child_process');
const path = require('path');
const escapeHtml = require('escape-html');

const app = express();
app.use(express.json());

// Lista blanca de flags permitidos para el proceso "GPU" simulado
const ALLOWED_GPU_FLAGS = new Set([
  '--enable-gpu',
  '--disable-gpu',
  '--safe-mode'
]);

// Función de validación estricta para el código de shader
// (en un caso real se podría usar un parser/validador de GLSL/WebGL)
function validateShaderSource(source) {
  if (typeof source !== 'string') return false;
  // Longitud razonable para evitar abusos de memoria
  if (source.length === 0 || source.length > 10_000) return false;
  // Ejemplo simple: no permitir etiquetas HTML ni scripts incrustados
  if (/[<>&]/.test(source)) return false;
  return true;
}

app.post('/render', (req, res) => {
  let { shaderSource, gpuFlag } = req.body;

  // Validar shaderSource
  if (!validateShaderSource(shaderSource)) {
    return res.status(400).json({ error: 'shaderSource inválido' });
  }

  // Validar gpuFlag contra lista blanca
  if (!ALLOWED_GPU_FLAGS.has(gpuFlag)) {
    gpuFlag = '--safe-mode'; // valor por defecto seguro
  }

  // Escapar contenido antes de incrustarlo en HTML
  const safeShaderSource = JSON.stringify(shaderSource);

  const html = `
    <html>
      <body>
        <canvas id="glCanvas"></canvas>
        <script>
          // shaderSource ya ha sido validado y serializado de forma segura
          const shaderSource = ${safeShaderSource};
          const canvas = document.getElementById('glCanvas');
          const gl = canvas.getContext('webgl');
          const shader = gl.createShader(gl.FRAGMENT_SHADER);
          gl.shaderSource(shader, shaderSource);
          gl.compileShader(shader);
        </script>
      </body>
    </html>
  `;

  // Uso seguro de spawn con argumentos separados, sin concatenación de comandos
  const workerPath = path.join(__dirname, 'fake-gpu-worker.js');
  const child = spawn('node', [workerPath, gpuFlag], {
    stdio: ['ignore', 'pipe', 'pipe']
  });

  let output = '';
  child.stdout.on('data', (data) => {
    output += data.toString();
  });

  child.on('error', (err) => {
    console.error('Error en GPU worker:', err);
    res.status(500).send('<h1>Error interno</h1>');
  });

  child.on('close', (code) => {
    if (code !== 0) {
      console.error('GPU worker salió con código:', code);
      return res.status(500).send('<h1>Error en procesamiento GPU</h1>');
    }

    // Devolver HTML seguro
    res.setHeader('Content-Type', 'text/html');
    res.send(html);
  });
});

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
