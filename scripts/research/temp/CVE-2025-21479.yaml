rules:
  - id: synthetic-cve202521479
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible vulnerabilidad similar a CVE-2025-21479: se construye un comando
      de GPU/driver con parámetros controlados por el cliente (por ejemplo
      `micronode` y `sequence`) y se pasa directamente a `exec`/`child_process`
      sin validación de autorización por micronode ni saneamiento del contenido.
      Esto puede permitir que un atacante ejecute comandos no autorizados en la
      GPU o fuerce secuencias arbitrarias que deriven en corrupción de memoria
      en firmware/driver. Valida qué micronodes/comandos están permitidos por
      rol y normaliza/filtra la secuencia antes de invocar el driver.
    metadata:
      cve: "CVE-2025-21479"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express"]
      references:
        - "https://nodejs.org/api/child_process.html#child_processexeccommand-options-callback"
    patterns:
      - pattern-either:
          # exec(...) con comando construido por template literal
          - pattern: |
              $CP.exec(`$CMD`, ...);
          # exec(...) con comando construido por concatenación
          - pattern: |
              $CP.exec($CMD, ...);
      - pattern-inside: |
          const $CP = require('child_process');
          ...
      - pattern-inside: |
          app.post($ROUTE, ($REQ, $RES) => {
            ...
          });
      - pattern-either:
          # Comando contiene indicador de GPU/driver y micronode
          - pattern-regex: >
              gpu_.*(driver|micronode|cli).*--micronode
          # O contiene micronode y sequence como parámetros
          - pattern-regex: >
              --micronode\b.*--sequence\b
      - pattern-either:
          # Uso directo de un parámetro de request como micronode
          - pattern-regex: >
              (req\.body|$REQ\.body)\.[A-Za-z0-9_]*micronode[A-Za-z0-9_]*|\bmicronode\b
          # Uso directo de un parámetro de request como sequence
          - pattern-regex: >
              (req\.body|$REQ\.body)\.[A-Za-z0-9_]*sequence[A-Za-z0-9_]*|\bsequence\b
      - pattern-not: |
          $CP.exec($SAFE_CMD, ...);
    fix: >
      No construyas el comando del driver directamente con datos del cliente.
      Define una lista blanca de micronodes y comandos permitidos por rol,
      valida exhaustivamente el contenido de la secuencia (tipos, longitud,
      caracteres permitidos) y pasa los parámetros al driver mediante una API
      segura o argumentos estructurados en lugar de concatenar strings.