const express = require('express');
const { exec } = require('child_process');

// Simulación de un servicio que envía comandos "micronode" a una GPU
// NOTA: Este código es intencionalmente inseguro para pruebas SAST.

const app = express();
app.use(express.json());

// Lista interna de "micronodes" y comandos permitidos (solo a modo de ejemplo)
const GPU_MICRONODES = {
  "render": "gpu_micronode_render",
  "encode": "gpu_micronode_encode",
  "decode": "gpu_micronode_decode"
};

// Mapa de usuarios y roles (muy simplificado)
const USERS = {
  "alice": { role: "admin" },
  "bob": { role: "user" }
};

// Vulnerabilidad conceptual similar a CVE-2025-21479:
// - No se valida autorización por micronode/comando.
// - Se permite que el cliente indique directamente el micronode y la secuencia de comandos.
// - Esto puede llevar a ejecución de comandos no autorizados en la GPU
//   y potencial corrupción de memoria en el firmware/driver.

app.post('/gpu/command', (req, res) => {
  const { username, micronode, sequence } = req.body;

  // 1) Autenticación superficial (solo comprueba que el usuario exista)
  const user = USERS[username];
  if (!user) {
    return res.status(401).json({ error: 'Unknown user' });
  }

  // 2) No se comprueba si el usuario está autorizado a usar este micronode
  // 3) No se valida el contenido de 'sequence' (lista arbitraria de comandos)

  // Se construye un comando "bajo nivel" para el driver de GPU
  // (simulado aquí con un comando de sistema)
  const micronodeBin = GPU_MICRONODES[micronode] || micronode; // permite micronodes arbitrarios

  // PELIGRO: concatenación directa de datos de entrada en comando
  const cmd = `gpu_driver_cli --micronode ${micronodeBin} --sequence "${sequence.join(';')}"`;

  exec(cmd, (error, stdout, stderr) => {
    if (error) {
      return res.status(500).json({ error: 'GPU command failed', detail: stderr });
    }
    res.json({ ok: true, output: stdout });
  });
});

app.listen(3000, () => {
  console.log('Insecure GPU control service listening on port 3000');
});
