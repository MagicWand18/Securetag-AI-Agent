rules:
  - id: synthetic-cve202558159
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible carga de archivos insegura relacionada con CVE-2025-58159:
      se está utilizando multer.diskStorage con file.originalname como nombre
      final del archivo sin validación de extensión o tipo de contenido.
      Un atacante puede subir archivos con extensiones dobles (por ejemplo,
      "reporte.xlsx.php") o scripts maliciosos que, en servidores mal
      configurados (p.ej. con PHP u otro intérprete habilitado en la misma
      ruta), podrían ejecutarse como código del lado del servidor.
      Valida y normaliza el nombre del archivo, restringe las extensiones
      permitidas y/o genera un nombre seguro en lugar de usar file.originalname.
    patterns:
      - pattern-inside: |
          const $MULTER = require('multer');
          ...
      - pattern-inside: |
          $STORAGE = $MULTER.diskStorage({
            ...
          });
      - pattern-either:
          - pattern: |
              filename: ($REQ, $FILE, $CB) => {
                ...
                $CB($ARG1, $FILE.originalname);
                ...
              }
          - pattern: |
              filename: function ($REQ, $FILE, $CB) {
                ...
                $CB($ARG1, $FILE.originalname);
                ...
              }
          - pattern: |
              filename($REQ, $FILE, $CB) {
                ...
                $CB($ARG1, $FILE.originalname);
                ...
              }
    metadata:
      cwe: "CWE-434: Unrestricted Upload of File with Dangerous Type"
      owasp: "A05:2021 - Security Misconfiguration"
      category: security
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-58159"