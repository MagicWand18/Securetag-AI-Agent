rules:
  - id: synthetic-cve20235631
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible XSS persistente (CVE-2023-5631): contenido HTML controlado por el
      usuario se almacena y luego se inserta directamente en una respuesta HTML
      sin escape ni sanitización. Un atacante puede enviar HTML/JavaScript
      malicioso (por ejemplo, en bodyHtml) que se ejecutará cada vez que otro
      usuario visualice el mensaje. Valida/sanitiza el HTML o escápalo antes de
      interpolarlo en plantillas.
    metadata:
      cve: "CVE-2023-5631"
      source: "CISA_KEV"
      category: security
      technology: [nodejs, express]
      vulnerability: xss
    patterns:
      # 1) Identificar el almacenamiento de HTML controlado por el usuario
      - pattern-either:
          - pattern: |
              $STORAGE.push({ ..., $FIELD, ... });
          - pattern: |
              $STORAGE.push({ ..., $FIELD: $VAL, ... });
      - pattern-inside: |
          app.post(..., (req, res) => {
            ...
            const { ..., $FIELD, ... } = req.body;
            ...
          });
      # 2) Identificar la interpolación directa del mismo campo en HTML enviado
      - pattern-either:
          - pattern: |
              const $HTML = `
                ...
                ${$MSG.$FIELD}
                ...
              `;
              ...
              res.send($HTML);
          - pattern: |
              let $HTML = `
                ...
                ${$MSG.$FIELD}
                ...
              `;
              ...
              res.send($HTML);
          - pattern: |
              var $HTML = `
                ...
                ${$MSG.$FIELD}
                ...
              `;
              ...
              res.send($HTML);
      - pattern-inside: |
          app.get(..., (req, res) => {
            ...
            const $MSG = $STORAGE[...];
            ...
          });
      # 3) Asegurarse de que el contenido se envía como HTML
      - pattern: |
          res.setHeader('Content-Type', 'text/html' ...);
    fix: >
      Escapa o sanitiza el contenido HTML controlado por el usuario antes de
      interpolarlo en la plantilla (por ejemplo, usando una librería de
      sanitización de HTML o renderizando solo texto plano en lugar de HTML).