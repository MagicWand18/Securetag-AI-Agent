rules:
  - id: synthetic-cve202121315
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible carga dinámica de módulos controlada por el usuario (CVE-2021-21315).
      El valor proveniente de la entrada del usuario se usa directamente en `require(...)`
      sin validación ni lista blanca, lo que permite a un atacante cargar módulos
      arbitrarios del sistema (por ejemplo, `child_process`) o rutas relativas para
      ejecutar código arbitrario en el servidor. Valida y restringe estrictamente
      los módulos permitidos (lista blanca estática) o evita el `require` dinámico.
    metadata:
      cve: "CVE-2021-21315"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express"]
      likelihood: "high"
      impact: "high"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2021-21315"
    patterns:
      - pattern-either:
          # Caso 1: require directo con parámetro de request (req.body / req.query / req.params)
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $DATA = $REQ.body;
                ...
                const $PLUGIN_PATH = $DATA.$FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $PLUGIN_PATH = $REQ.body.$FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $DATA = $REQ.query;
                ...
                const $PLUGIN_PATH = $DATA.$FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $PLUGIN_PATH = $REQ.query.$FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $DATA = $REQ.params;
                ...
                const $PLUGIN_PATH = $DATA.$FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const $PLUGIN_PATH = $REQ.params.$FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          # Caso 2: asignación intermedia (como el ejemplo dado: const { name } = req.body; const pluginPath = name; require(pluginPath))
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const { $FIELD, ...$REST } = $REQ.body;
                ...
                const $PLUGIN_PATH = $FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
          - pattern: |
              $APP.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                const { $FIELD, ...$REST } = $REQ.body || {};
                ...
                const $PLUGIN_PATH = $FIELD;
                ...
                require($PLUGIN_PATH);
                ...
              })
    fix: >
      No uses directamente valores de req.body/req.query/req.params en require().
      Define una lista blanca estática de módulos permitidos y selecciona el módulo
      a partir de esa lista, o elimina el uso de require dinámico controlado por el usuario.