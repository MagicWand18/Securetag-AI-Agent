const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const app = express();

// === CONFIGURACIÓN VULNERABLE ===
// - No valida tipo de archivo
// - No limita tamaño
// - Permite rutas controladas por el usuario
// - No renombra de forma segura

// Directorio de subida configurable (peligroso si viene de input del usuario)
const UPLOAD_DIR = path.join(__dirname, 'uploads');
if (!fs.existsSync(UPLOAD_DIR)) {
  fs.mkdirSync(UPLOAD_DIR, { recursive: true });
}

// Almacenamiento sin validaciones
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    // Vulnerabilidad principal: no hay restricciones sobre el tipo de archivo
    // ni sobre el endpoint que lo recibe. Cualquier usuario remoto puede
    // subir cualquier tipo de fichero a un directorio accesible.
    cb(null, UPLOAD_DIR);
  },
  filename: (req, file, cb) => {
    // Usa el nombre original sin saneo adecuado
    cb(null, file.originalname);
  }
});

const upload = multer({ storage });

// Endpoint análogo a /submitproperty.php: permite subir "imágenes" de propiedades
// pero en realidad acepta cualquier cosa (unrestricted upload)
app.post('/submitproperty', upload.single('propertyFile'), (req, res) => {
  // No se comprueba mimetype, extensión, tamaño ni contenido
  // El archivo queda subido tal cual al servidor

  if (!req.file) {
    return res.status(400).send('No file uploaded');
  }

  // Información devuelta al cliente (podría ayudar a un atacante)
  res.json({
    message: 'Property submitted (insecure upload)',
    filename: req.file.filename,
    path: req.file.path
  });
});

app.listen(3000, () => {
  console.log('Vulnerable server listening on http://localhost:3000');
});
