rules:
  - id: synthetic-cve202557819
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible bypass de autenticación de administrador y ejecución de SQL arbitrario
      similar a CVE-2025-57819: se usa un valor controlado por el usuario (cabecera,
      cookie o cuerpo de la petición) para construir una consulta SQL de autenticación
      mediante concatenación de strings, y si existe cualquier fila se considera
      al usuario como administrador. Luego, en un endpoint privilegiado (por ejemplo
      /admin o similar), se ejecuta directamente una sentencia SQL arbitraria
      proporcionada por el cliente (p.ej. req.body.rawSql) con pool.query/rawQuery.
      Esto permite a un atacante eludir la autenticación y ejecutar comandos SQL
      arbitrarios en la base de datos, pudiendo derivar en RCE en entornos similares
      al descrito en CVE-2025-57819.
    metadata:
      cwe: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-57819"
    patterns:
      # 1) Función de autenticación insegura basada en token/cabecera/cookie
      - pattern-inside: |
          async function $FUNC($REQ, ...) {
            ...
          }
      - pattern-either:
          - pattern: |
              const $RAW = $REQ.headers[$KEY] || ...;
          - pattern: |
              const $RAW = $REQ.cookies[$KEY] || ...;
          - pattern: |
              const $RAW = $REQ.body[$KEY] || ...;
      - pattern: |
          const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COL = '${$RAW}'`;
      - pattern: |
          const [$ROWS] = await $POOL.query($SQL);
      - pattern: |
          if ($ROWS.length === 0) {
            return false;
          }
      - pattern: |
          return true;

      # 2) Endpoint "admin" que llama a la función anterior y ejecuta SQL arbitrario del body
      - pattern-inside: |
          $APP.$METHOD($ROUTE, async ($REQ2, $RES, ...) => {
            ...
          })
      - pattern-either:
          - pattern: |
              $APP.post($ROUTE, async ($REQ2, $RES, ...) => {
                ...
              })
          - pattern: |
              $APP.get($ROUTE, async ($REQ2, $RES, ...) => {
                ...
              })
      - pattern: |
          const $ISADMIN = await $FUNC($REQ2);
      - pattern: |
          if (!$ISADMIN) {
            return $RES.status(401).json(...);
          }
      - pattern: |
          const { $RAWSQL } = $REQ2.body;
      - pattern-either:
          - pattern: |
              await $POOL.query($RAWSQL);
          - pattern: |
              $POOL.query($RAWSQL);