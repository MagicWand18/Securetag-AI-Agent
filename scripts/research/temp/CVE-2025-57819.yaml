rules:
  - id: synthetic-cve202557819
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible implementación de panel administrativo vulnerable similar a CVE-2025-57819:
      autenticación basada en parámetros manipulables (query/headers) sin validación robusta,
      inyección SQL en la lógica de autenticación y rutas /admin que ejecutan SQL o comandos
      del sistema controlados por el usuario. Un atacante puede forzar req.user como admin
      y luego ejecutar consultas SQL arbitrarias o comandos del sistema, lo que coincide con
      el contexto de alta probabilidad de explotación descrito para CVE-2025-57819.
    metadata:
      cve: "CVE-2025-57819"
      source: "CISA_KEV"
      category: security
      technology:
        - express
        - mysql
        - node
      likelihood_of_exploit: "high"
      cwe:
        - "CWE-287"   # Improper Authentication
        - "CWE-89"    # SQL Injection
        - "CWE-78"    # OS Command Injection
    patterns:
      - pattern-inside: |
          const express = require('express');
          ...
          const app = express();
          ...
          app.use($MIDDLEWARE, async ($REQ, $RES, $NEXT) => {
            ...
          });
      - pattern-either:
          # 1) Bypass de autenticación basado en parámetros manipulables para usuario admin
          - pattern: |
              app.use($ROUTE, async ($REQ, $RES, $NEXT) => {
                ...
                const $USER = $REQ.query.user || $REQ.headers['x-user'] || $ALT_USER;
                const $AUTHFLAG = $REQ.query.auth || $REQ.headers['x-auth'];
                ...
                if ($USER === 'admin' && $AUTHFLAG === '1') {
                  $REQ.user = { username: 'admin', role: 'admin', authenticated: true, ... };
                  return $NEXT();
                }
                ...
              });
          # 2) Lógica de autenticación con SQL injection (string interpolation con username/token)
          - pattern: |
              const $USERNAME = $REQ.query.username || $UDEFAULT;
              const $TOKEN = $REQ.query.token || $TDEFAULT;
              const $SQL = `SELECT * FROM users WHERE username = '${$USERNAME}' AND token = '${$TOKEN}'`;
              const [$ROWS] = await $POOL.query($SQL);
              if ($ROWS.length > 0) {
                $REQ.user = { username: $ROWS[0].username, role: $ROWS[0].role, authenticated: true, ... };
                return $NEXT();
              }
          # 3) Asignación de usuario invitado no autenticado pero permitiendo paso a /admin
          - pattern: |
              app.use($ROUTE, async ($REQ, $RES, $NEXT) => {
                ...
                $REQ.user = { username: 'anonymous', role: 'guest', authenticated: false, ... };
                return $NEXT();
              });
          # 4) Ruta /admin/db/execute que ejecuta SQL arbitrario desde el body sin validar req.user
          - pattern: |
              app.post('/admin/db/execute', async ($REQ, $RES) => {
                ...
                const { query } = $REQ.body;
                const [$RESULT] = await $POOL.query(query);
                return $RES.json({ ok: true, result: $RESULT, ... });
              });
          # 5) Ruta /admin/system/exec que ejecuta comandos del sistema desde el body
          - pattern: |
              app.post('/admin/system/exec', async ($REQ, $RES) => {
                const { exec } = require('child_process');
                const $CMD = $REQ.body.cmd;
                exec($CMD, ($ERROR, $STDOUT, $STDERR) => {
                  if ($ERROR) {
                    ...
                    return $RES.status(500).json({ ok: false, error: 'Exec error', ... });
                  }
                  return $RES.json({ ok: true, stdout: $STDOUT, stderr: $STDERR, ... });
                });
              });