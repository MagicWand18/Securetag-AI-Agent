rules:
  - id: synthetic-cve201610033
    languages: [javascript, typescript]
    message: >
      Posible inyección de comandos tipo CVE-2016-10033: se construye una cadena
      de shell para enviar correo (p.ej. usando `sendmail`) concatenando
      directamente datos controlados por el usuario. Un atacante puede inyectar
      opciones adicionales o comandos arbitrarios en los parámetros de correo
      (como `to`, `subject` o `message`), logrando ejecución remota de comandos.
      Valida y escapa estrictamente los parámetros o usa APIs que no dependan de
      la construcción manual de la línea de comando.
    severity: ERROR
    metadata:
      cve: "CVE-2016-10033"
      source: "CISA_KEV"
      category: "command-injection"
      technology: ["nodejs", "sendmail", "mailer"]
    patterns:
      - pattern-either:
          # Caso 1: uso directo de exec/execSync con tubería a sendmail
          - pattern: |
              $EXEC(`... | $SENDMAIL ...`);
          - pattern: |
              $EXEC("... | " + $SENDMAIL + ...);
          - pattern: |
              $EXEC($CMD);
      - pattern-inside: |
          const { exec, ... } = require('child_process');
          ...
      - pattern-inside: |
          $EXEC = require('child_process').exec;
          ...
      - pattern-inside: |
          $EXEC = require('child_process').execSync;
          ...
      - pattern-inside: |
          const $HTTP = require('http');
          ...
      - pattern-inside: |
          $HTTP.createServer(($REQ, $RES) => {
            ...
          });
      - pattern-inside: |
          let $BODY = '';
          $REQ.on('data', $CHUNK => { $BODY += $CHUNK; });
          ...
      - pattern-inside: |
          $REQ.on('end', () => {
            ...
            const $DATA = JSON.parse($BODY || '{}');
            ...
          });
      - pattern-inside: |
          const $TO = $DATA.to || '';
          const $SUBJECT = $DATA.subject || '';
          const $MESSAGE = $DATA.message || '';
          ...
      - pattern-inside: |
          const $CMD = `...${$SUBJECT}...${$TO}...${$MESSAGE}...`;
          ...
      - pattern-either:
          - pattern-inside: |
              const $CMD = `... | /usr/sbin/sendmail ...`;
              ...
          - pattern-inside: |
              const $CMD = `... | /usr/bin/sendmail ...`;
              ...
          - pattern-inside: |
              const $CMD = `... | sendmail ...`;
              ...
          - pattern-inside: |
              const $CMD = "..." + "| /usr/sbin/sendmail" + "...";
              ...
          - pattern-inside: |
              const $CMD = "..." + "| /usr/bin/sendmail" + "...";
              ...
          - pattern-inside: |
              const $CMD = "..." + "| sendmail" + "...";
              ...
      - pattern-not: |
          $EXEC("sendmail");
      - pattern-not: |
          $EXEC(".../sendmail", ...);