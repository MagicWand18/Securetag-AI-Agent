const express = require('express');
const fileUpload = require('express-fileupload');
const path = require('path');
const fs = require('fs');

const app = express();

// Middleware para manejar uploads sin restricciones
app.use(fileUpload());

// Ruta "similar" a manage_website.php que permite subir archivos sin validación
app.post('/manage_website/upload', async (req, res) => {
  if (!req.files || !req.files.file) {
    return res.status(400).send('No file uploaded');
  }

  const uploadedFile = req.files.file;

  // DIRECTORIO PUBLICO ACCESIBLE DESDE LA WEB
  const uploadDir = path.join(__dirname, 'public', 'uploads');

  if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
  }

  // VULNERABILIDAD: no se valida el tipo de archivo, ni la extensión, ni el tamaño.
  // El atacante puede subir un archivo .php, .js, .html, etc. que luego será ejecutado/servido.
  const uploadPath = path.join(uploadDir, uploadedFile.name);

  uploadedFile.mv(uploadPath, (err) => {
    if (err) {
      return res.status(500).send('Error saving file');
    }

    // Se devuelve la URL pública del archivo subido
    const publicUrl = `/uploads/${uploadedFile.name}`;
    res.send(`File uploaded successfully: ${publicUrl}`);
  });
});

app.listen(3000, () => {
  console.log('Vulnerable app listening on port 3000');
});
