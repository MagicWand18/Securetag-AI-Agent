const http = require('http');
const { JSDOM } = require('jsdom');

// Versión SEGURA: no se ejecuta código JavaScript del usuario.
// En lugar de ello, se parsea el HTML y se extraen datos de forma controlada.

const server = http.createServer((req, res) => {
  if (req.method !== 'POST') {
    res.writeHead(405, { 'Content-Type': 'text/plain' });
    return res.end('Use POST');
  }

  let body = '';
  req.on('data', chunk => {
    body += chunk;
  });

  req.on('end', () => {
    try {
      // Parsear el HTML de forma segura sin ejecutar scripts
      const dom = new JSDOM(body, {
        runScripts: 'outside-only', // nunca ejecutar scripts embebidos
        resources: 'usable'
      });

      const document = dom.window.document;

      // En lugar de ejecutar el contenido de <script>, solo lo leemos como texto
      const scriptTags = Array.from(document.querySelectorAll('script'));
      const scriptsContent = scriptTags.map(tag => tag.textContent || '');

      // Ejemplo de procesamiento seguro: contar scripts y devolver su contenido
      const result = {
        scriptCount: scriptsContent.length,
        scriptsPreview: scriptsContent.map(s => s.slice(0, 50))
      };

      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({
        status: 'ok',
        result
      }));
    } catch (err) {
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: err.message }));
    }
  });
});

server.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
