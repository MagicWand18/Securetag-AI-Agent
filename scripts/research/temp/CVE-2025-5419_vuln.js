const http = require('http');
const { JSDOM } = require('jsdom');

// Simula un microservicio que "preprocesa" HTML recibido y ejecuta JS embebido
// Vulnerabilidad conceptual: uso inseguro de eval sobre código JS extraído del DOM
// (equivalente lógico a permitir que HTML/JS controlado por el atacante ejecute
// código arbitrario en el motor JS, lo que en un motor vulnerable podría
// desencadenar un OOB read/write tipo CVE-2025-5419).

function extractInlineScripts(html) {
  const dom = new JSDOM(html);
  const scripts = dom.window.document.querySelectorAll('script');
  let inlineCode = '';

  scripts.forEach((s) => {
    // No se valida el origen ni el contenido del script
    if (!s.src) {
      inlineCode += s.textContent + '\n';
    }
  });

  return inlineCode;
}

const server = http.createServer((req, res) => {
  if (req.method !== 'POST') {
    res.writeHead(405, { 'Content-Type': 'text/plain' });
    return res.end('Use POST with HTML body');
  }

  let body = '';
  req.on('data', (chunk) => {
    body += chunk;
  });

  req.on('end', () => {
    try {
      // HTML completamente controlado por el usuario
      const userHtml = body.toString('utf8');

      // Extrae scripts inline del HTML
      const inlineJs = extractInlineScripts(userHtml);

      // VULNERABLE: ejecuta directamente el JS extraído del HTML del usuario
      // En un motor JS con un bug de OOB read/write (como el descrito en CVE-2025-5419),
      // un atacante puede suministrar un payload HTML/JS especialmente diseñado
      // que dispare la corrupción de memoria.
      // Desde el punto de vista SAST, el patrón crítico es eval() sobre datos de entrada.
      const result = eval(inlineJs); // SINK inseguro

      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ status: 'ok', result }));
    } catch (e) {
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: e.message }));
    }
  });
});

server.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
