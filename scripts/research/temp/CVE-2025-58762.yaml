rules:
  - id: synthetic-cve202558762
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible explotación similar a CVE-2025-58762: se construye una ruta de archivo
      usando datos controlados por el usuario (por ejemplo, parámetros de consulta)
      concatenados al nombre del archivo y se pasa directamente a fs.createWriteStream
      o fs.createReadStream. En escenarios tipo Tautulli/Plex, un atacante que
      controle la URL de origen puede combinar path traversal en el sufijo del
      nombre de archivo con contenido malicioso (por ejemplo, un script) para
      escribir archivos arbitrarios en ubicaciones ejecutables y lograr RCE.
    metadata:
      cwe: "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-58762"
    patterns:
      - pattern-inside: |
          app.$ROUTE($PATH, ... , (req, $RES, ...) => {
            ...
          })
      - pattern-either:
          # Usuario controla el sufijo del nombre de archivo (query)
          - pattern: |
              const $SUFFIX = req.query.$Q;
              ...
              const $DIR = path.join(...);
              const $FILE = path.join($DIR, $PREFIX + $SUFFIX);
              ...
              fs.createWriteStream($FILE)
          - pattern: |
              const $SUFFIX = req.query.$Q;
              ...
              const $DIR = path.join(...);
              const $FILE = path.join($DIR, `${$PREFIX}_${$SUFFIX}`);
              ...
              fs.createWriteStream($FILE)
          - pattern: |
              const $SUFFIX = req.query.$Q;
              ...
              const $DIR = path.join(...);
              const $FILE = path.join($DIR, `${$SUFFIX}`);
              ...
              fs.createWriteStream($FILE)
          # Variante con lectura posterior del mismo archivo
          - pattern: |
              const $SUFFIX = req.query.$Q;
              ...
              const $DIR = path.join(...);
              const $FILE = path.join($DIR, `${$PREFIX}_${$SUFFIX}`);
              ...
              fs.createWriteStream($FILE);
              ...
              fs.createReadStream($FILE)
      - pattern-not: |
          const $SUFFIX = req.query.$Q;
          ...
          const $DIR = path.join(...);
          const $FILE = path.join($DIR, path.basename($SUFFIX));
          ...
          fs.createWriteStream($FILE)