rules:
  - id: synthetic-cve20246670
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible SQL Injection relacionado con CVE-2024-6670: se construye una consulta SQL
      concatenando directamente datos controlados por el usuario (por ejemplo, req.query,
      req.body, req.params) en una cadena SQL antes de pasarlos a db.query / connection.query.
      Esto permite a un atacante inyectar cláusulas como ' OR '1'='1' UNION SELECT ... para
      extraer credenciales o datos sensibles, especialmente en endpoints sin autenticación.
      Usa consultas parametrizadas / placeholders en lugar de concatenación de strings.
    metadata:
      cve: "CVE-2024-6670"
      source: "CISA_KEV"
      category: "security"
      technology:
        - nodejs
        - express
        - mysql
      likelihood: "high"
      impact: "high"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2024-6670"
      vulnerability_class:
        - "SQL Injection"
    patterns:
      - pattern-either:
          # mysql2 / mysql style
          - pattern: |
              $DB = require('mysql2');
              ...
              $CONN = $DB.createConnection(...);
              ...
              $CONN.query($SQL, ...);
          - pattern: |
              $DB = require('mysql');
              ...
              $CONN = $DB.createConnection(...);
              ...
              $CONN.query($SQL, ...);
          - pattern: |
              import $DB from 'mysql2';
              ...
              const $CONN = $DB.createConnection(...);
              ...
              $CONN.query($SQL, ...);
          - pattern: |
              import $DB from 'mysql';
              ...
              const $CONN = $DB.createConnection(...);
              ...
              $CONN.query($SQL, ...);
      - pattern: |
          $SQL = $Q1 + $USER + $Q2;
      - pattern-either:
          - pattern: |
              $USER = req.query[$KEY];
          - pattern: |
              $USER = req.query.$KEY;
          - pattern: |
              $USER = req.body[$KEY];
          - pattern: |
              $USER = req.body.$KEY;
          - pattern: |
              $USER = req.params[$KEY];
          - pattern: |
              $USER = req.params.$KEY;
      - pattern-inside: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          });
    fix: >
      Usa consultas parametrizadas, por ejemplo:
      const sql = "SELECT id, username, encrypted_password FROM users WHERE username = ?";
      db.query(sql, [username], ...);