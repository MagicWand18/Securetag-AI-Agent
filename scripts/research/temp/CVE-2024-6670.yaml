rules:
  - id: synthetic-cve20246670
    languages:
      - javascript
      - typescript
    message: >
      Posible inyección SQL similar a CVE-2024-6670: se construye una consulta SQL
      concatenando directamente parámetros controlados por el usuario (por ejemplo,
      username/password de un endpoint de login) en un SELECT sobre la tabla de
      usuarios. Un atacante no autenticado puede manipular el valor de estos
      parámetros (por ejemplo, con ' OR '1'='1 o UNION SELECT ...) para extraer
      credenciales cifradas u otros datos sensibles del único usuario configurado.
      Usa siempre consultas parametrizadas/preparadas en lugar de concatenar
      cadenas SQL.
    severity: ERROR
    metadata:
      cwe: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2024-6670"
    patterns:
      # 1) Estamos dentro de un handler HTTP típico (Express) que recibe req/res
      - pattern-inside: |
          $APP.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          })
      # 2) Se construye una cadena SQL con template literal o concatenación
      #    que contiene un SELECT sobre una tabla de usuarios
      - pattern-either:
          - pattern: |
              const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COND`;
          - pattern: |
              let $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COND`;
          - pattern: |
              var $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COND`;
          - pattern: |
              const $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " + $COND;
          - pattern: |
              let $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " + $COND;
          - pattern: |
              var $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " + $COND;
      # 3) La condición de la cláusula WHERE incluye interpolación directa de
      #    datos provenientes del cuerpo de la petición (req.body.*),
      #    típico de un login vulnerable.
      - pattern-either:
          - pattern: |
              const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = '${$REQ.body.$PARAM}' AND $FIELD2 = '${$REQ.body.$PARAM2}'`;
          - pattern: |
              let $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = '${$REQ.body.$PARAM}' AND $FIELD2 = '${$REQ.body.$PARAM2}'`;
          - pattern: |
              var $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = '${$REQ.body.$PARAM}' AND $FIELD2 = '${$REQ.body.$PARAM2}'`;
          - pattern: |
              const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = '${$REQ.body.$PARAM}'`;
          - pattern: |
              let $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = '${$REQ.body.$PARAM}'`;
          - pattern: |
              var $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = '${$REQ.body.$PARAM}'`;
          - pattern: |
              const $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " + $FIELD + " = '" + $REQ.body.$PARAM + "'";
          - pattern: |
              let $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " + $FIELD + " = '" + $REQ.body.$PARAM + "'";
          - pattern: |
              var $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " + $FIELD + " = '" + $REQ.body.$PARAM + "'";
      # 4) La consulta se ejecuta mediante un cliente SQL típico de Node.js
      - pattern-either:
          - pattern: |
              $DB.query($SQL, ...);
          - pattern: |
              $DB.execute($SQL, ...);
          - pattern: |
              $DB.query($SQL, ($ERR, $RESULTS) => {
                ...
              });
          - pattern: |
              $DB.execute($SQL, ($ERR, $RESULTS) => {
                ...
              })