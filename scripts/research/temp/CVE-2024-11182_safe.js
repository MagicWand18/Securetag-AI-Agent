const http = require('http');
const url = require('url');
const createDOMPurify = require('dompurify');
const { JSDOM } = require('jsdom');

// Simula un visor web de correos que muestra el cuerpo HTML de forma segura
// Corrección: sanitizar el HTML del correo antes de enviarlo al navegador

const window = new JSDOM('').window;
const DOMPurify = createDOMPurify(window);

const emails = {
  "1": {
    subject: "Bienvenido",
    // Podría contener HTML malicioso enviado por un atacante
    htmlBody: '<h1>Hola</h1><p>Gracias por registrarte</p>'
  }
};

http.createServer((req, res) => {
  const parsed = url.parse(req.url, true);

  if (parsed.pathname === '/email') {
    const id = parsed.query.id || '1';
    const email = emails[id];

    if (!email) {
      res.writeHead(404, { 'Content-Type': 'text/plain' });
      return res.end('Email no encontrado');
    }

    // SANITIZACIÓN: se limpia el HTML del correo para eliminar scripts y atributos peligrosos
    const sanitizedBody = DOMPurify.sanitize(email.htmlBody, {
      ALLOWED_TAGS: [
        'b', 'i', 'em', 'strong', 'a', 'p', 'br', 'ul', 'ol', 'li',
        'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'span', 'div'
      ],
      ALLOWED_ATTR: ['href', 'title', 'style']
    });

    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>Visor de correo</title>
        </head>
        <body>
          <h2>Asunto: ${email.subject}</h2>
          <hr />
          <div id="email-body">
            ${sanitizedBody} <!-- HTML del correo sanitizado -->
          </div>
        </body>
      </html>
    `);
  } else {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('Use /email?id=1 para ver un correo');
  }
}).listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
