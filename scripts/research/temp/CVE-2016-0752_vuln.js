const http = require('http');
const fs = require('fs');
const path = require('path');

// Servidor HTTP muy simple que sirve plantillas HTML desde un directorio
// VULNERABLE a directory traversal (similar al patrón de CVE-2016-0752)

const TEMPLATES_DIR = path.join(__dirname, 'views');

const server = http.createServer((req, res) => {
  // Ejemplo de URL: /render?template=home
  const url = new URL(req.url, `http://${req.headers.host}`);
  const templateName = url.searchParams.get('template') || 'home';

  // VULNERABLE: se concatena directamente el parámetro de usuario
  // Permite cosas como: ?template=../../../../etc/passwd
  const templatePath = path.join(TEMPLATES_DIR, templateName + '.html');

  fs.readFile(templatePath, 'utf8', (err, data) => {
    if (err) {
      res.statusCode = 404;
      res.setHeader('Content-Type', 'text/plain; charset=utf-8');
      return res.end('Template not found');
    }

    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.end(data);
  });
});

server.listen(3000, () => {
  console.log('Vulnerable server listening on http://localhost:3000');
});
