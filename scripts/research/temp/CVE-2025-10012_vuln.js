const express = require('express');
const mysql = require('mysql2');

// Conexión insegura (solo para ejemplo)
const db = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'ieducar'
});

const app = express();

// Ruta que simula el comportamiento de educar_historico_escolar_lst.php
// Vulnerabilidad: SQL Injection en el parámetro ref_cod_aluno (CVE-2025-10012-like)
app.get('/educar_historico_escolar_lst.php', (req, res) => {
  const ref_cod_aluno = req.query.ref_cod_aluno; // entrada directa del usuario

  // CONSTRUCCIÓN INSEGURA DE LA CONSULTA
  // El valor de ref_cod_aluno se concatena directamente en el SQL
  const sql = `SELECT * FROM historico_escolar WHERE ref_cod_aluno = ${ref_cod_aluno}`;

  db.query(sql, (err, results) => {
    if (err) {
      console.error('DB error:', err);
      return res.status(500).send('Erro ao buscar histórico escolar');
    }

    res.json({
      aluno: ref_cod_aluno,
      historico: results
    });
  });
});

app.listen(3000, () => {
  console.log('Servidor vulnerável rodando na porta 3000');
});
