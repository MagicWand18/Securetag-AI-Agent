const http = require('http');
const fs = require('fs');
const url = require('url');
const path = require('path');

// Versión segura del mismo endpoint, con mitigación de directory traversal

const PUBLIC_DIR = path.join(__dirname, 'public');

function isPathInside(base, target) {
  const relative = path.relative(base, target);
  // Evita que la ruta resultante salga del directorio base
  return !!relative && !relative.startsWith('..') && !path.isAbsolute(relative);
}

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (parsedUrl.pathname === '/scheduler/ui/js/ffffffffbca41eb4/UIUtilJavaScriptJS') {
    const requestedFile = parsedUrl.query.file || 'index.html';

    // Normalizar y validar el nombre del archivo
    // 1) Rechazar rutas que contengan secuencias de traversal explícitas
    if (requestedFile.includes('..') || requestedFile.includes('\\')) {
      res.statusCode = 400;
      res.setHeader('Content-Type', 'text/plain');
      return res.end('Invalid file path');
    }

    // 2) Construir la ruta absoluta y verificar que permanezca dentro de PUBLIC_DIR
    const filePath = path.join(PUBLIC_DIR, requestedFile);
    const normalizedBase = path.resolve(PUBLIC_DIR);
    const normalizedTarget = path.resolve(filePath);

    if (!isPathInside(normalizedBase, normalizedTarget)) {
      res.statusCode = 403;
      res.setHeader('Content-Type', 'text/plain');
      return res.end('Access denied');
    }

    fs.readFile(normalizedTarget, 'utf8', (err, data) => {
      if (err) {
        res.statusCode = 404;
        res.setHeader('Content-Type', 'text/plain');
        return res.end('File not found');
      }

      res.statusCode = 200;
      res.setHeader('Content-Type', 'application/javascript');
      res.end(data);
    });
  } else {
    res.statusCode = 404;
    res.setHeader('Content-Type', 'text/plain');
    res.end('Not found');
  }
});

server.listen(3000, () => {
  console.log('Safe server listening on http://localhost:3000');
});
