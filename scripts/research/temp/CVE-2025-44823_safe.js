const express = require('express');
const app = express();

// Simulación de base de datos de usuarios
// Las claves API se almacenan internamente pero NO se exponen en las respuestas
const users = [
  {
    id: 1,
    name: 'devadmin',
    username: 'devadmin',
    email: 'test@example.com',
    apikey: 'dcaa1693a79d651ebc29d45c879b3fbbc730d2de', // interno, no se devuelve
    auth_type: 'admin'
  },
  {
    id: 2,
    name: 'user1',
    username: 'user1',
    email: 'user1@example.com',
    apikey: '1111111111111111111111111111111111111111', // interno, no se devuelve
    auth_type: 'user'
  }
];

// Middleware de autenticación con verificación de rol
function apiAuth(req, res, next) {
  const token = req.query.token;

  if (!token) {
    return res.status(401).json({ error: 'Missing API token' });
  }

  // En un caso real se validaría el token contra la base de datos
  // Aquí simulamos dos tipos de token: admin y user
  if (token === 'admin-token') {
    req.apiUser = { username: 'admin', role: 'admin' };
  } else if (token === 'user-token') {
    req.apiUser = { username: 'user1', role: 'user' };
  } else {
    return res.status(403).json({ error: 'Invalid API token' });
  }

  next();
}

// Función de saneado: elimina campos sensibles antes de responder
function sanitizeUser(user) {
  const { apikey, ...safeFields } = user; // se elimina la clave API
  return safeFields;
}

// ENDPOINT SEGURO: no expone claves API y aplica control de acceso adecuado
app.get('/api/system/get_users', apiAuth, (req, res) => {
  // Solo los administradores pueden listar usuarios
  if (req.apiUser.role !== 'admin') {
    return res.status(403).json({ error: 'Insufficient privileges' });
  }

  // Se devuelven solo campos no sensibles
  const safeUsers = users.map(sanitizeUser);
  res.json(safeUsers);
});

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
