const express = require('express');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

const app = express();

const UPLOAD_DIR = path.join(__dirname, 'uploads_safe');
if (!fs.existsSync(UPLOAD_DIR)) {
  fs.mkdirSync(UPLOAD_DIR, { recursive: true });
}

// Lista blanca de extensiones permitidas para "planillas"
const ALLOWED_EXTENSIONS = ['.xls', '.xlsx', '.csv', '.ods'];

// Genera un nombre de archivo seguro, sin usar el nombre original
function generateSafeFilename(originalName) {
  const ext = path.extname(originalName).toLowerCase();
  const randomName = crypto.randomBytes(16).toString('hex');
  return randomName + ext;
}

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, UPLOAD_DIR);
  },
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname).toLowerCase();

    // VALIDACIÓN: solo extensiones de planillas permitidas
    if (!ALLOWED_EXTENSIONS.includes(ext)) {
      return cb(new Error('Invalid file type'));
    }

    // No se usa el nombre original controlado por el usuario
    const safeName = generateSafeFilename(file.originalname);
    cb(null, safeName);
  }
});

const upload = multer({
  storage,
  fileFilter: (req, file, cb) => {
    const ext = path.extname(file.originalname).toLowerCase();

    // Reforzar validación en el fileFilter
    if (!ALLOWED_EXTENSIONS.includes(ext)) {
      return cb(new Error('Only spreadsheet files are allowed'));
    }

    cb(null, true);
  },
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB
  }
});

app.post('/upload-spreadsheet', (req, res, next) => {
  upload.single('spreadsheet')(req, res, (err) => {
    if (err) {
      return res.status(400).json({ error: err.message });
    }

    if (!req.file) {
      return res.status(400).json({ error: 'No file uploaded' });
    }

    // Ruta interna segura, no se expone directamente como ejecutable
    const savedPath = path.join(UPLOAD_DIR, req.file.filename);

    // No se expone una URL que pueda ser ejecutada como script por otro motor
    res.json({
      message: 'File uploaded safely',
      stored_as: req.file.filename,
      internal_path: savedPath
    });
  });
});

// En el servidor seguro NO se expone la carpeta de uploads como estática ejecutable
// Si se necesita descarga, se sirve el archivo como adjunto, nunca como script
app.get('/download-spreadsheet/:name', (req, res) => {
  const requested = req.params.name;

  // Normalizar y evitar path traversal
  const safeBase = path.resolve(UPLOAD_DIR);
  const filePath = path.resolve(path.join(UPLOAD_DIR, requested));

  if (!filePath.startsWith(safeBase)) {
    return res.status(400).json({ error: 'Invalid path' });
  }

  if (!fs.existsSync(filePath)) {
    return res.status(404).json({ error: 'File not found' });
  }

  // Se fuerza descarga, no ejecución
  res.download(filePath, requested);
});

app.listen(3001, () => {
  console.log('Safe server listening on port 3001');
});
