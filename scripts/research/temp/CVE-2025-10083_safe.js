const express = require('express');
const fileUpload = require('express-fileupload');
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');

const app = express();
app.use(fileUpload({
  limits: {
    fileSize: 2 * 1024 * 1024 // 2 MB
  },
  abortOnLimit: true
}));

// Lista blanca de tipos MIME permitidos para avatar
const ALLOWED_MIME_TYPES = [
  'image/jpeg',
  'image/png',
  'image/gif'
];

// Extensiones permitidas
const ALLOWED_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif'];

// Directorio de subida fuera del árbol público
const UPLOAD_DIR = path.join(__dirname, 'data', 'avatars');
if (!fs.existsSync(UPLOAD_DIR)) {
  fs.mkdirSync(UPLOAD_DIR, { recursive: true });
}

// Middleware de autenticación muy simplificado (placeholder)
function requireAdmin(req, res, next) {
  // En una app real, validar sesión/JWT/rol
  const isAdmin = req.headers['x-admin'] === 'true';
  if (!isAdmin) {
    return res.status(403).send('Forbidden');
  }
  next();
}

app.post('/admin/profile', requireAdmin, (req, res) => {
  if (!req.files || !req.files.avatar) {
    return res.status(400).send('No file uploaded');
  }

  const avatar = req.files.avatar;

  // Validar tipo MIME
  if (!ALLOWED_MIME_TYPES.includes(avatar.mimetype)) {
    return res.status(400).send('Invalid file type');
  }

  // Validar extensión
  const ext = path.extname(avatar.name).toLowerCase();
  if (!ALLOWED_EXTENSIONS.includes(ext)) {
    return res.status(400).send('Invalid file extension');
  }

  // Generar nombre de archivo seguro y aleatorio
  const safeName = crypto.randomBytes(16).toString('hex') + ext;
  const uploadPath = path.join(UPLOAD_DIR, safeName);

  avatar.mv(uploadPath, (err) => {
    if (err) {
      return res.status(500).send('Upload error');
    }

    // En una app real, se serviría la imagen a través de una ruta controlada
    // que valide permisos, no directamente desde un directorio público.
    res.json({
      message: 'Avatar uploaded successfully',
      fileId: safeName
    });
  });
});

app.listen(3001, () => {
  console.log('Safe app listening on port 3001');
});
