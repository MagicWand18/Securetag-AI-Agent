rules:
  - id: synthetic-cve202035730
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible vulnerabilidad similar a CVE-2020-35730: se está generando HTML
      de forma dinámica insertando directamente datos controlados por el usuario
      dentro de atributos o contenido de etiquetas <a> sin escape ni
      sanitización. Esto puede permitir inyección de atributos/eventos o
      ejecución de JavaScript (XSS) al renderizar correos o contenido HTML.
    metadata:
      cwe: "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2020-35730"
    patterns:
      - pattern-inside: |
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
          });
      - pattern-either:
          # Caso 1: uso directo de replace con callback que devuelve <a href="${...}">
          - pattern: |
              $TEXT.replace($REGEX, ($M, ...) => {
                ...
                return `<a href="${$URL}">${$URL}</a>`;
              })
          # Caso 2: uso directo de replace con callback que devuelve <a href='${...}'>
          - pattern: |
              $TEXT.replace($REGEX, ($M, ...) => {
                ...
                return `<a href='${$URL}'>${$URL}</a>`;
              })
          # Caso 3: uso de replace con callback que devuelve <a ...> sin escape
          - pattern: |
              $TEXT.replace($REGEX, ($M, ...) => {
                ...
                return `<a $ATTR="${$URL}">${$URL}</a>`;
              })
          # Caso 4: uso de replace con callback que devuelve <a href="${...}"> para pseudo-etiquetas tipo [linkref]
          - pattern: |
              $TEXT.replace(/\[linkref:(.+?)\]/g, ($M, $URL) => {
                ...
                return `<a href="${$URL}">${$URL}</a>`;
              })
          # Caso 5: variante simple sin parámetros extra en el callback
          - pattern: |
              $TEXT.replace($REGEX, ($M) => {
                ...
                return `<a href="${$URL}">${$URL}</a>`;
              })