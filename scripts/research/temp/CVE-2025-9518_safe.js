const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Directorio base donde se guardan los logs de debug
const DEBUG_BASE_DIR = path.join(__dirname, 'debug-logs');

// Lista blanca opcional de extensiones permitidas
const ALLOWED_EXTENSIONS = new Set(['.log', '.txt']);

// Función auxiliar para validar que la ruta está dentro del directorio permitido
function isPathInsideBase(base, target) {
  const relative = path.relative(base, target);
  // Evita salir del directorio base (.., enlaces simbólicos resueltos, etc.)
  return !!relative && !relative.startsWith('..') && !path.isAbsolute(relative);
}

app.post('/admin/debug/delete-log', (req, res) => {
  const debugPath = req.body.debug_path;

  if (!debugPath || typeof debugPath !== 'string') {
    return res.status(400).json({ error: 'Invalid debug_path' });
  }

  // Normalizar el path y evitar secuencias peligrosas
  const normalized = path.normalize(debugPath).replace(/^([/\\])+/, ''); // quita slashes iniciales

  // Construir la ruta absoluta dentro del directorio base
  const targetFile = path.join(DEBUG_BASE_DIR, normalized);

  // Validar que el archivo está realmente dentro de DEBUG_BASE_DIR
  if (!isPathInsideBase(DEBUG_BASE_DIR, targetFile)) {
    return res.status(400).json({ error: 'Path traversal detected' });
  }

  // Validar extensión (opcional pero recomendable)
  const ext = path.extname(targetFile).toLowerCase();
  if (!ALLOWED_EXTENSIONS.has(ext)) {
    return res.status(400).json({ error: 'File type not allowed' });
  }

  // Comprobar que el archivo existe y es un archivo regular
  fs.stat(targetFile, (statErr, stats) => {
    if (statErr) {
      if (statErr.code === 'ENOENT') {
        return res.status(404).json({ error: 'File not found' });
      }
      console.error('Error stating file:', statErr);
      return res.status(500).json({ error: 'Internal error' });
    }

    if (!stats.isFile()) {
      return res.status(400).json({ error: 'Target is not a file' });
    }

    // Borrado seguro dentro del directorio controlado
    fs.unlink(targetFile, (err) => {
      if (err) {
        console.error('Error deleting file:', err);
        return res.status(500).json({ error: 'Could not delete file' });
      }

      return res.json({ success: true, deleted: path.basename(targetFile) });
    });
  });
});

app.listen(3000, () => {
  console.log('Safe debug server listening on port 3000');
});
}