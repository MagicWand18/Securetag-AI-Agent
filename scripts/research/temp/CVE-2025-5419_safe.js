const http = require('http');
const { JSDOM } = require('jsdom');

// Versión segura: NO ejecuta directamente JS proveniente del HTML del usuario.
// En lugar de eval, se realiza un análisis limitado y se extraen solo datos
// permitidos (por ejemplo, configuración en JSON dentro de un <script type="application/json">).

function extractConfigFromHtml(html) {
  const dom = new JSDOM(html);
  const scripts = dom.window.document.querySelectorAll('script[type="application/json"]');

  // Solo se permite un script de configuración JSON bien formado
  if (scripts.length === 0) {
    return {};
  }

  const raw = scripts[0].textContent || '';

  // Validación estricta: solo JSON, sin ejecución de código
  try {
    const parsed = JSON.parse(raw);

    // Whitelist de campos permitidos
    const safeConfig = {};
    if (typeof parsed.theme === 'string') {
      safeConfig.theme = parsed.theme;
    }
    if (typeof parsed.debug === 'boolean') {
      safeConfig.debug = parsed.debug;
    }

    return safeConfig;
  } catch (e) {
    // Si el JSON es inválido, se ignora
    return {};
  }
}

const server = http.createServer((req, res) => {
  if (req.method !== 'POST') {
    res.writeHead(405, { 'Content-Type': 'text/plain' });
    return res.end('Use POST with HTML body');
  }

  let body = '';
  req.on('data', (chunk) => {
    body += chunk;
  });

  req.on('end', () => {
    try {
      const userHtml = body.toString('utf8');

      // En lugar de ejecutar JS, solo se extrae configuración declarativa segura
      const config = extractConfigFromHtml(userHtml);

      // Lógica de negocio que usa la configuración de forma controlada
      const responsePayload = {
        status: 'ok',
        appliedTheme: config.theme || 'default',
        debugMode: !!config.debug
      };

      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify(responsePayload));
    } catch (e) {
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: e.message }));
    }
  });
});

server.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
