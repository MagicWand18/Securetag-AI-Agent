const express = require('express');
const { spawn } = require('child_process');

const app = express();
app.use(express.json());

// Lista blanca de tareas permitidas (similar a limitar los DAGs/tareas ejecutables)
const ALLOWED_TASKS = new Set(['task_a', 'task_b', 'task_c']);

// Validación estricta de parámetros adicionales permitidos
function sanitizeParams(rawParams) {
  if (!rawParams) return [];

  // Solo permitimos un objeto con claves/valores simples que se traducen
  // a flags bien definidos, sin permitir comandos arbitrarios.
  if (typeof rawParams !== 'object' || Array.isArray(rawParams)) {
    return [];
  }

  const args = [];

  // Ejemplo: { dry_run: true, retries: 3 } -> ['--dry_run', '--retries', '3']
  if (rawParams.dry_run === true) {
    args.push('--dry_run');
  }

  if (Number.isInteger(rawParams.retries) && rawParams.retries >= 0 && rawParams.retries <= 10) {
    args.push('--retries', String(rawParams.retries));
  }

  return args;
}

app.post('/trigger_task', (req, res) => {
  const { task_id, params } = req.body || {};

  if (!task_id) {
    return res.status(400).json({ error: 'task_id requerido' });
  }

  // Validar que la tarea esté en una lista blanca conocida
  if (!ALLOWED_TASKS.has(task_id)) {
    return res.status(400).json({ error: 'task_id no permitido' });
  }

  // Construir argumentos de forma segura, sin concatenar cadenas de shell
  const baseArgs = ['run', 'example_dag', task_id];
  const extraArgs = sanitizeParams(params);
  const finalArgs = baseArgs.concat(extraArgs);

  console.log('[DEBUG] Ejecutando comando seguro:', 'airflow', finalArgs.join(' '));

  // Uso de spawn con lista de argumentos, evitando el intérprete de comandos
  const child = spawn('airflow', finalArgs, { shell: false });

  let stdout = '';
  let stderr = '';

  child.stdout.on('data', (data) => {
    stdout += data.toString();
  });

  child.stderr.on('data', (data) => {
    stderr += data.toString();
  });

  child.on('error', (err) => {
    console.error('Error al lanzar proceso:', err);
    return res.status(500).json({ error: 'Fallo al ejecutar tarea' });
  });

  child.on('close', (code) => {
    if (code !== 0) {
      console.error('Proceso terminó con código no cero:', code);
      return res.status(500).json({
        error: 'Tarea falló',
        exitCode: code,
        stderr
      });
    }

    res.json({
      message: 'Tarea ejecutada correctamente',
      command: {
        executable: 'airflow',
        args: finalArgs
      },
      stdout,
      stderr
    });
  });
});

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
