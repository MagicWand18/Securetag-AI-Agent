rules:
  - id: synthetic-cve202120124
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >-
      Posible Path Traversal (CVE-2021-20124): se construye una ruta de archivo a
      partir de entrada controlada por el usuario (p.ej., req.query/req.params)
      usando path.join/resolve/normalize y luego se lee el archivo (fs.readFile,
      etc.) sin validar que permanezca dentro de un directorio base. Esto permite
      usar secuencias como "../" para leer archivos arbitrarios (alta probabilidad
      de explotaciÃ³n).
    metadata:
      cwe: "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
      owasp: "A01:2021 - Broken Access Control"
      category: security
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2021-20124"
    patterns:
      - pattern-inside: |
          $APP.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          })
      - metavariable-regex:
          metavariable: $METHOD
          regex: "^(get|post|put|delete|patch|all|use)$"
      - pattern-either:
          - pattern: |
              $P = $PATH.join($BASE, $REQ.query.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.join($BASE, $REQ.params.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.join($BASE, $REQ.body.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.resolve($BASE, $REQ.query.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.resolve($BASE, $REQ.params.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.resolve($BASE, $REQ.body.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.normalize($REQ.query.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.normalize($REQ.params.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.normalize($REQ.body.$Q);
              ...
              $FS.readFile($P, ...);
          - pattern: |
              $P = $PATH.join($BASE, $FILE);
              ...
              $FS.readFile($P, ...);
      - pattern-either:
          - pattern-inside: |
              $FILE = $REQ.query.$Q;
              ...
          - pattern-inside: |
              $FILE = $REQ.params.$Q;
              ...
          - pattern-inside: |
              $FILE = $REQ.body.$Q;
              ...
      - pattern-either:
          - pattern: $FS.readFile($P, ...)
          - pattern: $FS.readFileSync($P, ...)
          - pattern: $FS.createReadStream($P, ...)
          - pattern: $FS.promises.readFile($P, ...)
          - pattern: $RES.sendFile($P, ...)
          - pattern: $RES.sendFile($PATH.join($BASE, $REQ.query.$Q), ...)
          - pattern: $RES.sendFile($PATH.join($BASE, $REQ.params.$Q), ...)
          - pattern: $RES.sendFile($PATH.join($BASE, $REQ.body.$Q), ...)
      - pattern-not-inside: |
          if (!$P.startsWith($BASE)) {
            ...
          }
      - pattern-not-inside: |
          if (!$P.startsWith($PATH.resolve($BASE))) {
            ...
          }
      - pattern-not-inside: |
          if (!$P.includes("..")) {
            ...
          }