rules:
  - id: synthetic-cve202120124
    languages: [javascript, typescript]
    message: >
      Posible vulnerabilidad de Path Traversal (CVE-2021-20124): se construye una ruta de fichero
      a partir de datos controlados por el usuario y se sirve directamente (por ejemplo, con
      res.download). Un atacante puede enviar valores como "../../etc/passwd" para escapar del
      directorio base y leer ficheros arbitrarios. Dado el alto porcentaje de explotación
      observado (≈94.1%), se recomienda validar y normalizar la ruta, restringiéndola a un
      directorio permitido y evitando secuencias de subida de directorio.
    severity: ERROR
    metadata:
      cve: "CVE-2021-20124"
      source: "CISA_KEV"
      category: security
      technology: [express, nodejs]
      likelihood: HIGH
      impact: HIGH
      vulnerability_class: path-traversal
    patterns:
      - pattern-inside: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          })
      - pattern-either:
          - pattern: |
              const $FILE_PARAM = $REQ.query.$KEY;
              ...
              const $FILE_PATH = path.join($BASE_DIR, $FILE_PARAM);
              ...
              $RES.download($FILE_PATH, ...);
          - pattern: |
              const $FILE_PARAM = $REQ.params.$KEY;
              ...
              const $FILE_PATH = path.join($BASE_DIR, $FILE_PARAM);
              ...
              $RES.download($FILE_PATH, ...);
          - pattern: |
              const $FILE_PARAM = $REQ.$ANY.$KEY;
              ...
              const $FILE_PATH = path.join($BASE_DIR, $FILE_PARAM);
              ...
              fs.stat($FILE_PATH, ($ERR, $STATS) => {
                ...
                $RES.download($FILE_PATH, ...);
              });