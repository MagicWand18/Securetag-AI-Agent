const http = require('http');
const fs = require('fs');
const libxmljs = require('libxmljs'); // Biblioteca que permite XXE si no se configura bien

// Servidor HTTP sencillo que recibe XML y lo procesa
const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/process-xml') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      try {
        // VULNERABLE: se parsea XML de entrada del usuario sin deshabilitar entidades externas
        // Un atacante autenticado puede enviar un XML con una XXE para leer archivos locales
        const xmlDoc = libxmljs.parseXml(body); // XXE posible aquí

        const root = xmlDoc.root();
        const responseData = {
          rootName: root.name(),
          text: root.text()
        };

        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify(responseData));
      } catch (err) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Invalid XML', details: err.message }));
      }
    });
  } else if (req.method === 'GET' && req.url === '/') {
    // Página simple para enviar XML de prueba
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end(`
      <html>
        <body>
          <h1>XML Processor (Vulnerable XXE)</h1>
          <form method="POST" action="/process-xml">
            <textarea name="xml" rows="10" cols="60"><root>test</root></textarea><br/>
            <button type="submit">Enviar</button>
          </form>
          <p>Este ejemplo parsea el XML directamente sin deshabilitar entidades externas.</p>
        </body>
      </html>
    `);
  } else if (req.method === 'POST' && req.url === '/process-xml') {
    // Nota: este bloque está duplicado a propósito para mantener el ejemplo simple
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('Not found');
  }
});

server.listen(3000, () => {
  console.log('Vulnerable XXE server listening on http://localhost:3000');
});

/*
Ejemplo de payload XXE que un atacante podría enviar en el cuerpo de la petición:

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>

Esto intentará leer /etc/passwd en el servidor.
*/
