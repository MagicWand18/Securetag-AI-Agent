const http = require('http');
const fs = require('fs');
const xml2js = require('xml2js');

// Servidor HTTP sencillo que recibe XML y lo procesa de forma INSEGURA
// Vulnerabilidad: XXE (XML External Entity)

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/process-xml') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      // Uso directo de xml2js sin deshabilitar entidades externas
      // En algunas configuraciones/parsers XML, esto puede permitir XXE
      const parser = new xml2js.Parser({
        explicitArray: false,
        // Configuración por defecto insegura en algunos entornos/parsers XML
        // No se restringen entidades externas ni DTD
      });

      parser.parseString(body, (err, result) => {
        if (err) {
          res.statusCode = 400;
          return res.end('XML inválido');
        }

        // Ejemplo: se espera un XML como:
        // <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
        // <request><user>&xxe;</user></request>
        // Un parser vulnerable podría resolver &xxe; y exfiltrar contenido local

        const username = result.request && result.request.user;

        // Simula uso de datos procesados
        fs.appendFile('users.log', `Usuario: ${username}\n`, () => {});

        res.statusCode = 200;
        res.setHeader('Content-Type', 'application/json');
        res.end(JSON.stringify({
          status: 'ok',
          user: username
        }));
      });
    });
  } else {
    res.statusCode = 404;
    res.end('Not found');
  }
});

server.listen(3000, () => {
  console.log('Servidor inseguro escuchando en http://localhost:3000');
});
