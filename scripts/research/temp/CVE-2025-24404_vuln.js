const express = require('express');
const axios = require('axios');
const xml2js = require('xml2js');

// Simula un endpoint interno que permite a un usuario autenticado
// registrar un "monitor" que consume un sitemap XML remoto.
// El contenido XML se parsea sin restricciones, lo que permite
// XML Injection / XXE y potencial RCE en algunos parsers/entornos.

const app = express();
app.use(express.json());

// Middleware de autenticación SIMPLIFICADO (no seguro, solo para ejemplo)
function fakeAuth(req, res, next) {
  const token = req.headers['x-auth-token'];
  if (!token || token !== 'valid-token') {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
}

// Vulnerable: parsea XML remoto controlado por el usuario sin restricciones
app.post('/monitors', fakeAuth, async (req, res) => {
  try {
    const { sitemapUrl } = req.body;
    if (!sitemapUrl) {
      return res.status(400).json({ error: 'sitemapUrl is required' });
    }

    // El usuario autenticado controla la URL del sitemap
    const response = await axios.get(sitemapUrl, { timeout: 5000 });
    const xmlContent = response.data;

    // USO VULNERABLE: xml2js.parseString sin desactivar entidades externas
    // ni limitar el tamaño/estructura del XML.
    const parser = new xml2js.Parser({
      // configuración por defecto: permite entidades externas en algunos parsers
      // y no limita el tamaño de expansión de entidades.
    });

    parser.parseString(xmlContent, (err, result) => {
      if (err) {
        return res.status(500).json({ error: 'Failed to parse XML' });
      }

      // Simula que se extraen URLs del sitemap y se registran como "jobs".
      const urls = [];
      if (result.urlset && Array.isArray(result.urlset.url)) {
        result.urlset.url.forEach((u) => {
          if (u.loc && u.loc[0]) {
            urls.push(u.loc[0]);
          }
        });
      }

      // En una implementación real, aquí podrían ejecutarse comandos,
      // plantillas o scripts basados en datos del XML, amplificando el impacto.

      return res.json({
        message: 'Monitor created (VULNERABLE XML parsing)',
        sitemapUrl,
        urls
      });
    });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
});

app.listen(3000, () => {
  console.log('Vulnerable server listening on port 3000');
});
