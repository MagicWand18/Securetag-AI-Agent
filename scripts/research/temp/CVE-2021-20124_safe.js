const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = 3000;

// Directorio base de ficheros permitidos
const BASE_DIR = path.resolve('/var/app/files');

// Lista blanca opcional de extensiones permitidas
const ALLOWED_EXTENSIONS = new Set(['.pdf', '.txt', '.csv', '.log']);

// Endpoint seguro de descarga de ficheros
app.get('/download', (req, res) => {
  const fileParam = req.query.file; // p.ej. ?file=report.pdf

  if (!fileParam) {
    return res.status(400).send('Missing file parameter');
  }

  // Normalizar el nombre del fichero: no se permite ruta, solo nombre base
  const fileName = path.basename(fileParam);

  // Validar extensión contra lista blanca
  const ext = path.extname(fileName).toLowerCase();
  if (!ALLOWED_EXTENSIONS.has(ext)) {
    return res.status(400).send('File type not allowed');
  }

  // Construir la ruta absoluta y asegurar que permanece dentro de BASE_DIR
  const resolvedPath = path.resolve(BASE_DIR, fileName);

  // Comprobación crítica: evitar path traversal verificando el prefijo
  if (!resolvedPath.startsWith(BASE_DIR + path.sep)) {
    return res.status(403).send('Access denied');
  }

  fs.stat(resolvedPath, (err, stats) => {
    if (err || !stats.isFile()) {
      return res.status(404).send('File not found');
    }

    res.download(resolvedPath, fileName, (downloadErr) => {
      if (downloadErr) {
        console.error('Download error:', downloadErr);
        if (!res.headersSent) {
          res.status(500).send('Error downloading file');
        }
      }
    });
  });
});

app.listen(PORT, () => {
  console.log(`Safe file download server listening on port ${PORT}`);
});
}