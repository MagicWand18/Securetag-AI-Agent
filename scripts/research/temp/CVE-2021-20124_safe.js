const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();

// Versión segura: restringe la descarga a un directorio permitido y bloquea traversal.
app.get('/WebServlet', (req, res) => {
  const action = req.query.action;
  if (action !== 'download') return res.status(400).send('Invalid action');

  const fileParam = req.query.file;
  if (!fileParam) return res.status(400).send('Missing file');

  const baseDir = path.resolve(__dirname, 'downloads');

  // Normaliza y resuelve a ruta absoluta dentro del baseDir
  // Nota: antepone '.' para evitar que rutas absolutas del usuario ignoren baseDir.
  const candidatePath = path.resolve(baseDir, '.' + path.sep + fileParam);

  // ✅ Mitigación principal: asegurar que candidatePath permanezca dentro de baseDir
  if (!candidatePath.startsWith(baseDir + path.sep)) {
    return res.status(403).send('Forbidden');
  }

  // (Opcional) permitir solo nombres de archivo simples (defensa en profundidad)
  // if (path.basename(candidatePath) !== fileParam) return res.status(400).send('Invalid filename');

  fs.stat(candidatePath, (err, st) => {
    if (err || !st.isFile()) return res.status(404).send('Not found');

    res.setHeader('Content-Type', 'application/octet-stream');
    res.sendFile(candidatePath);
  });
});

app.listen(3000, () => console.log('Listening on http://localhost:3000'));
