const http = require('http');
const url = require('url');
const fs = require('fs');
const path = require('path');

// Versión segura del mismo servidor, corrigiendo la LFI / Path Traversal
// Medidas de mitigación:
// 1. Lista blanca de plantillas permitidas (portal_type permitido).
// 2. Normalización de ruta y verificación de que permanece dentro del directorio base.
// 3. Restricción de extensión a .php (o lo que aplique) y mapeo a plantillas internas.

const ALLOWED_PORTALS = {
  'default': 'default.php',
  'support': 'support.php',
  'faq': 'faq.php'
};

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (parsedUrl.pathname === '/helpdesk/portal') {
    // Normalizamos el valor de portal_type a una clave de lista blanca
    const rawPortalType = (parsedUrl.query.portal_type || 'default').toString();

    // Usar lista blanca: si no está permitido, usar una plantilla segura por defecto
    const mappedFile = ALLOWED_PORTALS[rawPortalType];
    if (!mappedFile) {
      res.statusCode = 400;
      return res.end('Invalid portal type');
    }

    const baseDir = path.join(__dirname, 'portals');

    // Construimos la ruta solo a partir de valores controlados internamente
    const targetFile = path.join(baseDir, mappedFile);

    // Defensa adicional: asegurarse de que la ruta resultante sigue dentro de baseDir
    const normalizedBase = path.resolve(baseDir);
    const normalizedTarget = path.resolve(targetFile);

    if (!normalizedTarget.startsWith(normalizedBase + path.sep)) {
      res.statusCode = 403;
      return res.end('Access denied');
    }

    // Opcional: verificar extensión
    if (path.extname(normalizedTarget) !== '.php') {
      res.statusCode = 400;
      return res.end('Invalid file type');
    }

    fs.readFile(normalizedTarget, 'utf8', (err, data) => {
      if (err) {
        res.statusCode = 500;
        return res.end('Error loading portal');
      }

      // En un entorno real, en lugar de "incluir" código arbitrario, se debería
      // usar un motor de plantillas seguro o renderizar contenido estático.
      res.statusCode = 200;
      res.setHeader('Content-Type', 'text/html; charset=utf-8');
      res.end(data);
    });
  } else {
    res.statusCode = 404;
    res.end('Not found');
  }
});

server.listen(3001, () => {
  console.log('Safe helpdesk portal listening on http://localhost:3001');
});
