rules:
  - id: synthetic-cve202563525
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible control de acceso roto (CVE-2025-63525): este handler de ruta
      permite operaciones sensibles (por ejemplo, borrado de recursos) para
      cualquier usuario autenticado sin verificar el rol (hospital vs user) ni
      la pertenencia del recurso al propietario. En el exploit real de
      Blood Bank Management System 1.0, un usuario con rol "user" puede
      reutilizar la sesión para invocar delete.php y borrar muestras de sangre
      de hospitales, escalando privilegios. Asegúrate de validar explícitamente
      el rol y la propiedad del recurso antes de ejecutar la operación.
    patterns:
      - pattern-inside: |
          $APP.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          });
      - pattern-either:
          # 1) Operaciones de borrado/actualización sin comprobación de rol
          - patterns:
              - pattern: |
                  if (!$REQ.session.user) {
                    return $RES.$STATUS(...);
                  }
              - pattern-not: |
                  if (!$REQ.session.user || $REQ.session.user.role !== $ROLE) {
                    return $RES.$STATUS(...);
                  }
              - pattern-either:
                  - pattern: |
                      const $ID = parseInt($REQ.query.$PARAM, ...);
                  - pattern: |
                      const $ID = $REQ.query.$PARAM;
                  - pattern: |
                      const $ID = parseInt($REQ.body.$PARAM, ...);
                  - pattern: |
                      const $ID = $REQ.body.$PARAM;
              - pattern-either:
                  - pattern: |
                      $COLLECTION.findIndex($F => $F.id === $ID)
                  - pattern: |
                      $COLLECTION.findIndex(($F) => $F.id === $ID)
              - pattern: |
                  const $INDEX = $COLLECTION.findIndex(...);
              - pattern: |
                  if ($INDEX === -1) {
                    return $RES.$STATUS(...);
                  }
              - pattern-either:
                  - pattern: |
                      const $DELETED = $COLLECTION.splice($INDEX, 1)[0];
                  - pattern: |
                      $COLLECTION.splice($INDEX, 1);
          # 2) Listado de recursos sensibles sin filtrado por propietario/rol
          - patterns:
              - pattern: |
                  if (!$REQ.session.user) {
                    return $RES.$STATUS(...);
                  }
              - pattern-either:
                  - pattern: |
                      $RES.json({ $KEY: $COLLECTION });
                  - pattern: |
                      $RES.send({ $KEY: $COLLECTION });
                  - pattern: |
                      $RES.json($COLLECTION);
                  - pattern: |
                      $RES.send($COLLECTION);
    metadata:
      cwe: "CWE-284: Improper Access Control"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2025-63525"