const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const app = express();

// Carpeta pública donde se guardan los "avatares" de usuario
const uploadDir = path.join(__dirname, 'public', 'avatars');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

// Configuración básica de multer (SIN validación en servidor)
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    // Usa el nombre original del archivo (incluyendo extensión controlada por el usuario)
    cb(null, Date.now() + '-' + file.originalname);
  }
});

const upload = multer({ storage });

// Ruta de creación de usuario con subida de imagen de perfil
// Vulnerabilidad análoga a CVE-2025-55743:
// - Solo se confía en la validación del lado cliente (p.ej. HTML accept="image/*")
// - El servidor NO valida tipo MIME ni contenido real del archivo
// - El archivo se guarda en una ruta servida públicamente
app.post('/users', upload.single('avatar'), (req, res) => {
  const { username, email } = req.body;

  // El cliente "supuestamente" solo sube imágenes, pero un atacante
  // puede capturar la petición (Burp, etc.) y cambiar extensión y contenido
  // a un script .php, .js, etc.

  // Ejemplo de uso inseguro: confiar en req.file.mimetype sin verificar
  console.log('Archivo subido:', {
    originalname: req.file.originalname,
    mimetype: req.file.mimetype, // controlable por el cliente
    path: req.file.path
  });

  // Aquí se podría guardar el usuario en BD junto con la ruta del avatar
  // (omitido por simplicidad)

  res.json({
    message: 'Usuario creado (inseguro): avatar almacenado sin validación en servidor',
    avatarPath: '/avatars/' + path.basename(req.file.path)
  });
});

app.listen(3000, () => {
  console.log('Servidor inseguro escuchando en http://localhost:3000');
});
