const express = require('express');
const session = require('express-session');
const bodyParser = require('body-parser');

// Simulación de "base de datos" en memoria
const bloodSamples = [
  { id: 1, type: 'A+', hospitalId: 10 },
  { id: 2, type: 'O-', hospitalId: 10 },
  { id: 3, type: 'B+', hospitalId: 20 }
];

const app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

app.use(session({
  secret: 'insecure-secret',
  resave: false,
  saveUninitialized: true
}));

// Login muy simplificado: solo establece el rol en sesión
app.post('/login', (req, res) => {
  const { username, role } = req.body; // role: 'hospital' o 'user'
  req.session.user = { username, role, hospitalId: role === 'hospital' ? 10 : null };
  res.json({ msg: 'logged in', user: req.session.user });
});

// Listado de muestras de sangre (solo para hospital, pero con control deficiente)
app.get('/bloodinfo', (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  // VULNERABILIDAD: no se valida correctamente el rol ni la pertenencia de los datos
  // Cualquier usuario autenticado puede ver todas las muestras
  res.json({ samples: bloodSamples });
});

// Endpoint vulnerable que simula delete.php
app.get('/delete', (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ error: 'Not authenticated' });
  }

  const id = parseInt(req.query.id, 10);

  // VULNERABILIDAD PRINCIPAL (Broken Access Control / Privilege Escalation):
  // 1. No se comprueba el rol del usuario (hospital vs user)
  // 2. No se comprueba si la muestra pertenece al hospital del usuario
  // 3. Se confía únicamente en que la petición venga autenticada

  const index = bloodSamples.findIndex(s => s.id === id);
  if (index === -1) {
    return res.status(404).json({ error: 'Sample not found' });
  }

  const deleted = bloodSamples.splice(index, 1)[0];

  // Mensaje similar al del sistema vulnerable
  res.json({ msg: 'You have deleted one blood sample.', deleted });
});

app.listen(8080, () => {
  console.log('Vulnerable Blood Bank app listening on port 8080');
});
