const express = require('express');
const fs = require('fs');
const path = require('path');
const he = require('he'); // npm install he

// Ejemplo corregido: se escapa el contenido ICS antes de insertarlo en el HTML

const app = express();
const PORT = 3001;

// Función de escape mínima (si no se quiere usar librerías externas)
// Aquí usamos 'he' para mayor robustez.
function sanitizeIcsText(text) {
  // 1) Normalizar saltos de línea ICS (\n, \r\n) a <br> seguros
  // 2) Escapar todo el contenido para que se trate como texto, no HTML
  const normalized = text.replace(/\\n|\r\n|\n/g, '\n');
  const escaped = he.encode(normalized, {
    useNamedReferences: true,
    allowUnsafeSymbols: false
  });
  // Convertir saltos de línea a <br> ya escapados
  return escaped.replace(/\n/g, '<br>');
}

app.get('/view-invite', (req, res) => {
  const icsPath = path.join(__dirname, 'invite.ics');

  fs.readFile(icsPath, 'utf8', (err, data) => {
    if (err) {
      return res.status(500).send('Error leyendo ICS');
    }

    const match = data.match(/DESCRIPTION:(.*)/);
    const rawDescription = match ? match[1] : 'Sin descripción';

    // SANITIZACIÓN: escapamos el contenido antes de insertarlo en el HTML
    const safeDescription = sanitizeIcsText(rawDescription);

    const html = `
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>Invitación de calendario</title>
        </head>
        <body>
          <h1>Invitación</h1>
          <p><strong>Descripción:</strong></p>
          <!-- Ahora el contenido se muestra como texto, no se ejecuta -->
          <div class="invite-description">${safeDescription}</div>

          <!-- Incluso si el ICS intenta inyectar atributos como ontoggle, -->
          <!-- llegarán escapados (&lt;div ontoggle=...) y no se ejecutarán. -->
          <details open class="invite-details">
            <summary>Detalles</summary>
            ${safeDescription}
          </details>
        </body>
      </html>
    `;

    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.send(html);
  });
});

app.listen(PORT, () => {
  console.log(`Servidor seguro escuchando en http://localhost:${PORT}`);
});
