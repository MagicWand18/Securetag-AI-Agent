const express = require('express');
const fs = require('fs');
const path = require('path');
const he = require('he'); // npm install he

// Versión segura: escapa/sanitiza el contenido HTML proveniente del ICS

const app = express();
const PORT = 3001;

app.use(express.urlencoded({ extended: true }));

app.get('/view-ics', (req, res) => {
  const icsFile = req.query.file || 'invite.ics';
  const icsPath = path.join(__dirname, 'uploads', icsFile);

  if (!fs.existsSync(icsPath)) {
    return res.status(404).send('ICS file not found');
  }

  const icsContent = fs.readFileSync(icsPath, 'utf8');

  // Extrae la pseudo-descripción del ICS (igual que antes)
  const descriptionMatch = icsContent.match(/DESCRIPTION:(.*)/);
  const rawDescription = descriptionMatch ? descriptionMatch[1] : 'No description';

  // --- PARTE SEGURA ---
  // En lugar de insertar HTML sin control, escapamos el contenido para que
  // se trate como texto y no como código ejecutable.
  // Esto neutraliza atributos como ontoggle, onclick, <script>, etc.

  const safeDescription = he.encode(rawDescription, {
    useNamedReferences: true
  });

  const html = `
    <!DOCTYPE html>
    <html lang="es">
    <head>
      <meta charset="UTF-8" />
      <title>Invitación ICS (segura)</title>
    </head>
    <body>
      <h1>Detalle de la invitación</h1>
      <div id="description">
        ${safeDescription}
      </div>
      <p>El contenido de la invitación ha sido escapado para evitar XSS.</p>
    </body>
    </html>
  `;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
});

app.listen(PORT, () => {
  console.log(`Servidor seguro escuchando en http://localhost:${PORT}`);
});
