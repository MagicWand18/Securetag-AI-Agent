const express = require('express');
const bodyParser = require('body-parser');
const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

// Versión segura que evita la inyección de comandos OS

const app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

// Lista blanca opcional de extensiones permitidas
const ALLOWED_EXTENSIONS = ['.txt', '.tpl', '.conf'];

app.post('/ajaxAddTemplate', (req, res) => {
  const fileName = req.body.fileName;

  if (typeof fileName !== 'string' || fileName.length === 0) {
    return res.status(400).send('Nombre de archivo inválido');
  }

  // Normalizar y validar el nombre de archivo para evitar traversal y caracteres peligrosos
  const baseName = path.basename(fileName); // elimina rutas como ../../etc/passwd
  const ext = path.extname(baseName).toLowerCase();

  if (!ALLOWED_EXTENSIONS.includes(ext)) {
    return res.status(400).send('Extensión de archivo no permitida');
  }

  const srcDir = '/var/templates';
  const dstDir = '/var/app/templates';

  const srcPath = path.join(srcDir, baseName);
  const dstPath = path.join(dstDir, baseName);

  // Comprobar que el archivo fuente existe
  if (!fs.existsSync(srcPath)) {
    return res.status(404).send('La plantilla origen no existe');
  }

  // USO SEGURO: no se construye un comando de shell, se usan argumentos separados
  // y se llama directamente al binario del sistema (sin pasar por un intérprete de comandos).
  const cp = spawn('cp', [srcPath, dstPath], {
    shell: false
  });

  cp.on('error', (err) => {
    console.error('Error al lanzar cp:', err);
    return res.status(500).send('Error al añadir la plantilla');
  });

  cp.on('close', (code) => {
    if (code !== 0) {
      console.error('cp terminó con código:', code);
      return res.status(500).send('Error al añadir la plantilla');
    }
    res.send('Plantilla añadida correctamente');
  });
});

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
