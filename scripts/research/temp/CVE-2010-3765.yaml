rules:
  - id: synthetic-cve20103765
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Código HTML/JS controlado por el usuario se escribe en un archivo temporal y se abre
      automáticamente en un navegador mediante una llamada a 'exec'. Esto permite que un atacante
      ejecute JavaScript arbitrario en el motor del navegador, haciendo explotables vulnerabilidades
      del motor como CVE-2010-3765 (nsCSSFrameConstructor / manejo interno de frames en Firefox).
      No abras contenido HTML/JS no confiable en navegadores (especialmente versiones antiguas)
      sin validación, aislamiento o sandboxing.
    metadata:
      cve: "CVE-2010-3765"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "javascript"]
      likelihood: "high"
      impact: "high"
    patterns:
      - pattern-either:
          # Patrón 1: flujo completo típico (req -> body -> writeFileSync -> exec navegador)
          - pattern: |
              const http = require('http');
              ...
              $SVR = http.createServer(($REQ, $RES) => {
                ...
                $REQ.on('end', () => {
                  ...
                  $FS = require('fs');
                  ...
                  $FS.writeFileSync($TMP, $BODY, ...);
                  ...
                  const { exec } = require('child_process');
                  exec($CMD, ...);
                  ...
                });
              });
          # Patrón 2: más genérico: escribir contenido controlado por la request y abrirlo con navegador
          - pattern: |
              $REQ.on('end', () => {
                ...
                $FS.writeFileSync($TMP, $BODY, ...);
                ...
                exec($CMD, ...);
              });
      - pattern-inside: |
          const { exec } = require('child_process');
          ...
          $REQ.on('data', $CHUNK => {
            $BODY += $CHUNK.toString();
          });
          ...
          $REQ.on('end', () => {
            ...
          });
      - pattern-regex: '(firefox|seamonkey|thunderbird)'
      - pattern-not-regex: 'headless|--safe-mode|--private'
    fix: >
      No abras directamente en un navegador archivos generados a partir de contenido HTML/JS
      controlado por el usuario. En su lugar, valida/filtra estrictamente el contenido, evita
      usar navegadores vulnerables, o procesa el contenido en un entorno aislado (sandbox) sin
      capacidades de ejecución activa de JavaScript.