const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.json());

// Función para neutralizar fórmulas en campos de texto para CSV
// Estrategia típica: si empieza por =, +, -, @, tab o coma, se antepone un apóstrofo (')
function sanitizeForCsvFormula(value) {
  if (typeof value !== 'string') return value;

  // Caracteres peligrosos al inicio de la celda
  const dangerousPrefixes = ['=', '+', '-', '@'];

  // Si empieza con espacio, tab o coma también puede ser problemático en algunos visores
  const firstChar = value.charAt(0);
  if (dangerousPrefixes.includes(firstChar) || firstChar === '\t' || firstChar === ',') {
    return "'" + value; // Prefijo seguro
  }

  return value;
}

// Ruta de "exportación rápida" segura frente a CSV/Formula Injection
app.post('/quick-export', (req, res) => {
  const products = req.body.products || [];

  let csv = 'id,name,description,price\n';

  products.forEach(p => {
    const id = p.id || '';

    // Sanitizar campos de texto que irán a celdas de Excel
    let name = p.name || '';
    let description = p.description || '';

    name = sanitizeForCsvFormula(name);
    description = sanitizeForCsvFormula(description);

    // Escapar comillas dobles para CSV estándar
    name = name.replace(/"/g, '""');
    description = description.replace(/"/g, '""');

    const price = p.price || '';

    csv += `${id},"${name}","${description}",${price}\n`;
  });

  const filePath = path.join(__dirname, 'export.csv');
  fs.writeFile(filePath, csv, (err) => {
    if (err) {
      return res.status(500).json({ error: 'Error generating CSV' });
    }

    res.setHeader('Content-Type', 'text/csv');
    res.setHeader('Content-Disposition', 'attachment; filename="export.csv"');
    fs.createReadStream(filePath).pipe(res);
  });
});

app.listen(3000, () => {
  console.log('Safe CSV export server running on port 3000');
});
}