const express = require('express');
const bodyParser = require('body-parser');

// Simulación de almacenamiento de preferencias por usuario
// userId -> { deceptiveAppScanning: boolean, role: 'primary' | 'secondary' }
const userSettings = new Map();

// Inicializamos un usuario primario y uno secundario en el mismo dispositivo
userSettings.set('primaryUser', {
  deceptiveAppScanning: true,
  role: 'primary'
});

userSettings.set('secondaryUser', {
  deceptiveAppScanning: false,
  role: 'secondary'
});

const app = express();
app.use(bodyParser.json());

// Función que simula obtener el usuario "actual" desde un header
function getCurrentUserId(req) {
  // En un entorno real esto vendría de un token de sesión / JWT / etc.
  return req.headers['x-user-id'];
}

// Función auxiliar segura: verifica que el usuario actual sea primario
function assertPrimaryUser(req, res) {
  const currentUserId = getCurrentUserId(req);
  const currentUser = userSettings.get(currentUserId);

  if (!currentUser) {
    res.status(401).json({ error: 'Usuario no autenticado' });
    return null;
  }

  if (currentUser.role !== 'primary') {
    // Control de acceso estricto: solo el usuario primario puede cambiar
    // la configuración de protección global.
    res.status(403).json({
      error: 'Acceso denegado: solo el usuario primario puede modificar esta configuración'
    });
    return null;
  }

  return { currentUserId, currentUser };
}

// Endpoint seguro: solo el usuario primario puede actualizar su propia
// preferencia de escaneo de apps engañosas.
app.post('/settings/content-protection/toggle', (req, res) => {
  const auth = assertPrimaryUser(req, res);
  if (!auth) return; // Ya se respondió con el error correspondiente

  const { deceptiveAppScanning } = req.body;

  const primaryUserId = 'primaryUser';
  const primaryUser = userSettings.get(primaryUserId);

  if (!primaryUser) {
    return res.status(500).json({ error: 'Usuario primario no encontrado' });
  }

  // --- LÓGICA CORREGIDA ---
  // Solo el usuario primario puede modificar su propia configuración.
  // No se permite que un usuario secundario cambie esta preferencia.
  primaryUser.deceptiveAppScanning = !!deceptiveAppScanning;

  return res.json({
    message: 'Preferencia de escaneo de apps engañosas actualizada (PRIMARIO)',
    updatedBy: auth.currentUserId,
    primaryUserSettings: primaryUser
  });
});

// Endpoint adicional: cada usuario solo puede ver su propia configuración
app.get('/settings/me', (req, res) => {
  const currentUserId = getCurrentUserId(req);
  const currentUser = userSettings.get(currentUserId);

  if (!currentUser) {
    return res.status(401).json({ error: 'Usuario no autenticado' });
  }

  res.json({ userId: currentUserId, ...currentUser });
});

if (require.main === module) {
  const port = 3001;
  app.listen(port, () => {
    console.log(`Servidor seguro escuchando en http://localhost:${port}`);
    console.log('Usuarios iniciales:', Object.fromEntries(userSettings));
  });
}

module.exports = app;