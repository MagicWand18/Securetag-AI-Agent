const http = require('http');
const fs = require('fs');
const libxmljs = require('libxmljs');

// Función de parseo seguro que rechaza DTD/entidades externas
function parseXmlSafely(xmlString) {
  // En libxmljs no hay un flag directo para deshabilitar DTD, pero podemos:
  // 1) Rechazar cualquier XML que contenga DOCTYPE (donde se definen entidades externas)
  // 2) Opcionalmente, usar un parser que no resuelva entidades externas

  // Validación defensiva: bloquear cualquier DOCTYPE
  if (/<!DOCTYPE/i.test(xmlString)) {
    throw new Error('DOCTYPE is not allowed in XML input');
  }

  // Parseo normal, pero sin permitir DTD en la entrada
  // (ya lo hemos bloqueado manualmente arriba)
  const xmlDoc = libxmljs.parseXml(xmlString, {
    noent: false, // no expandir entidades externas
    dtdload: false, // no cargar DTD externos
    dtdattr: false, // no aplicar atributos por defecto desde DTD
    dtdvalid: false // no validar contra DTD
  });

  return xmlDoc;
}

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/process-xml') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      try {
        // SEGURO: se valida la entrada y se deshabilita el uso de DTD/entidades externas
        const xmlDoc = parseXmlSafely(body);

        const root = xmlDoc.root();
        const responseData = {
          rootName: root.name(),
          text: root.text()
        };

        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify(responseData));
      } catch (err) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Invalid or unsafe XML', details: err.message }));
      }
    });
  } else if (req.method === 'GET' && req.url === '/') {
    res.writeHead(200, { 'Content-Type': 'text/html' });
    res.end(`
      <html>
        <body>
          <h1>XML Processor (Safe XXE)</h1>
          <form method="POST" action="/process-xml">
            <textarea name="xml" rows="10" cols="60"><root>test</root></textarea><br/>
            <button type="submit">Enviar</button>
          </form>
          <p>Este ejemplo bloquea DOCTYPE y deshabilita DTD externos para mitigar XXE.</p>
        </body>
      </html>
    `);
  } else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('Not found');
  }
});

server.listen(3001, () => {
  console.log('Safe XXE server listening on http://localhost:3001');
});
