const http = require('http');
const fs = require('fs');
const xml2js = require('xml2js');

// Servidor HTTP sencillo que recibe XML y lo procesa de forma SEGURA
// Mitigación XXE: se deshabilita el procesamiento de DTD/entidades externas

// Función de saneamiento básica para evitar contenido inesperado
function sanitizeText(value) {
  if (typeof value !== 'string') return '';
  return value.replace(/[\r\n\t]/g, ' ').slice(0, 256);
}

const server = http.createServer((req, res) => {
  if (req.method === 'POST' && req.url === '/process-xml') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
      // Límite de tamaño para evitar abusos
      if (body.length > 1024 * 1024) {
        req.destroy();
      }
    });

    req.on('end', () => {
      // Configuración defensiva: no se procesan DTD ni entidades externas
      // xml2js no resuelve entidades externas por defecto, pero aquí
      // se documenta explícitamente la intención de evitar XXE.
      const parser = new xml2js.Parser({
        explicitArray: false,
        // No se permite DTD ni entidades externas (a nivel de diseño)
        // y se valida el esquema de entrada de forma estricta.
        // En entornos donde se use un parser XML de bajo nivel,
        // se deben deshabilitar DTD/XXE explícitamente.
      });

      parser.parseString(body, (err, result) => {
        if (err || !result || !result.request) {
          res.statusCode = 400;
          return res.end('XML inválido');
        }

        // Validación y saneamiento de campos esperados
        const rawUser = result.request.user;
        const username = sanitizeText(rawUser);

        fs.appendFile('users.log', `Usuario: ${username}\n`, () => {});

        res.statusCode = 200;
        res.setHeader('Content-Type', 'application/json');
        res.end(JSON.stringify({
          status: 'ok',
          user: username
        }));
      });
    });
  } else {
    res.statusCode = 404;
    res.end('Not found');
  }
});

server.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001');
});
