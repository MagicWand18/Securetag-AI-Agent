const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const app = express();
const PORT = process.env.PORT || 3000;

// Carpeta donde se "instalan" paquetes de la aplicación
const APP_PACKAGES_DIR = path.join(__dirname, 'app_packages');
if (!fs.existsSync(APP_PACKAGES_DIR)) {
  fs.mkdirSync(APP_PACKAGES_DIR, { recursive: true });
}

// Configuración de multer SIN validaciones ni autenticación
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    // Directorio fijo, pero sin controles de autenticación ni tipo de archivo
    cb(null, APP_PACKAGES_DIR);
  },
  filename: (req, file, cb) => {
    // Usa el nombre original del archivo sin sanitizar
    cb(null, file.originalname);
  }
});

const upload = multer({ storage });

// Ruta crítica que simula "installAppPackage.php" de J-Web
// VULNERABILIDAD: No requiere autenticación y permite subir archivos arbitrarios
app.post('/installAppPackage', upload.single('package'), (req, res) => {
  if (!req.file) {
    return res.status(400).send('No se envió ningún archivo');
  }

  // No hay validación de tipo de archivo, tamaño, ni contenido
  // No hay control de quién puede llamar a este endpoint
  // Un atacante puede subir cualquier archivo al sistema de ficheros

  console.log('Paquete instalado en:', req.file.path);
  res.send('Paquete instalado correctamente');
});

app.listen(PORT, () => {
  console.log(`Servidor vulnerable escuchando en http://localhost:${PORT}`);
});
