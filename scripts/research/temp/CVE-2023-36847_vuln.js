const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const app = express();
const PORT = 3000;

// --- CONFIGURACIÓN INSEGURA ---
// Directorio donde se "instalan" paquetes de la aplicación
const APP_PACKAGES_DIR = path.join(__dirname, 'app_packages');

if (!fs.existsSync(APP_PACKAGES_DIR)) {
  fs.mkdirSync(APP_PACKAGES_DIR, { recursive: true });
}

// Multer sin validaciones de tipo de archivo ni tamaño
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, APP_PACKAGES_DIR);
  },
  filename: (req, file, cb) => {
    // Usa el nombre original del archivo sin sanitizar
    cb(null, file.originalname);
  }
});

const upload = multer({ storage });

// Ruta que simula installAppPackage.php de J-Web
// VULNERABILIDAD: No requiere autenticación, permite subir archivos arbitrarios
app.post('/installAppPackage.php', upload.single('package'), (req, res) => {
  // No se valida el tipo de archivo, contenido ni origen
  if (!req.file) {
    return res.status(400).send('No se recibió ningún archivo');
  }

  // Se asume que cualquier archivo subido es un "paquete" válido
  console.log(`[VULNERABLE] Paquete instalado: ${req.file.path}`);

  // Respuesta genérica
  res.send('Paquete instalado correctamente (inseguro)');
});

app.listen(PORT, () => {
  console.log(`Servidor vulnerable escuchando en http://localhost:${PORT}`);
});
