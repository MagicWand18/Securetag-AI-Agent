const http = require('http');
const fs = require('fs');
const path = require('path');

// Versión SEGURA: valida y normaliza el nombre de la plantilla

const TEMPLATES_DIR = path.join(__dirname, 'views');

// Lista blanca opcional de plantillas permitidas
const ALLOWED_TEMPLATES = new Set(['home', 'about', 'contact']);

const server = http.createServer((req, res) => {
  const url = new URL(req.url, `http://${req.headers.host}`);
  let templateName = url.searchParams.get('template') || 'home';

  // 1) Normalizar y validar el nombre (solo letras, números, guiones y guiones bajos)
  if (!/^[a-zA-Z0-9_-]+$/.test(templateName)) {
    res.statusCode = 400;
    res.setHeader('Content-Type', 'text/plain; charset=utf-8');
    return res.end('Invalid template name');
  }

  // 2) (Opcional pero más seguro) Verificar contra una lista blanca
  if (!ALLOWED_TEMPLATES.has(templateName)) {
    res.statusCode = 404;
    res.setHeader('Content-Type', 'text/plain; charset=utf-8');
    return res.end('Template not found');
  }

  // 3) Construir la ruta y asegurarse de que permanezca dentro de TEMPLATES_DIR
  const templatePath = path.join(TEMPLATES_DIR, templateName + '.html');
  const normalizedPath = path.normalize(templatePath);

  // Comprobar que la ruta resultante sigue bajo el directorio de vistas
  if (!normalizedPath.startsWith(TEMPLATES_DIR + path.sep)) {
    res.statusCode = 403;
    res.setHeader('Content-Type', 'text/plain; charset=utf-8');
    return res.end('Access denied');
  }

  fs.readFile(normalizedPath, 'utf8', (err, data) => {
    if (err) {
      res.statusCode = 404;
      res.setHeader('Content-Type', 'text/plain; charset=utf-8');
      return res.end('Template not found');
    }

    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.end(data);
  });
});

server.listen(3000, () => {
  console.log('Safe server listening on http://localhost:3000');
});
