const http = require('http');
const vm = require('vm');

// Simula un servicio que "procesa" HTML/JS enviado por el cliente
// VULNERABLE: ejecución directa de código controlado por el usuario

const server = http.createServer((req, res) => {
  if (req.method !== 'POST') {
    res.writeHead(405, { 'Content-Type': 'text/plain' });
    return res.end('Use POST');
  }

  let body = '';
  req.on('data', chunk => {
    body += chunk;
  });

  req.on('end', () => {
    try {
      // El cliente envía un "HTML" que incluye un bloque <script> con JS.
      // Aquí extraemos el contenido del script de forma ingenua y lo ejecutamos.
      // Esto simula un escenario donde un motor JS (como V8) podría ser
      // explotado mediante una página HTML/JS especialmente diseñada.

      const scriptMatch = body.match(/<script[^>]*>([\s\S]*?)<\/script>/i);
      const userScript = scriptMatch ? scriptMatch[1] : '';

      // PATRÓN PELIGROSO: ejecutar código arbitrario controlado por el usuario
      // usando vm.runInNewContext sin restricciones reales.
      // En un entorno real, un bug de type confusion en V8 podría permitir
      // al atacante escapar del sandbox y lograr lectura/escritura arbitraria.

      const sandbox = {
        console,
        result: null,
        buffer: Buffer.alloc(16), // memoria que el atacante podría intentar corromper
      };

      // VULNERABLE: el código del usuario se ejecuta directamente en V8
      // y puede manipular objetos internos, potencialmente explotando
      // vulnerabilidades del motor.
      vm.runInNewContext(userScript, sandbox, {
        timeout: 1000,
        displayErrors: true
      });

      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({
        status: 'ok',
        result: sandbox.result,
        buffer: sandbox.buffer.toString('hex')
      }));
    } catch (err) {
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: err.message }));
    }
  });
});

server.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
