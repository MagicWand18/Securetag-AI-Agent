const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');
const path = require('path');

// Simulación de un "options.php" en Node.js
// Configuración global de la aplicación
let appConfig = {
  allowRegistrations: false,
  uploadDir: path.join(__dirname, 'uploads'),
  adminEmail: 'admin@example.com'
};

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// VULNERABLE: endpoint de configuración sin autenticación ni control de acceso
// Cualquiera puede modificar la configuración de la aplicación mediante peticiones HTTP
app.post('/options', (req, res) => {
  // No se valida el origen, ni el usuario, ni los campos permitidos
  const newOptions = req.body;

  // Mezcla ciega de la configuración recibida con la configuración actual
  appConfig = {
    ...appConfig,
    ...newOptions
  };

  // Persistencia insegura de la configuración en disco
  fs.writeFileSync(
    path.join(__dirname, 'config.json'),
    JSON.stringify(appConfig, null, 2),
    'utf8'
  );

  res.json({
    status: 'ok',
    message: 'Configuration updated (no auth check!)',
    config: appConfig
  });
});

// Ejemplo de endpoint que usa la configuración para permitir creación de cuentas
app.post('/register', (req, res) => {
  if (!appConfig.allowRegistrations) {
    return res.status(403).json({ error: 'Registrations are disabled' });
  }

  // Lógica simplificada de creación de usuario (sin validaciones reales)
  const { username } = req.body;
  // ... crear usuario en base de datos, etc.

  res.json({ status: 'user_created', username });
});

// Ejemplo de endpoint de subida de archivos que usa uploadDir de la configuración
const multer = require('multer');

// VULNERABLE: usa directamente appConfig.uploadDir, que puede ser modificado por /options
let storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, appConfig.uploadDir);
  },
  filename: (req, file, cb) => {
    cb(null, file.originalname);
  }
});

let upload = multer({ storage });

app.post('/upload', upload.single('file'), (req, res) => {
  // No se valida el tipo de archivo, permitiendo potencialmente webshells o JS malicioso
  res.json({ status: 'file_uploaded', file: req.file.filename });
});

app.listen(3000, () => {
  console.log('Vulnerable app listening on port 3000');
});
