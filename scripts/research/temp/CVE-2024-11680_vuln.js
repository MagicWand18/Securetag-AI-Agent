const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');
const path = require('path');

// Simulación de un "options.php" en Node.js
// Configuración global de la aplicación
let appConfig = {
  allowRegistrations: false,
  uploadDir: path.join(__dirname, 'uploads'),
  adminEmail: 'admin@example.com'
};

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// VULNERABLE: endpoint de configuración sin autenticación
// Cualquiera puede modificar la configuración de la app
app.post('/options', (req, res) => {
  // No hay verificación de sesión, token, ni rol
  const newConfig = req.body;

  // Mezcla ciega de la configuración recibida con la existente
  // Permite activar registros, cambiar directorios, etc.
  Object.assign(appConfig, newConfig);

  // Persistir configuración en disco sin validación
  fs.writeFileSync(
    path.join(__dirname, 'config.json'),
    JSON.stringify(appConfig, null, 2)
  );

  res.json({
    status: 'ok',
    message: 'Configuration updated (NO AUTH!)',
    config: appConfig
  });
});

// Ejemplo de endpoint que usa la configuración modificable
// Un atacante puede activar allowRegistrations y crear cuentas arbitrarias
app.post('/register', (req, res) => {
  if (!appConfig.allowRegistrations) {
    return res.status(403).json({ error: 'Registrations are disabled' });
  }

  const { username, password } = req.body;
  // Simulación: guardar usuario en un archivo de texto
  fs.appendFileSync(
    path.join(__dirname, 'users.txt'),
    `${username}:${password}\n`
  );

  res.json({ status: 'user_created', username });
});

// Ejemplo de endpoint de subida de archivos que usa uploadDir
// Un atacante podría cambiar uploadDir a una ruta servida como estática
// y subir un webshell o JS malicioso
app.post('/upload', (req, res) => {
  // Para simplificar el ejemplo, asumimos que el archivo viene en base64
  const { filename, contentBase64 } = req.body;
  const filePath = path.join(appConfig.uploadDir, filename);

  const buffer = Buffer.from(contentBase64, 'base64');
  fs.writeFileSync(filePath, buffer);

  res.json({ status: 'file_uploaded', path: filePath });
});

// Servir estáticos desde ./uploads (si el atacante cambia uploadDir a esta carpeta,
// puede hacer que sus archivos sean accesibles públicamente)
app.use('/files', express.static(path.join(__dirname, 'uploads')));

app.listen(3000, () => {
  console.log('Vulnerable app listening on port 3000');
});
