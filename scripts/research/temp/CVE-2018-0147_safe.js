const http = require('http');
const url = require('url');

// Versión segura: NO ejecuta código proveniente del cliente.
// En lugar de "deserializar" como código, trata los datos como JSON de datos simples
// y aplica validación de esquema.

function validatePayload(data) {
  // Validación muy básica de esquema: esperamos un objeto con campos de configuración simples.
  if (typeof data !== 'object' || data === null) return false;

  // Por ejemplo, esperamos algo como: { "action": "sum", "params": [1, 2] }
  if (typeof data.action !== 'string') return false;
  if (!Array.isArray(data.params)) return false;

  // Validar tipos de params (solo números en este ejemplo)
  if (!data.params.every(n => typeof n === 'number')) return false;

  return true;
}

function processAction(data) {
  // Lógica de negocio segura que NO evalúa código arbitrario
  switch (data.action) {
    case 'sum':
      return data.params.reduce((a, b) => a + b, 0);
    case 'multiply':
      return data.params.reduce((a, b) => a * b, 1);
    default:
      throw new Error('Unsupported action');
  }
}

const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);

  if (req.method === 'POST' && parsedUrl.pathname === '/api/deserialize') {
    let body = '';

    req.on('data', chunk => {
      body += chunk.toString();
    });

    req.on('end', () => {
      try {
        // Deserialización segura: solo JSON.parse y validación de datos,
        // sin ejecutar el contenido como código.
        const parsed = JSON.parse(body);

        if (!validatePayload(parsed)) {
          res.writeHead(400, { 'Content-Type': 'application/json' });
          return res.end(JSON.stringify({ error: 'Invalid payload schema' }));
        }

        const result = processAction(parsed);

        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ status: 'ok', result }));
      } catch (err) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Invalid payload', details: err.message }));
      }
    });
  } else {
    res.writeHead(404, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ error: 'Not found' }));
  }
});

server.listen(3000, () => {
  console.log('Secure deserialization demo server listening on port 3000');
});
