const express = require('express');
const bodyParser = require('body-parser');

// Versión segura: no se ejecuta código arbitrario, se valida el tipo
// y se deserializan solo estructuras de datos permitidas.

const app = express();
app.use(bodyParser.json());

// Mapa de tipos permitidos (whitelist)
const ALLOWED_TYPES = ['User', 'AdminTask'];

class User {
  constructor(data) {
    this.username = String(data.username || '').slice(0, 64);
    this.role = data.role === 'admin' ? 'admin' : 'user';
  }
}

class AdminTask {
  constructor(data) {
    this.task = String(data.task || '').slice(0, 128);
  }
}

const handlers = {
  User,
  AdminTask
};

// FUNCIÓN SEGURA: solo deserializa datos estructurados, sin ejecutar código
function secureDeserialize(payload) {
  if (typeof payload !== 'object' || payload === null) {
    throw new Error('Payload inválido');
  }

  const type = payload.type;
  const data = payload.data || {};

  // 1) Validar que el tipo esté en una lista blanca
  if (!ALLOWED_TYPES.includes(type)) {
    throw new Error('Tipo no soportado');
  }

  // 2) Rechazar cualquier campo inesperado que pueda intentar inyectar lógica
  const forbiddenFields = ['__code', '__proto__', 'constructor', 'prototype'];
  for (const field of forbiddenFields) {
    if (Object.prototype.hasOwnProperty.call(payload, field)) {
      throw new Error('Campo no permitido en payload: ' + field);
    }
  }

  // 3) Crear instancias de clases conocidas sin ejecutar código arbitrario
  const Obj = handlers[type];
  const instance = new Obj(data);

  return instance;
}

app.post('/api/deserialize', (req, res) => {
  try {
    const payload = req.body;
    const result = secureDeserialize(payload);
    res.json({ ok: true, result });
  } catch (err) {
    console.error('Error en deserialización segura:', err.message);
    res.status(400).json({ ok: false, error: 'Error procesando el objeto' });
  }
});

app.listen(3001, () => {
  console.log('Servidor seguro escuchando en http://localhost:3001');
});

/*
Diferencias clave respecto a la versión vulnerable:
- No se usa vm, eval ni ninguna ejecución dinámica de código.
- No se expone require, process ni APIs sensibles a datos de usuario.
- Se valida el tipo contra una lista blanca de clases conocidas.
- Se rechazan campos especiales como "__code" que podrían usarse como gadgets.
- Solo se deserializan estructuras de datos simples hacia clases controladas.
*/
