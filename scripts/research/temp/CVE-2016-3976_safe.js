const http = require('http');
const fs = require('fs');
const path = require('path');

// Versión segura del mismo patrón de descarga de archivos
// Se mitiga directory traversal validando y normalizando la ruta

const BASE_DIR = path.join(__dirname, 'logs');

const server = http.createServer((req, res) => {
  if (!req.url.startsWith('/CrashFileDownloadServlet')) {
    res.statusCode = 404;
    return res.end('Not found');
  }

  const url = new URL(req.url, 'http://localhost');
  const fileName = url.searchParams.get('fileName');

  if (!fileName) {
    res.statusCode = 400;
    return res.end('Missing fileName');
  }

  // Normalizar el nombre de archivo para evitar secuencias de traversal
  // 1) Rechazar rutas absolutas
  // 2) Normalizar y comprobar que la ruta resultante permanezca dentro de BASE_DIR

  // Evitar rutas absolutas tipo C:\... o /etc/passwd
  if (path.isAbsolute(fileName)) {
    res.statusCode = 400;
    return res.end('Invalid fileName');
  }

  // Normalizar la ruta combinada
  const normalizedPath = path.normalize(path.join(BASE_DIR, fileName));

  // Comprobar que la ruta final sigue estando bajo BASE_DIR
  if (!normalizedPath.startsWith(BASE_DIR + path.sep)) {
    res.statusCode = 403;
    return res.end('Access denied');
  }

  fs.readFile(normalizedPath, (err, data) => {
    if (err) {
      res.statusCode = 404;
      return res.end('File not found');
    }

    res.statusCode = 200;
    res.setHeader('Content-Type', 'application/octet-stream');
    res.end(data);
  });
});

server.listen(3000, () => {
  console.log('Safe server listening on http://localhost:3000');
});
