const express = require('express');
const app = express();

// Simula la lógica vulnerable de "linkref_addinindex" que inserta enlaces desde texto plano
// sin sanitizar correctamente el contenido, permitiendo XSS en atributos href.

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Endpoint que recibe el cuerpo de un email en texto plano y "auto-linkea" URLs
app.post('/render-email', (req, res) => {
  const body = req.body.body || '';

  // Regex simple para detectar URLs en texto plano
  const urlRegex = /(https?:\/\/[^\s]+)/g;

  // VULNERABILIDAD: se inserta directamente el valor capturado en el atributo href
  // sin escapar ni validar. Si el texto contiene algo como:
  //   javascript:alert(1)
  // o una URL maliciosa con comillas, se puede inyectar JS.
  const htmlBody = body.replace(urlRegex, (match) => {
    // Ejemplo de payload peligroso en texto plano:
    // <a href="javascript:alert('XSS')">haz clic</a>
    // o javascript:alert('XSS') como "URL".
    return `<a href="${match}">${match}</a>`;
  });

  // También se devuelven otros fragmentos sin escape, lo que amplifica el riesgo
  const html = `
    <html>
      <head><title>Email</title></head>
      <body>
        <h1>Mensaje recibido</h1>
        <div>${htmlBody}</div>
      </body>
    </html>
  `;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
