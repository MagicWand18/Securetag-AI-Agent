const express = require('express');
const app = express();

// Simula la lógica vulnerable de "linkref_addinindex" que inserta enlaces
// desde contenido de correo plano sin sanitizar correctamente.

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Endpoint que recibe el cuerpo de un correo en texto plano y genera HTML
app.post('/render-email', (req, res) => {
  const plainTextBody = req.body.body || '';

  // Conversión muy simplificada de URLs a enlaces HTML.
  // VULNERABLE: inserta directamente el texto del usuario dentro de atributos HTML
  // sin escape, permitiendo inyección de atributos/eventos/script.
  const htmlBody = plainTextBody.replace(/(https?:\/\/\S+)/g, (match) => {
    // Un atacante podría enviar algo como:
    // "javascript:alert(1)" o "x" onclick="alert(1)"
    return `<a href="${match}">${match}</a>`;
  });

  // También se permite que el usuario envíe pseudo-etiquetas tipo [linkref]
  // que se convierten directamente en <a> sin validación.
  const withCustomRefs = htmlBody.replace(/\[linkref:(.+?)\]/g, (m, url) => {
    // VULNERABLE: no se valida ni escapa 'url'
    return `<a href="${url}">${url}</a>`;
  });

  // Respuesta HTML sin ningún tipo de sanitización global
  res.send(`<!DOCTYPE html>
<html>
  <head><title>Vista de correo</title></head>
  <body>
    <h1>Mensaje</h1>
    <div>${withCustomRefs}</div>
  </body>
</html>`);
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
