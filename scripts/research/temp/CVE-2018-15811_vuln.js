const express = require('express');
const crypto = require('crypto');

// Ejemplo simplificado de uso de cifrado débil para proteger parámetros de entrada
// Similar en espíritu a la debilidad de DNN (CVE-2018-15811): algoritmo débil y clave fija

const app = express();
app.use(express.json());

// Clave y algoritmo INSEGUROS (débil y estáticos)
const WEAK_ALGO = 'des-ede3-cbc'; // Triple DES (obsoleto / débil)
const WEAK_KEY = Buffer.from('123456789012345678901234', 'utf8'); // Clave fija y predecible
const WEAK_IV = Buffer.from('12345678', 'utf8'); // IV fijo (no aleatorio)

function weakEncryptParam(plainText) {
  const cipher = crypto.createCipheriv(WEAK_ALGO, WEAK_KEY, WEAK_IV);
  let encrypted = cipher.update(plainText, 'utf8', 'base64');
  encrypted += cipher.final('base64');
  return encrypted;
}

function weakDecryptParam(cipherText) {
  const decipher = crypto.createDecipheriv(WEAK_ALGO, WEAK_KEY, WEAK_IV);
  let decrypted = decipher.update(cipherText, 'base64', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}

// Endpoint que "protege" parámetros usando cifrado débil
app.get('/profile', (req, res) => {
  const { token } = req.query;

  if (!token) {
    return res.status(400).send('Missing token');
  }

  try {
    // Parámetro de entrada protegido con cifrado débil
    const userId = weakDecryptParam(token);

    // Lógica de negocio ficticia
    res.json({
      userId,
      message: 'Perfil de usuario recuperado con cifrado débil (INSEGURO)'
    });
  } catch (e) {
    return res.status(400).send('Invalid token');
  }
});

// Endpoint para generar el token inseguro
app.post('/generate-token', (req, res) => {
  const { userId } = req.body;
  if (!userId) {
    return res.status(400).send('Missing userId');
  }

  const token = weakEncryptParam(String(userId));
  res.json({ token });
});

app.listen(3000, () => {
  console.log('Insecure app listening on port 3000');
});
