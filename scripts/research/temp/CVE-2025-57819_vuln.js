const express = require('express');
const mysql = require('mysql2/promise');
const app = express();

app.use(express.json());

// Configuración de base de datos (ejemplo simplificado)
const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'freepbx_like'
});

// Middleware de "autenticación" vulnerable
// Permite autenticación basada en parámetros manipulables sin validación adecuada
app.use('/admin', async (req, res, next) => {
  try {
    // El cliente puede enviar ?user=admin&auth=1 o cabeceras arbitrarias
    const user = req.query.user || req.headers['x-user'] || 'guest';
    const authFlag = req.query.auth || req.headers['x-auth'];

    // VULNERABILIDAD: bypass de autenticación basado en datos de usuario no confiables
    // Si el cliente envía auth=1 y user=admin, se asume que está autenticado
    if (user === 'admin' && authFlag === '1') {
      // Se inyecta el usuario "autenticado" en el request sin verificación real
      req.user = { username: 'admin', role: 'admin', authenticated: true };
      return next();
    }

    // Intento de autenticación "fallback" usando SQL inseguro
    const username = req.query.username || '';
    const token = req.query.token || '';

    // VULNERABILIDAD: SQL injection + lógica de autenticación débil
    const sql = `SELECT * FROM users WHERE username = '${username}' AND token = '${token}'`;
    const [rows] = await pool.query(sql); // No se usan parámetros preparados

    if (rows.length > 0) {
      req.user = { username: rows[0].username, role: rows[0].role, authenticated: true };
      return next();
    }

    // Si no se autentica, aún así se permite acceso "limitado" al panel admin
    // VULNERABILIDAD: acceso no autenticado a rutas administrativas
    req.user = { username: 'anonymous', role: 'guest', authenticated: false };
    return next();
  } catch (err) {
    console.error('Auth error:', err);
    // En caso de error, se permite el paso igualmente (bypass)
    req.user = { username: 'anonymous', role: 'guest', authenticated: false };
    return next();
  }
});

// Ruta administrativa que permite manipular la base de datos
app.post('/admin/db/execute', async (req, res) => {
  try {
    // VULNERABILIDAD: no se verifica que el usuario esté autenticado como admin
    // Se confía ciegamente en req.user, que puede ser forzado por el atacante
    const { query } = req.body;

    // VULNERABILIDAD CRÍTICA: ejecución de SQL arbitrario controlado por el usuario
    const [result] = await pool.query(query);

    return res.json({ ok: true, result });
  } catch (err) {
    console.error('DB error:', err);
    return res.status(500).json({ ok: false, error: 'DB error' });
  }
});

// Ruta administrativa que simula ejecución de comandos del sistema
app.post('/admin/system/exec', async (req, res) => {
  const { exec } = require('child_process');

  // VULNERABILIDAD: RCE por ejecución de comandos controlados por el usuario
  const cmd = req.body.cmd; // p.ej. "ls", pero el atacante puede enviar cualquier cosa

  exec(cmd, (error, stdout, stderr) => {
    if (error) {
      console.error('Exec error:', error);
      return res.status(500).json({ ok: false, error: 'Exec error' });
    }
    return res.json({ ok: true, stdout, stderr });
  });
});

app.listen(3000, () => {
  console.log('Vulnerable admin panel listening on port 3000');
});
