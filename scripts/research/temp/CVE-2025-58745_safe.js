const express = require('express');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

const app = express();

// Carpeta de almacenamiento NO servida directamente por el servidor web
const UPLOAD_DIR = path.join(__dirname, 'data', 'xlsx_uploads');
if (!fs.existsSync(UPLOAD_DIR)) {
  fs.mkdirSync(UPLOAD_DIR, { recursive: true });
}

// Función simple para inspeccionar magic bytes de un XLSX (ZIP con cabecera 50 4B 03 04)
function looksLikeXlsx(filePath) {
  try {
    const fd = fs.openSync(filePath, 'r');
    const buffer = Buffer.alloc(4);
    fs.readSync(fd, buffer, 0, 4, 0);
    fs.closeSync(fd);
    // XLSX es un ZIP, comprobamos cabecera ZIP
    return buffer[0] === 0x50 && buffer[1] === 0x4b && buffer[2] === 0x03 && buffer[3] === 0x04;
  } catch (e) {
    return false;
  }
}

// Almacenamiento seguro con nombre aleatorio y extensión fija
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, UPLOAD_DIR);
  },
  filename: (req, file, cb) => {
    // Generar nombre aleatorio y forzar extensión .xlsx
    const randomName = crypto.randomBytes(16).toString('hex');
    cb(null, randomName + '.xlsx');
  }
});

const upload = multer({
  storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // 5 MB
  },
  fileFilter: (req, file, cb) => {
    // Comprobación combinada: mimetype + extensión declarada
    const allowedMimes = [
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/vnd.ms-excel'
    ];

    const ext = path.extname(file.originalname).toLowerCase();

    if (!allowedMimes.includes(file.mimetype)) {
      return cb(new Error('MIME type no permitido'));
    }

    if (ext !== '.xlsx' && ext !== '.xls') {
      return cb(new Error('Extensión no permitida'));
    }

    cb(null, true);
  }
});

// Endpoint seguro para subir XLSX
app.post('/upload-xlsx', upload.single('file'), (req, res, next) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No se recibió archivo' });
  }

  const uploadedPath = req.file.path;

  // Validación adicional basada en magic bytes / estructura
  if (!looksLikeXlsx(uploadedPath)) {
    // Si no parece un XLSX real, eliminar el archivo y rechazar
    fs.unlink(uploadedPath, () => {
      return res.status(400).json({ error: 'El archivo no es un XLSX válido' });
    });
    return;
  }

  // En este punto, el archivo:
  // - No conserva el nombre original
  // - Tiene extensión fija .xlsx
  // - No está en un directorio servido por el servidor web
  // - Ha pasado validación de mimetype, extensión y magic bytes

  res.json({
    message: 'Archivo XLSX subido de forma segura',
    stored_as: path.basename(uploadedPath)
  });
});

// Importante: NO exponer UPLOAD_DIR como estático
// No usar app.use('/uploads', express.static(UPLOAD_DIR));

app.listen(3000, () => {
  console.log('Servidor seguro escuchando en http://localhost:3000');
});
