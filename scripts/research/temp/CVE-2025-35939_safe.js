const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Configuración verdaderamente inmutable en tiempo de ejecución
// No se expone a modificación directa por parámetros web
const IMMUTABLE_CONFIG = Object.freeze({
  uploadDir: path.join(__dirname, 'uploads'),
  // Ruta fija, controlada por el servidor, no modificable por el cliente
  templateFile: path.join(__dirname, 'cache', 'compiled-template.php')
});

// Lista blanca de archivos permitidos (si se necesita seleccionar entre varios)
const ALLOWED_TEMPLATES = Object.freeze([
  IMMUTABLE_CONFIG.templateFile,
  path.join(__dirname, 'cache', 'compiled-template-alt.php')
]);

// Ruta segura: solo permite seleccionar entre opciones predefinidas, no rutas arbitrarias
app.post('/config/select-template', (req, res) => {
  const { templateKey } = req.body;

  // Mapeo controlado por el servidor
  const templateMap = {
    default: IMMUTABLE_CONFIG.templateFile,
    alt: path.join(__dirname, 'cache', 'compiled-template-alt.php')
  };

  const selected = templateMap[templateKey] || templateMap.default;

  // No se modifica la configuración global; se devuelve al cliente para uso contextual
  if (!ALLOWED_TEMPLATES.includes(selected)) {
    return res.status(400).json({ error: 'Invalid template selection' });
  }

  res.json({ status: 'ok', selectedTemplate: selected });
});

// Ruta segura que escribe contenido en un archivo controlado por el servidor
app.post('/render', (req, res) => {
  const { content, templateKey } = req.body;

  // Selección de plantilla solo desde el mapa controlado
  const templateMap = {
    default: IMMUTABLE_CONFIG.templateFile,
    alt: path.join(__dirname, 'cache', 'compiled-template-alt.php')
  };

  const targetFile = templateMap[templateKey] || templateMap.default;

  // Validación estricta: solo se permite escribir en archivos de la lista blanca
  if (!ALLOWED_TEMPLATES.includes(targetFile)) {
    return res.status(400).send('Invalid target');
  }

  // Opcional: sanitizar/validar el contenido para evitar inyección de código en archivos interpretados
  // En un entorno real, NO se debería escribir contenido controlado por el usuario en archivos ejecutables (PHP, JS, etc.)
  const safeContent = typeof content === 'string' ? content.replace(/<\?php/gi, '') : '';

  fs.writeFile(targetFile, safeContent, { encoding: 'utf8', flag: 'w' }, (err) => {
    if (err) {
      console.error('Error writing file:', err);
      return res.status(500).send('Error');
    }
    res.send('Template safely updated');
  });
});

app.listen(3001, () => {
  console.log('Safe app listening on port 3001');
});
