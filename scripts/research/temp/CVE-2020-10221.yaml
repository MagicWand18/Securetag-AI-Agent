rules:
  - id: synthetic-cve202010221
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible inyección de comandos del sistema operativo (OS Command Injection)
      relacionada con CVE-2020-10221: se construye un comando de shell concatenando
      directamente datos controlados por el usuario (por ejemplo, parámetros de
      request) en una cadena que se pasa a child_process.exec. Un atacante puede
      inyectar metacaracteres de shell (como `;`, `&&`, `|`) y ejecutar comandos
      arbitrarios con los privilegios del proceso. Valida/escapa estrictamente la
      entrada o usa APIs que no invoquen un shell (por ejemplo, execFile/spawn con
      argumentos separados).
    metadata:
      cve: "CVE-2020-10221"
      source: "CISA_KEV"
      category: security
      technology: [nodejs, express]
      owasp:
        - A03:2021 - Injection
      cwe:
        - "CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')"
    patterns:
      - pattern-either:
          # Caso 1: comando construido con template string que incluye datos de request
          - pattern: |
              $CP.exec(`$CMD${...$REST}`, ...);
          - pattern: |
              $CP.exec(`...${$USER}...`, ...);
          - pattern: |
              $CP.exec($CMD, ...);
      - pattern-inside: |
          const $CP = require('child_process');
          ...
      - pattern-either:
          # Origen típico de datos controlados por el usuario en Express
          - pattern-inside: |
              app.$METHOD(..., (req, res, ...) => {
                ...
              });
          - pattern-inside: |
              $ROUTER.$METHOD(..., (req, res, ...) => {
                ...
              });
      - pattern-either:
          - pattern-inside: |
              const $USER = req.body.$FIELD;
              ...
          - pattern-inside: |
              const $USER = req.query.$FIELD;
              ...
          - pattern-inside: |
              const $USER = req.params.$FIELD;
              ...
          - pattern-inside: |
              let $USER = req.body.$FIELD;
              ...
          - pattern-inside: |
              let $USER = req.query.$FIELD;
              ...
          - pattern-inside: |
              let $USER = req.params.$FIELD;
              ...
    pattern-not:
      # Excluir casos donde se usa execFile/execFileSync/spawn con argumentos separados
      - pattern: |
          $CP.execFile($BIN, $ARGS, ...);
      - pattern: |
          $CP.spawn($BIN, $ARGS, ...);