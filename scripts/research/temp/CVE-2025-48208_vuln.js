const express = require('express');
const bodyParser = require('body-parser');
const ldap = require('ldapjs');

// Ejemplo simplificado de "comando" personalizado que un usuario autenticado puede enviar
// para buscar usuarios en LDAP. Este código es VULNERABLE a LDAP Injection.

const app = express();
app.use(bodyParser.json());

// Cliente LDAP básico (configuración de ejemplo)
const client = ldap.createClient({
  url: 'ldap://localhost:389'
});

// Middleware de autenticación muy simplificado (asume que el usuario ya está autenticado)
function fakeAuth(req, res, next) {
  // En un caso real, aquí se validaría un token o sesión.
  req.user = { id: '123', role: 'user' };
  next();
}

// Ruta que permite a un usuario autenticado ejecutar un "comando" personalizado
// para buscar usuarios en LDAP. El comando incluye un filtro LDAP arbitrario.
app.post('/api/ldap/command', fakeAuth, (req, res) => {
  const { commandName, filter } = req.body;

  // Validación mínima del comando (solo nombre), pero NO del filtro
  if (!commandName || typeof commandName !== 'string') {
    return res.status(400).json({ error: 'commandName requerido' });
  }

  // VULNERABILIDAD: Se concatena directamente el filtro proporcionado por el usuario
  // en la consulta LDAP sin neutralizar caracteres especiales.
  // Un atacante autenticado puede enviar algo como:
  //   filter: ")(objectClass=*)(|(uid=*))"
  // para alterar completamente la consulta.
  const baseDN = 'ou=users,dc=example,dc=com';
  const ldapFilter = `(&(objectClass=person)${filter})`;

  const opts = {
    filter: ldapFilter,
    scope: 'sub',
    attributes: ['cn', 'uid', 'mail']
  };

  client.search(baseDN, opts, (err, searchRes) => {
    if (err) {
      console.error('Error en búsqueda LDAP:', err);
      return res.status(500).json({ error: 'Error en búsqueda LDAP' });
    }

    const entries = [];

    searchRes.on('searchEntry', (entry) => {
      entries.push(entry.object);
    });

    searchRes.on('error', (err) => {
      console.error('Error en stream LDAP:', err);
      res.status(500).json({ error: 'Error en stream LDAP' });
    });

    searchRes.on('end', () => {
      // En un escenario real, estos resultados podrían alimentar otras partes
      // de la aplicación, potencialmente permitiendo ejecución de scripts
      // o lógica no prevista si se combinan con otras vulnerabilidades.
      res.json({
        command: commandName,
        filterUsed: ldapFilter,
        results: entries
      });
    });
  });
});

app.listen(3000, () => {
  console.log('Servidor vulnerable escuchando en http://localhost:3000');
});
