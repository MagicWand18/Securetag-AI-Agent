const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));

// Ruta de "setup" que genera un archivo de configuración
app.post('/setup', (req, res) => {
  const configPath = path.join(__dirname, 'config.php');

  // Datos enviados por POST (por ejemplo, desde un formulario de instalación)
  const siteName = req.body.siteName || 'Mi Sitio';
  const dbHost = req.body.dbHost || 'localhost';
  const dbUser = req.body.dbUser || 'root';
  const dbPass = req.body.dbPass || '';

  // VULNERABILIDAD: se inserta directamente contenido controlado por el usuario
  // dentro de un archivo PHP que luego será interpretado por el servidor.
  // Un atacante puede enviar algo como:
  // siteName="; phpinfo(); //
  // para inyectar código PHP arbitrario.
  const phpConfig = `<?php
  $config = array();
  $config['site_name'] = '${siteName}';
  $config['db_host'] = '${dbHost}';
  $config['db_user'] = '${dbUser}';
  $config['db_pass'] = '${dbPass}';
?>`;

  fs.writeFile(configPath, phpConfig, (err) => {
    if (err) {
      console.error('Error al escribir config.php:', err);
      return res.status(500).send('Error al generar configuración');
    }
    res.send('Archivo de configuración generado correctamente');
  });
});

app.listen(3000, () => {
  console.log('Servidor de setup escuchando en http://localhost:3000');
});
