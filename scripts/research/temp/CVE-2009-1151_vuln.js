const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(express.urlencoded({ extended: true }));

// Ruta de "setup" que genera un archivo de configuración
app.post('/setup', (req, res) => {
  const configPath = path.join(__dirname, 'config.php');

  // Datos enviados por POST (por ejemplo, desde un formulario de instalación)
  const siteName = req.body.siteName || 'Mi Sitio';
  const dbHost = req.body.dbHost || 'localhost';
  const dbUser = req.body.dbUser || 'root';
  const dbPass = req.body.dbPass || '';

  // VULNERABILIDAD (similar a CVE-2009-1151):
  // Se inserta directamente contenido controlado por el usuario en un archivo PHP
  // que luego será interpretado por el servidor PHP.
  // Un atacante puede enviar, por ejemplo, en dbHost: "localhost'; phpinfo(); //"
  // o incluso cerrar la cadena y añadir código PHP arbitrario.
  const phpConfig = `<?php
  $config = array(
    'site_name' => '${siteName}',
    'db_host'   => '${dbHost}',
    'db_user'   => '${dbUser}',
    'db_pass'   => '${dbPass}'
  );
?>`;

  // Se escribe el archivo de configuración sin ninguna validación/escape
  fs.writeFile(configPath, phpConfig, (err) => {
    if (err) {
      console.error('Error al escribir config.php:', err);
      return res.status(500).send('Error al generar configuración');
    }

    // El usuario será redirigido a la aplicación PHP que incluirá config.php
    res.send('Archivo de configuración generado correctamente.');
  });
});

app.listen(3000, () => {
  console.log('Servidor de setup escuchando en http://localhost:3000');
});
