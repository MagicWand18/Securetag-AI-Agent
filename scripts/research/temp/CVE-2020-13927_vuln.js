const express = require('express');
const bodyParser = require('body-parser');

// Simulación muy simplificada de una API "experimental" de orquestación de tareas,
// inspirada en el problema de Airflow: se expone una API sin autenticación.

const app = express();
app.use(bodyParser.json());

// Base de datos en memoria de "tareas" (DAGs / jobs)
const tasks = {
  "daily_report": { enabled: true, lastRun: null },
  "sync_users": { enabled: true, lastRun: null }
};

// ENDPOINT EXPERIMENTAL: permite listar y disparar tareas SIN NINGÚN TIPO DE AUTENTICACIÓN
// Vulnerabilidad análoga a CVE-2020-13927: API expuesta sin auth.

// Listar tareas
app.get('/api/experimental/tasks', (req, res) => {
  res.json({ tasks });
});

// Disparar una tarea por nombre
app.post('/api/experimental/tasks/:taskId/trigger', (req, res) => {
  const { taskId } = req.params;
  const task = tasks[taskId];

  if (!task) {
    return res.status(404).json({ error: 'Task not found' });
  }

  // Simula la ejecución de la tarea
  task.lastRun = new Date().toISOString();

  console.log(`[EXPERIMENTAL API] Task triggered: ${taskId}`);
  res.json({ message: `Task '${taskId}' triggered`, task });
});

// Modificar configuración de una tarea (p.ej. habilitar/deshabilitar)
app.put('/api/experimental/tasks/:taskId/config', (req, res) => {
  const { taskId } = req.params;
  const task = tasks[taskId];

  if (!task) {
    return res.status(404).json({ error: 'Task not found' });
  }

  // Cualquier cliente puede cambiar la configuración sin autenticarse
  const { enabled } = req.body;
  if (typeof enabled === 'boolean') {
    task.enabled = enabled;
  }

  console.log(`[EXPERIMENTAL API] Task config updated: ${taskId}, enabled=${task.enabled}`);
  res.json({ message: `Task '${taskId}' updated`, task });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Experimental orchestration API listening on port ${PORT} (NO AUTH!)`);
});
