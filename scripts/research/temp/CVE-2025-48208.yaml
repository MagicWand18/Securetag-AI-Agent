rules:
  - id: synthetic-cve202548208
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible LDAP Injection (CVE-2025-48208): se construye un filtro LDAP concatenando
      directamente datos controlados por el usuario (por ejemplo, `req.body.filter`) en
      la cadena de búsqueda (`opts.filter` o parámetro `filter` de `client.search`).
      Un atacante autenticado puede inyectar operadores LDAP especiales (`*`, `)`, `(|`, etc.)
      para alterar la consulta, eludir controles de acceso o extraer información sensible.
      Valida y escapa los valores de entrada antes de construir filtros LDAP o utiliza
      APIs que manejen parámetros de forma segura.
    metadata:
      cve: CVE-2025-48208
      source: CISA_KEV
      category: security
      technology: [nodejs, express, ldapjs]
      cwe: "CWE-90: Improper Neutralization of Special Elements used in an LDAP Query ('LDAP Injection')"
    patterns:
      - pattern-either:
          # Caso 1: filtro se pasa directamente como string concatenado al parámetro filter de client.search
          - pattern: |
              $CLIENT.search($BASE_DN, { ..., filter: $FILTER, ... }, ...);
          # Caso 2: filtro se pasa como segundo argumento (forma abreviada) a client.search
          - pattern: |
              $CLIENT.search($BASE_DN, $FILTER, ...);
      - pattern-inside: |
          $CLIENT = require('ldapjs');
          ...
      - pattern-inside: |
          const $APP = require('express')();
          ...
      - pattern-inside: |
          $APP.$METHOD($ROUTE, ..., (req, res, ... ) => {
            ...
          });
      - pattern-either:
          # Filtro construido con template string que incluye datos de req.*
          - pattern: |
              $FILTER = `...${req.$SRC}...`;
          - pattern: |
              $FILTER = `...${req.$SRC.$FIELD}...`;
          # Filtro construido con concatenación de strings que incluye datos de req.*
          - pattern: |
              $FILTER = "..."+req.$SRC+"...";
          - pattern: |
              $FILTER = "..."+req.$SRC.$FIELD+"...";
          - pattern: |
              $FILTER = req.$SRC + "...";
          - pattern: |
              $FILTER = req.$SRC.$FIELD + "...";
      - metavariable-pattern:
          metavariable: $SRC
          pattern: |
            body
      - pattern-not: |
          $FILTER = $SANITIZE(...);
      - pattern-not: |
          $FILTER = $SANITIZE(req.$SRC);
      - pattern-not: |
          $FILTER = $SANITIZE(req.$SRC.$FIELD);