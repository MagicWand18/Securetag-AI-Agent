rules:
  - id: synthetic-cve202334362
    languages:
      - javascript
      - typescript
    message: >
      Posible inyección SQL no autenticada similar a CVE-2023-34362: se concatena
      directamente un parámetro controlado por el usuario en una consulta SQL
      (`db.query(sql, ...)`) sin usar parámetros preparados ni escape seguro.
      Un atacante puede manipular el parámetro (por ejemplo `?id=1;DROP TABLE users--`)
      para ejecutar SQL arbitrario, lo que permite acceso o destrucción de datos.
    severity: ERROR
    metadata:
      cve: "CVE-2023-34362"
      source: "CISA_KEV"
      category: "security"
      technology:
        - nodejs
        - express
        - mysql
      likelihood: "high"
      impact: "high"
      vulnerability_class:
        - "SQL Injection"
    patterns:
      - pattern-either:
          # Caso: template string con interpolación de variable
          - pattern: |
              $DB.$QUERY_FN(`... = ${$PARAM}...`, ...)
          # Caso: concatenación con +
          - pattern: |
              $DB.$QUERY_FN("..." + $PARAM + "...", ...)
      - pattern-inside: |
          $DB = require('mysql2');
          ...
          $CONN = $DB.$CREATE_CONN(...);
          ...
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
            $PARAM = $REQ.$SRC.$FIELD;
            ...
            $CONN.$QUERY_FN($SQL, ...);
            ...
          });
      - metavariable-pattern:
          metavariable: $SRC
          pattern-either:
            - pattern: query
            - pattern: params
            - pattern: body
      - metavariable-pattern:
          metavariable: $QUERY_FN
          pattern-either:
            - pattern: query
            - pattern: execute
      - metavariable-pattern:
          metavariable: $CREATE_CONN
          pattern-either:
            - pattern: createConnection
            - pattern: createPool
      - pattern-not: |
          $DB.$QUERY_FN($SQL, [$PARAM], ...)