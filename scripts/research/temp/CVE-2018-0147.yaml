rules:
  - id: synthetic-cve20180147
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible ejecución remota de código (RCE) similar a CVE-2018-0147: se usa
      `vm.runInNewContext` con código controlado por el usuario (`payload.__code`)
      en un contexto que expone primitivas peligrosas como `require`, `process` o
      `console`. Un atacante puede enviar un payload especialmente diseñado para
      ejecutar comandos arbitrarios en el servidor. Valida y restringe el código
      ejecutado, evita exponer `require`/`process` al contexto y no ejecutes
      directamente datos controlados por el usuario.
    metadata:
      cve: "CVE-2018-0147"
      source: "CISA_KEV"
      category: security
      technology: [nodejs, express]
      vulnerability_class: [code-injection, remote-code-execution]
      likelihood: HIGH
    patterns:
      - pattern-either:
          # Caso directo: vm.runInNewContext(payload.__code, context)
          - pattern: |
              vm.runInNewContext($CODE, $CTX)
          # Caso con alias: const vm = require('vm'); vm.runInNewContext(...)
          - pattern: |
              $VM.runInNewContext($CODE, $CTX)
      - pattern-inside: |
          const $VM = require('vm');
          ...
      - pattern-either:
          # Código controlado por el usuario: acceso directo a un campo "__code"
          - pattern: |
              if (typeof $PAYLOAD.__code === 'string') {
                ...
                $VM.runInNewContext($PAYLOAD.__code, $CTX);
                ...
              }
          - pattern: |
              if (typeof $PAYLOAD["__code"] === 'string') {
                ...
                $VM.runInNewContext($PAYLOAD["__code"], $CTX);
                ...
              }
      - pattern-inside: |
          function $F(...){
            ...
            const $CTX = {
              require: require,
              ...
            };
            ...
          }
    fix: >
      No ejecutes directamente código controlado por el usuario con `vm.runInNewContext`
      ni expongas `require`/`process` al contexto. Elimina el uso de `__code` o
      reemplázalo por lógica de negocio explícita y validada.