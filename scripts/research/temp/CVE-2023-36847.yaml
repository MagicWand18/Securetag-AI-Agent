rules:
  - id: synthetic-cve202336847
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible implementación vulnerable similar a CVE-2023-36847: endpoint de subida
      de paquetes/aplicaciones sin autenticación ni validación de archivos. Un atacante
      remoto puede subir archivos arbitrarios (p.ej. paquetes maliciosos) a un directorio
      de la aplicación usando multer.diskStorage con file.originalname sin sanitizar y
      un app.post accesible sin controles de acceso, lo que facilita ejecución de código
      o instalación de paquetes maliciosos. Revise autenticación, autorización y
      validación estricta del archivo antes de aceptar la carga.
    metadata:
      cve: "CVE-2023-36847"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express", "multer"]
      likelihood_of_exploit: "high"
      references:
        - "https://www.cisa.gov/known-exploited-vulnerabilities-catalog"
    patterns:
      - pattern-either:
          # 1) Multer diskStorage que usa file.originalname sin sanitizar
          - pattern: |
              const $M = require('multer');
              ...
              const $STORAGE = $M.diskStorage({
                destination: (req, file, cb) => {
                  cb(null, $DEST);
                },
                filename: (req, file, cb) => {
                  cb(null, file.originalname);
                }
              });
              ...
              const $UPLOAD = $M({ storage: $STORAGE });
          - pattern: |
              import $M from 'multer';
              ...
              const $STORAGE = $M.diskStorage({
                destination: (req, file, cb) => {
                  cb(null, $DEST);
                },
                filename: (req, file, cb) => {
                  cb(null, file.originalname);
                }
              });
              ...
              const $UPLOAD = $M({ storage: $STORAGE });
      - pattern-either:
          # 2) Endpoint POST que usa upload.single(...) sin controles explícitos
          - pattern: |
              const $EXP = require('express');
              ...
              const $APP = $EXP();
              ...
              $APP.post($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES) => {
                ...
              });
          - pattern: |
              import $EXP from 'express';
              ...
              const $APP = $EXP();
              ...
              $APP.post($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES) => {
                ...
              });
    message-format: text