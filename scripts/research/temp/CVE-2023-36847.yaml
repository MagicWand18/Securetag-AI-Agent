rules:
  - id: synthetic-cve202336847
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible carga de archivos arbitrarios sin autenticación ni validación,
      similar a CVE-2023-36847 (Juniper J-Web installAppPackage.php). Un
      endpoint que acepta archivos mediante multer.diskStorage sin validar
      tipo, tamaño ni nombre (usando file.originalname directamente) puede
      permitir a un atacante subir paquetes maliciosos o ejecutar código
      arbitrario en el servidor.
    metadata:
      cwe: "CWE-434: Unrestricted Upload of File with Dangerous Type"
      owasp: "A05:2021 - Security Misconfiguration"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2023-36847"
    patterns:
      # 1) Uso de multer.diskStorage
      - pattern-inside: |
          const $MULTER = require('multer');
          ...
      - pattern: |
          $STORAGE = $MULTER.diskStorage({
            destination: ($REQ, $FILE, $CB) => {
              $CB(null, $DEST);
            },
            filename: ($REQ2, $FILE2, $CB2) => {
              $CB2(null, $FILE2.originalname);
            },
          });
      # 2) Uso de ese storage en configuración de multer
      - pattern: |
          $UPLOAD = $MULTER({ storage: $STORAGE, ... });
      # 3) Endpoint HTTP que usa upload.single(...) sin validaciones adicionales
      - pattern-either:
          - pattern: |
              $APP.post($ROUTE, $UPLOAD.single($FIELD), ($REQ3, $RES3) => {
                ...
              });
          - pattern: |
              $ROUTER.post($ROUTE, $UPLOAD.single($FIELD), ($REQ3, $RES3) => {
                ...
              });