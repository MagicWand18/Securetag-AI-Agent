const express = require('express');
const session = require('express-session');
const bodyParser = require('body-parser');

// Simulación de "base de datos" en memoria
const bloodSamples = [
  { id: 1, type: 'A+', hospitalId: 10 },
  { id: 2, type: 'O-', hospitalId: 10 },
  { id: 3, type: 'B+', hospitalId: 20 }
];

const app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

app.use(session({
  secret: 'strong-secret-change-me',
  resave: false,
  saveUninitialized: false,
  cookie: { httpOnly: true, secure: false } // secure: true en producción con HTTPS
}));

// Middleware de autenticación
function requireAuth(req, res, next) {
  if (!req.session.user) {
    return res.status(401).json({ error: 'Not authenticated' });
  }
  next();
}

// Middleware de autorización para rol hospital
function requireHospitalRole(req, res, next) {
  if (!req.session.user || req.session.user.role !== 'hospital') {
    return res.status(403).json({ error: 'Forbidden: hospital role required' });
  }
  next();
}

// Login muy simplificado: solo establece el rol en sesión
app.post('/login', (req, res) => {
  const { username, role } = req.body; // role: 'hospital' o 'user'

  // En un sistema real, aquí se validarían credenciales contra la BD
  const hospitalId = role === 'hospital' ? 10 : null;

  req.session.user = { username, role, hospitalId };
  res.json({ msg: 'logged in', user: req.session.user });
});

// Listado de muestras de sangre SOLO para hospitales y SOLO sus propias muestras
app.get('/bloodinfo', requireAuth, requireHospitalRole, (req, res) => {
  const { hospitalId } = req.session.user;

  // Filtrar por hospitalId del usuario autenticado
  const ownSamples = bloodSamples.filter(s => s.hospitalId === hospitalId);
  res.json({ samples: ownSamples });
});

// Endpoint seguro que reemplaza al delete.php vulnerable
app.post('/delete', requireAuth, requireHospitalRole, (req, res) => {
  const { hospitalId } = req.session.user;
  const id = parseInt(req.body.id, 10);

  if (Number.isNaN(id)) {
    return res.status(400).json({ error: 'Invalid id' });
  }

  // BÚSQUEDA CON CONTROL DE PROPIEDAD:
  // Solo se puede borrar una muestra que pertenezca al hospital autenticado
  const index = bloodSamples.findIndex(
    s => s.id === id && s.hospitalId === hospitalId
  );

  if (index === -1) {
    // No revelar si el recurso existe pero pertenece a otro hospital
    return res.status(404).json({ error: 'Sample not found or not owned by this hospital' });
  }

  const deleted = bloodSamples.splice(index, 1)[0];

  res.json({ msg: 'You have deleted one blood sample.', deleted });
});

app.listen(8080, () => {
  console.log('Safe Blood Bank app listening on port 8080');
});
}