const express = require('express');
const mysql = require('mysql2');

// Versi칩n segura del endpoint de cancelaci칩n

const app = express();

const db = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'blood_bank'
});

app.get('/cancel', (req, res) => {
  const reqid = req.query.reqid;

  // Validaci칩n b치sica de entrada: debe ser un entero positivo
  const id = Number.parseInt(reqid, 10);
  if (!Number.isInteger(id) || id <= 0) {
    return res.status(400).send('Invalid request id');
  }

  // SEGURO: uso de consulta parametrizada / prepared statement
  const sql = 'UPDATE requests SET status = ? WHERE id = ?';
  const params = ['cancelled', id];

  db.execute(sql, params, (err, result) => {
    if (err) {
      console.error('DB error:', err);
      return res.status(500).send('Internal Server Error');
    }

    if (result.affectedRows === 0) {
      return res.status(404).send('Request not found');
    }

    res.send(`Request ${id} cancelled`);
  });
});

app.listen(3000, () => {
  console.log('Secure server running on http://localhost:3000');
});
