rules:
  - id: synthetic-cve202442009
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible des-sanitización insegura de HTML que reintroduce contenido potencialmente malicioso
      (por ejemplo, scripts) en la respuesta enviada al cliente. Este patrón es similar a la
      vulnerabilidad descrita en CVE-2024-42009, donde contenido previamente "sanitizado"
      (p.ej. escapado como entidades HTML) se vuelve a convertir manualmente en HTML sin
      validación ni filtrado adicional, lo que puede permitir XSS y robo de cookies/datos
      con alta probabilidad de explotación.
    metadata:
      cve: CVE-2024-42009
      source: CISA_KEV
      category: security
      technology:
        - nodejs
        - express
        - http
      likelihood_of_exploit: HIGH
      references:
        - https://www.cisa.gov/known-exploited-vulnerabilities-catalog
      vulnerability_class:
        - xss
        - html-desanitization
    patterns:
      - pattern-either:
          # Patrón 1: función que toma un objeto "message" y des-sanitiza body/body_sanitized
          - pattern: |
              function $FUNC($MSG) {
                ...
                let $BODY = $MSG.$FIELD
                  .replace(/&lt;/g, '<')
                  .replace(/&gt;/g, '>')
                  .replace(/&quot;/g, '"')
                  .replace(/&#39;/g, "'")
                  .replace(/&amp;/g, '&');
                ...
                return $BODY;
              }
          # Patrón 2: asignación directa (no necesariamente dentro de una función)
          - pattern: |
              let $BODY = $MSG.$FIELD
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/&amp;/g, '&');
      - metavariable-pattern:
          metavariable: $FIELD
          pattern-either:
            - pattern: body_sanitized
            - pattern: body
            - pattern: html_sanitized
            - pattern: content_sanitized
      - pattern-not: |
          let $BODY = $MSG.$FIELD
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'")
            .replace(/&amp;/g, '&');
          ...
          $SANITIZED = $SANITIZE_FUNC($BODY);
      - pattern-not: |
          let $BODY = $MSG.$FIELD
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'")
            .replace(/&amp;/g, '&');
          ...
          $RES.send(escape($BODY));