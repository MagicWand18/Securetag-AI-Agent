rules:
  - id: synthetic-cve202442009
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible vulnerabilidad tipo CVE-2024-42009: contenido HTML controlado por un atacante
      se devuelve o propaga como "ya sanitizado" y luego se inserta directamente en una
      respuesta HTML (por ejemplo, con res.send) sin escape ni sanitización adicional.
      Esto permite XSS almacenado o reflejado cuando el HTML se muestra en el navegador.
      Asegúrate de escapar/sanitizar el contenido antes de interpolarlo en la respuesta
      o usa APIs que hagan escape automático.
    metadata:
      cwe: "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2024-42009"
    patterns:
      # 1) Detectamos una función que actúa como "desanitizadora" o passthrough de HTML
      - pattern: |
          function $FNAME($ARG, ...) {
            ...
            return $ARG;
          }
      # 2) Dentro del handler de Express, se llama a esa función con datos potencialmente controlados
      #    por el usuario (req.query, req.body, req.params, etc.)
      - pattern-inside: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          })
      - pattern: |
          $BODY = $FNAME($USER_INPUT);
      - pattern-either:
          - pattern: $USER_INPUT = $REQ.query.$FIELD;
          - pattern: $USER_INPUT = $REQ.query[$FIELD];
          - pattern: $USER_INPUT = $REQ.body.$FIELD;
          - pattern: $USER_INPUT = $REQ.body[$FIELD];
          - pattern: $USER_INPUT = $REQ.params.$FIELD;
          - pattern: $USER_INPUT = $REQ.params[$FIELD];
          - pattern: $USER_INPUT = $REQ.$ANYPROP;
      # 3) El resultado de esa "desanitización" se inserta directamente en una plantilla HTML
      #    enviada con res.send, usando interpolación de template string (${...})
      - pattern-inside: |
          $RES.send(`$HTML`);
      - pattern: |
          $RES.send(`...${$BODY}...`)