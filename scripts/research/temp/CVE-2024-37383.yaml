rules:
  - id: synthetic-cve202437383
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible XSS al incrustar contenido SVG controlado por el usuario directamente en HTML
      sin sanitización. Esto es similar a CVE-2024-37383, donde atributos SVG como
      <animate> pueden abusarse para ejecutar JavaScript (por ejemplo, usando atributos
      de evento como onbegin). Valida/escapa el SVG o usa una librería de sanitización
      antes de insertarlo en la respuesta HTML.
    metadata:
      cve: CVE-2024-37383
      source: CISA_KEV
      category: security
      technology: [nodejs, express]
      vulnerability: xss
      likelihood_of_exploit: HIGH
    patterns:
      # 1) Detectar uso de Express y un handler de ruta
      - pattern-either:
          - pattern: |
              $APP.get($ROUTE, ($REQ, $RES) => {
                ...
              })
          - pattern: |
              $APP.get($ROUTE, function ($REQ, $RES) {
                ...
              })
      # 2) Dentro del handler, detectar que un valor derivado de req.* se usa en una plantilla HTML
      - pattern: |
          $APP.get($ROUTE, $HANDLER) 
      - pattern-inside: |
          $APP.get($ROUTE, ($REQ, $RES) => {
            ...
            $USER_SVG = $REQ.$ANY1.$ANY2 || $FALLBACK;
            ...
            $HTML = `...`;
            ...
            $RES.$SEND($HTML);
          })
      # 3) Asegurar que la variable controlada por el usuario se inserta sin escapar en la template literal
      - pattern-regex: '\$\{\s*\$USER_SVG\s*\}'
      # 4) Asegurar que la template literal parece ser HTML (para reducir falsos positivos)
      - pattern-regex: '<html[> ]|<!DOCTYPE html>|<body[> ]'
      # 5) Asegurar que el contenido se envía como HTML
      - pattern-either:
          - pattern-inside: |
              $RES.setHeader('Content-Type', 'text/html' ...);
              ...
              $RES.$SEND($HTML);
          - pattern-inside: |
              $RES.set('Content-Type', 'text/html' ...);
              ...
              $RES.$SEND($HTML);