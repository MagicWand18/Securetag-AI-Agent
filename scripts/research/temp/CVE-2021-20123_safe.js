const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();

// Endpoint equivalente pero seguro contra Path Traversal
app.get('/DownloadFileServlet', (req, res) => {
  const fileParam = req.query.file;
  if (!fileParam) return res.status(400).send('Missing file parameter');

  const baseDir = '/var/vigorconnect/downloads';

  // Normaliza y resuelve a una ruta absoluta dentro del directorio permitido
  // 1) Evita rutas absolutas del usuario
  // 2) Resuelve .. y .
  const requested = fileParam.replace(/\\/g, '/');
  if (path.isAbsolute(requested)) return res.status(400).send('Invalid path');

  const resolvedBase = path.resolve(baseDir) + path.sep;
  const resolvedTarget = path.resolve(baseDir, requested);

  // Verificación de confinamiento: el archivo debe quedar dentro de baseDir
  if (!resolvedTarget.startsWith(resolvedBase)) {
    return res.status(403).send('Forbidden');
  }

  // (Opcional) permitir solo nombres simples o extensiones específicas
  // if (!/^[a-zA-Z0-9._-]+$/.test(path.basename(requested))) return res.status(400).send('Invalid filename');

  fs.stat(resolvedTarget, (err, st) => {
    if (err || !st.isFile()) return res.status(404).send('File not found');

    res.setHeader('Content-Type', 'application/octet-stream');
    fs.createReadStream(resolvedTarget)
      .on('error', () => res.status(500).send('Read error'))
      .pipe(res);
  });
});

app.listen(3000, () => console.log('Listening on http://localhost:3000'));
