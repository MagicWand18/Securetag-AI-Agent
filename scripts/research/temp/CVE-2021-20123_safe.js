const express = require('express');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = 3000;

// Directorio base donde se almacenan los archivos descargables
const BASE_DIR = '/var/app/files';

// Lista blanca opcional de extensiones permitidas
const ALLOWED_EXTENSIONS = new Set(['.pdf', '.txt', '.log']);

// Endpoint seguro que mitiga path traversal
app.get('/DownloadFileServlet', (req, res) => {
  const fileName = req.query.file; // p.ej. ?file=report.pdf

  if (!fileName) {
    return res.status(400).send('Missing file parameter');
  }

  // Rechazar rutas que contengan secuencias sospechosas
  if (fileName.includes('..') || fileName.includes('\\') || fileName.startsWith('/')) {
    return res.status(400).send('Invalid file path');
  }

  // Normalizar y resolver la ruta absoluta
  const requestedPath = path.normalize(fileName);
  const absolutePath = path.resolve(BASE_DIR, requestedPath);

  // Comprobar que la ruta resultante sigue dentro de BASE_DIR
  if (!absolutePath.startsWith(path.resolve(BASE_DIR) + path.sep)) {
    return res.status(403).send('Access denied');
  }

  // Validar extensiÃ³n (defensa adicional)
  const ext = path.extname(absolutePath).toLowerCase();
  if (!ALLOWED_EXTENSIONS.has(ext)) {
    return res.status(400).send('File type not allowed');
  }

  fs.stat(absolutePath, (err, stats) => {
    if (err || !stats.isFile()) {
      return res.status(404).send('File not found');
    }

    // Usar stream para evitar cargar el archivo completo en memoria
    res.setHeader('Content-Type', 'application/octet-stream');
    res.setHeader('Content-Disposition', `attachment; filename="${path.basename(absolutePath)}"`);

    const readStream = fs.createReadStream(absolutePath);
    readStream.on('error', (streamErr) => {
      console.error('Stream error:', streamErr.message);
      if (!res.headersSent) {
        res.status(500).send('Error reading file');
      }
    });

    readStream.pipe(res);
  });
});

app.listen(PORT, () => {
  console.log(`Secure server listening on port ${PORT}`);
});
