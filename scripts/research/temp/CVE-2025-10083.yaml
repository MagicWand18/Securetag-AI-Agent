rules:
  - id: synthetic-cve202510083
    languages: [javascript, typescript]
    severity: ERROR
    message: >
      Posible carga de archivos sin restricciones asociada a CVE-2025-10083:
      se detecta el uso de `express-fileupload` donde un archivo proveniente
      de `req.files` se mueve (`mv`) directamente a un directorio público
      accesible desde la web usando su nombre original (`avatar.name` o
      similar), sin autenticación, sin validación de tipo/extensión y sin
      controles adicionales. Esto puede permitir a un atacante subir scripts
      ejecutables (por ejemplo, .js, .php en entornos mixtos, etc.) y
      accederlos vía URL pública, resultando en ejecución remota de código
      o toma de control del servidor. Revise la lógica de validación,
      autenticación y la ubicación de almacenamiento de archivos para
      mitigar el vector descrito en CVE-2025-10083.
    metadata:
      cve: "CVE-2025-10083"
      source: "CISA_KEV"
      category: "security"
      technology: ["nodejs", "express", "express-fileupload"]
      likelihood: "high"
      impact: "high"
      confidence: "medium"
    patterns:
      - pattern-either:
          # Caso 1: uso directo de req.files.<campo>.mv(...)
          - pattern: |
              app.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                $FILE = $REQ.files.$FIELD;
                ...
                $UPLOAD_PATH = path.join(__dirname, $PUBLIC_DIR, $SUBDIR, $FILE.name);
                ...
                $FILE.mv($UPLOAD_PATH, ($ERR) => {
                  ...
                });
                ...
              });
          # Caso 2: uso de variable intermedia para req.files y luego .mv(...)
          - pattern: |
              app.$METHOD($ROUTE, ($REQ, $RES) => {
                ...
                $FILES = $REQ.files;
                ...
                $FILE = $FILES.$FIELD;
                ...
                $UPLOAD_PATH = path.join(__dirname, $PUBLIC_DIR, $SUBDIR, $FILE.name);
                ...
                $FILE.mv($UPLOAD_PATH, ($ERR) => {
                  ...
                });
                ...
              });
      - pattern-inside: |
          const express = require('express');
          const fileUpload = require('express-fileupload');
          ...
          const app = express();
          app.use(fileUpload());
          ...
      - pattern-inside: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          });
      - metavariable-pattern:
          metavariable: $PUBLIC_DIR
          pattern: "'public'"
      - metavariable-pattern:
          metavariable: $SUBDIR
          pattern: "'uploads'"      
      - pattern-not: |
          app.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
            if (!$REQ.files || !$REQ.files.$FIELD) {
              ...
            }
            ...
            if ($REQ.user || $REQ.isAuthenticated && $REQ.isAuthenticated()) {
              ...
            }
            ...
          });