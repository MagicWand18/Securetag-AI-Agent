#!/usr/bin/env python3
"""process_exploitdb.py

Procesa el archivo datasets/raw/json_exploitdb.json y genera chunks.
A diferencia de process_chunks.py, aquí cada exploit se convierte en un único chunk
para preservar la integridad del código.

Salida: datasets/processed/json_exploitdb_chunks.json
"""

import json
from pathlib import Path

RAW_FILE = Path(__file__).parents[2] / "datasets" / "raw" / "json_exploitdb.json"
PROCESSED_DIR = Path(__file__).parents[2] / "datasets" / "processed"
PROCESSED_DIR.mkdir(parents=True, exist_ok=True)
OUTPUT_FILE = PROCESSED_DIR / "json_exploitdb_chunks.json"

def main():
    if not RAW_FILE.exists():
        print(f"[ERROR] No se encuentra el archivo {RAW_FILE}")
        return

    print(f"[INFO] Leyendo {RAW_FILE}...")
    with open(RAW_FILE, "r", encoding="utf-8") as f:
        exploits = json.load(f)

    chunks_out = []
    print(f"[INFO] Procesando {len(exploits)} exploits...")

    for idx, exploit in enumerate(exploits):
        # El texto principal es el código
        code = exploit.get("code", "")
        if not code:
            continue
            
        # Construimos el chunk
        # Usamos source="exploitdb" para activar el prompt especial en generate_qa.py
        chunk_obj = {
            "source": "exploitdb",
            "chunk_index": idx,
            "text": code,
            "metadata": {
                "id": exploit.get("id"),
                "title": exploit.get("title"),
                "cve": exploit.get("cve"),
                "platform": exploit.get("platform"),
                "type": exploit.get("type"),
                "author": exploit.get("author"),
                "date": exploit.get("date"),
                "verified": exploit.get("verified"),
                "source_file": exploit.get("source_file")
            }
        }
        chunks_out.append(chunk_obj)

    print(f"[INFO] Generados {len(chunks_out)} chunks.")
    print(f"[INFO] Guardando en {OUTPUT_FILE}...")
    
    with open(OUTPUT_FILE, "w", encoding="utf-8") as out_f:
        json.dump(chunks_out, out_f, ensure_ascii=False, indent=2)
    
    print("[INFO] Proceso completado.")

if __name__ == "__main__":
    main()
