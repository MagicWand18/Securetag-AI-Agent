import csv
import json
import os
from pathlib import Path
from tqdm import tqdm

# Configuración
BASE_DIR = Path(__file__).parents[2]
SOURCES_DIR = BASE_DIR / "sources" / "exploitdb"
CSV_PATH = SOURCES_DIR / "files_exploits.csv"
OUTPUT_DIR = BASE_DIR / "datasets" / "raw"
OUTPUT_FILE = OUTPUT_DIR / "json_exploitdb.json"

def main():
    print(f"=== Iniciando extracción de Exploit-DB ===")
    print(f"Leyendo índice: {CSV_PATH}")

    if not CSV_PATH.exists():
        print(f"❌ Error: No se encuentra {CSV_PATH}")
        return

    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    extracted_exploits = []
    
    # Contadores
    total = 0
    verified_count = 0
    skipped_file_not_found = 0
    skipped_unverified = 0
    skipped_text_files = 0

    with open(CSV_PATH, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        
        for row in tqdm(reader, desc="Procesando exploits"):
            total += 1
            
            # Filtro: Solo verificados (verified == '1')
            if row['verified'] != '1':
                skipped_unverified += 1
                continue
            
            verified_count += 1
            
            # Construir ruta del archivo
            file_rel_path = row['file']
            file_abs_path = SOURCES_DIR / file_rel_path

            # Filtro de extensiones: Excluir texto/documentación
            # Queremos solo código ejecutable o PoCs funcionales
            excluded_extensions = {'.txt', '.md', '.pdf', '.docx', '.rtf'}
            file_ext = Path(file_rel_path).suffix.lower()
            
            if file_ext in excluded_extensions:
                skipped_text_files += 1
                continue
            
            if not file_abs_path.exists():
                skipped_file_not_found += 1
                continue
                
            try:
                # Intentar leer con utf-8, fallback a latin-1 si falla (común en exploits viejos)
                try:
                    with open(file_abs_path, 'r', encoding='utf-8') as source_file:
                        content = source_file.read()
                except UnicodeDecodeError:
                    with open(file_abs_path, 'r', encoding='latin-1') as source_file:
                        content = source_file.read()
                
                # Crear objeto exploit
                exploit = {
                    "id": row['id'],
                    "title": row['description'],
                    "cve": row['codes'],
                    "platform": row['platform'],
                    "type": row['type'],
                    "author": row['author'],
                    "date": row['date_published'],
                    "verified": True,
                    "source_file": file_rel_path,
                    "code": content
                }
                
                extracted_exploits.append(exploit)
                
            except Exception as e:
                print(f"Error leyendo {file_rel_path}: {e}")

    print("\n=== Resumen de Extracción ===")
    print(f"Total en índice: {total}")
    print(f"Descartados (No verificados): {skipped_unverified}")
    print(f"Descartados (Archivo no encontrado): {skipped_file_not_found}")
    print(f"✅ Exploits extraídos: {len(extracted_exploits)}")
    
    # Guardar JSON
    print(f"Guardando en {OUTPUT_FILE}...")
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        json.dump(extracted_exploits, f, indent=2, ensure_ascii=False)
    
    print("✅ Proceso completado.")

if __name__ == "__main__":
    main()
