rules:
  - id: source-controller
    patterns:
      - pattern-either:
          - pattern: |
              @$DECORATOR(...)
              $METHOD(..., $REQ: Request, ...) { ... }
          - pattern: |
              @$DECORATOR(...)
              $METHOD(..., @Body(...) $BODY, ...) { ... }
          - pattern: |
              @$DECORATOR(...)
              $METHOD(..., @Query(...) $QUERY, ...) { ... }
          - pattern: |
              @$DECORATOR(...)
              $METHOD(..., @Param(...) $PARAM, ...) { ... }
          - pattern: |
              app.$METHOD(..., (req, res) => { ... })
    message: "Potential Controller Source detected: $METHOD"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: source
      tags: ["mvc-source"]

  - id: call-service
    patterns:
      - pattern: this.$SERVICE.$METHOD(...)
    message: "Service call detected: $SERVICE.$METHOD"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: call
      tags: ["mvc-call"]

  # Sinks corresponding to the 18 categories
  - id: sink-sql
    patterns:
      - pattern-either:
          - pattern: $DB.query(...)
          - pattern: $DB.execute(...)
          - pattern: $DB.raw(...)
    message: "SQL Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "sql-injection"

  - id: sink-command
    patterns:
      - pattern-either:
          - pattern: exec(...)
          - pattern: spawn(...)
          - pattern: child_process.exec(...)
    message: "Command Injection Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "command-injection"

  - id: sink-code-eval
    patterns:
      - pattern-either:
          - pattern: eval(...)
          - pattern: new Function(...)
          - pattern: vm.run(...)
    message: "Code Injection Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "code-injection"
  
  - id: sink-ssrf
    patterns:
      - pattern-either:
          - pattern: axios.get(...)
          - pattern: axios.post(...)
          - pattern: axios.put(...)
          - pattern: axios.delete(...)
          - pattern: fetch(...)
          - pattern: http.get(...)
          - pattern: http.request(...)
          - pattern: https.get(...)
          - pattern: https.request(...)
    message: "SSRF Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "ssrf"

  - id: sink-path-traversal
    patterns:
      - pattern-either:
          - pattern: fs.readFile(...)
          - pattern: fs.readFileSync(...)
          - pattern: fs.open(...)
          - pattern: fs.openSync(...)
          - pattern: res.sendFile(...)
    message: "Path Traversal Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "path-traversal"

  - id: sink-nosql
    patterns:
      - pattern: '$COLL.find({$where: ...})'
    message: "NoSQL Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "nosql-injection"

  - id: sink-deserialization
    patterns:
      - pattern: node_serialize.unserialize(...)
    message: "Deserialization Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "deserialization"

  - id: sink-proto-pollution
    patterns:
      - pattern-either:
          - pattern: merge(...)
          - pattern: _.merge(...)
          - pattern: Object.assign(...)
          - pattern: extend(...)
    message: "Prototype Pollution Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "prototype-pollution"

  - id: sink-ssti
    patterns:
      - pattern-either:
          - pattern: res.render(...)
          - pattern: pug.render(...)
    message: "SSTI Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "ssti"

  - id: sink-xxe
    patterns:
      - pattern: libxmljs.parseXml(...)
    message: "XXE Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "xxe"

  - id: sink-mass-assignment
    patterns:
      - pattern-either:
          - pattern: $MODEL.create(...)
          - pattern: $REPO.save(...)
    message: "Mass Assignment Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "mass-assignment"

  - id: sink-db-access-by-id
    patterns:
      - pattern-either:
          - pattern: $REPO.findOne(...)
          - pattern: $REPO.delete(...)
    message: "Direct DB Access by ID (Potential BOLA/IDOR)"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "bola-idor"

  - id: sink-csrf-check
    patterns:
      - pattern-either:
          - pattern: app.post(...)
          - pattern: app.put(...)
          - pattern: router.post(...)
          - pattern: router.put(...)
          - pattern: |
              @Post(...)
              $METHOD(...) { ... }
          - pattern: |
              @Put(...)
              $METHOD(...) { ... }
    message: "State-changing route detected (Potential CSRF)"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "csrf"

  - id: sink-file-upload
    patterns:
      - pattern-either:
          - pattern: $FILE.mv(...)
          - pattern: fs.writeFile(...)
    message: "File Upload Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "file-upload"

  - id: sink-weak-crypto
    patterns:
      - pattern-either:
          - pattern: md5(...)
          - pattern: Math.random()
          - pattern: crypto.createHash('md5')
          - pattern: crypto.createHash('sha1')
    message: "Weak Crypto Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "weak-crypto"

  - id: sink-reflected-xss
    patterns:
      - pattern-either:
          - pattern: res.send(...)
          - pattern: res.write(...)
    message: "Reflected XSS Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "reflected-xss"

  - id: sink-log-injection
    patterns:
      - pattern-either:
          - pattern: console.log(...)
          - pattern: logger.info(...)
    message: "Log Injection Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "log-injection"

  - id: sink-open-redirect
    patterns:
      - pattern-either:
          - pattern: res.redirect(...)
    message: "Open Redirect Sink detected"
    languages: [ts, js]
    severity: INFO
    metadata:
      type: sink
      category: "open-redirect"
