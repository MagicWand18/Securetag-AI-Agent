rules:
  - id: source-controller
    patterns:
      - pattern-either:
          - pattern: |
              @RestController
              class $CLASS {
                  ...
                  @$MAPPING(...)
                  public $RET $METHOD(..., $REQ, ...) { ... }
                  ...
              }
          - pattern: |
              @Controller
              class $CLASS {
                  ...
                  @$MAPPING(...)
                  public $RET $METHOD(..., $REQ, ...) { ... }
                  ...
              }
    message: "Potential Controller Source detected: $METHOD"
    languages: [java]
    severity: INFO
    metadata:
      type: source
      tags: ["mvc-source"]

  - id: call-service
    patterns:
      - pattern-either:
          - pattern: this.$SERVICE.$METHOD(...)
          - pattern: $SERVICE.$METHOD(...)
    message: "Service call detected: $SERVICE.$METHOD"
    languages: [java]
    severity: INFO
    metadata:
      type: call
      tags: ["mvc-call"]

  # Sinks (18 categories)
  - id: sink-sql
    patterns:
      - pattern-either:
          - pattern: $EM.createNativeQuery(...)
          - pattern: $STMT.executeQuery(...)
    message: "SQL Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "sql-injection"

  - id: sink-command
    patterns:
      - pattern-either:
          - pattern: Runtime.getRuntime().exec(...)
          - pattern: new ProcessBuilder(...)
    message: "Command Injection Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "command-injection"

  - id: sink-code-eval
    patterns:
      - pattern-either:
          - pattern: $ENGINE.eval(...)
    message: "Code Injection Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "code-injection"

  - id: sink-ssrf
    patterns:
      - pattern-either:
          - pattern: new URL(...).openConnection()
          - pattern: HttpClient.newHttpClient(...)
    message: "SSRF Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "ssrf"

  - id: sink-path-traversal
    patterns:
      - pattern-either:
          - pattern: new FileInputStream(...)
          - pattern: new File(...)
    message: "Path Traversal Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "path-traversal"

  - id: sink-nosql
    patterns:
      - pattern-either:
          - pattern: $MONGO.find(...)
    message: "NoSQL Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "nosql-injection"

  - id: sink-deserialization
    patterns:
      - pattern-either:
          - pattern: new ObjectInputStream(...)
    message: "Deserialization Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "deserialization"

  - id: sink-proto-pollution
    patterns:
      - pattern-either:
          # Java doesn't have prototype pollution in the JS sense, but we can detect unsafe object copying
          - pattern: BeanUtils.copyProperties(...)
    message: "Prototype Pollution (Unsafe Copy) Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "prototype-pollution"

  - id: sink-ssti
    patterns:
      - pattern-either:
          - pattern: $TEMPLATE.process(...)
    message: "SSTI Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "ssti"

  - id: sink-xxe
    patterns:
      - pattern-either:
          - pattern: DocumentBuilderFactory.newInstance(...)
          - pattern: SAXParserFactory.newInstance(...)
    message: "XXE Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "xxe"

  - id: sink-mass-assignment
    patterns:
      - pattern-either:
          - pattern: $REPO.save(...)
    message: "Mass Assignment Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "mass-assignment"

  - id: sink-db-access-by-id
    patterns:
      - pattern-either:
          - pattern: $REPO.findById(...)
          - pattern: $REPO.deleteById(...)
    message: "Direct DB Access by ID (Potential BOLA/IDOR)"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "bola-idor"

  - id: sink-csrf-check
    patterns:
      - pattern-either:
          - pattern: http.csrf().disable()
    message: "CSRF Check Disabled Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "csrf"

  - id: sink-file-upload
    patterns:
      - pattern-either:
          - pattern: $FILE.transferTo(...)
    message: "File Upload Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "file-upload"

  - id: sink-weak-crypto
    patterns:
      - pattern-either:
          - pattern: MessageDigest.getInstance("MD5")
          - pattern: new Random()
    message: "Weak Crypto Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "weak-crypto"

  - id: sink-reflected-xss
    patterns:
      - pattern-either:
          - pattern: response.getWriter().write(...)
    message: "Reflected XSS Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "reflected-xss"

  - id: sink-log-injection
    patterns:
      - pattern-either:
          - pattern: logger.info(...)
          - pattern: System.out.println(...)
    message: "Log Injection Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "log-injection"

  - id: sink-open-redirect
    patterns:
      - pattern-either:
          - pattern: response.sendRedirect(...)
    message: "Open Redirect Sink detected"
    languages: [java]
    severity: INFO
    metadata:
      type: sink
      category: "open-redirect"
