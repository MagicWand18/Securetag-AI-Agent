rules:
- id: synthetic-cve202427443
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible XSS reflejado al construir HTML con datos controlados por el usuario\
    \ (p.ej. req.query/req.body/req.params) mediante template literals o concatenaci\xF3\
    n y enviarlo como 'text/html' (res.send/res.end). Esto es explotable en escenarios\
    \ tipo CVE-2024-27443 (inyecci\xF3n de contenido en UI webmail/calendario), permitiendo\
    \ ejecutar JavaScript en el navegador de la v\xEDctima. Sanitiza/escapa la salida\
    \ o usa un motor de plantillas con auto-escape."
  metadata:
    cwe: 'CWE-79: Improper Neutralization of Input During Web Page Generation (''Cross-site
      Scripting'')'
    owasp: A03:2021 - Injection
    category: security
    technology:
    - javascript
    - typescript
    - nodejs
    likelihood: HIGH
    impact: HIGH
    confidence: MEDIUM
    references:
    - https://nvd.nist.gov/vuln/detail/CVE-2024-27443
  patterns:
  - pattern-inside: "$APP.get($ROUTE, ($REQ, $RES) => {\n  ...\n})\n"
  - pattern-either:
    - patterns:
      - pattern: '$RES.send(`...${$X}...`)

          '
      - metavariable-pattern:
          metavariable: $X
          pattern-either:
          - pattern: $REQ.query.$P
          - pattern: $REQ.body.$P
          - pattern: $REQ.params.$P
          - pattern: $REQ.headers[$H]
          - pattern: $REQ.get($H)
    - patterns:
      - pattern: '$RES.send($A + $X + $B)

          '
      - metavariable-pattern:
          metavariable: $X
          pattern-either:
          - pattern: $REQ.query.$P
          - pattern: $REQ.body.$P
          - pattern: $REQ.params.$P
          - pattern: $REQ.headers[$H]
          - pattern: $REQ.get($H)
    - patterns:
      - pattern: '$HTML = `...${$X}...`

          '
      - pattern: '$RES.send($HTML)

          '
      - metavariable-pattern:
          metavariable: $X
          pattern-either:
          - pattern: $REQ.query.$P
          - pattern: $REQ.body.$P
          - pattern: $REQ.params.$P
          - pattern: $REQ.headers[$H]
          - pattern: $REQ.get($H)
  - pattern-either:
    - pattern: '$RES.set(''Content-Type'', ''text/html; charset=utf-8'')

        '
    - pattern: '$RES.set("Content-Type", "text/html; charset=utf-8")

        '
    - pattern: '$RES.set(''Content-Type'', ''text/html'')

        '
    - pattern: '$RES.set("Content-Type", "text/html")

        '
    - pattern: '$RES.type(''html'')

        '
    - pattern: $RES.type("html")
