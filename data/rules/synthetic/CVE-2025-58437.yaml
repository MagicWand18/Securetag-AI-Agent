rules:
- id: synthetic-cve202558437
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible exposici\xF3n y reutilizaci\xF3n de tokens de sesi\xF3n asociados\
    \ a workspaces preconstruidos (prebuilds). El token de un usuario de sistema (por\
    \ ejemplo \"prebuilds-system-user\") se genera de forma predecible, se persiste\
    \ en plantillas/archivos (p.ej. Terraform) y no se invalida cuando el workspace\
    \ es reclamado por otro usuario, permitiendo que un atacante que obtenga la plantilla\
    \ use ese token para acceder al workspace. Esto es an\xE1logo a CVE-2025-58437,\
    \ donde coder_workspace_owner.session_token queda expuesto en plantillas y sigue\
    \ siendo v\xE1lido tras el reclamo del workspace.\n"
  metadata:
    cve: CVE-2025-58437
    source: CISA_KEV
    category: security
    technology:
    - express
    - nodejs
    references:
    - https://semgrep.dev
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM
    cwe: 'CWE-20: Improper Input Validation'
    owasp: A03:2021 - Injection
  patterns:
  - pattern-either:
    - pattern: 'const $WS = new Map(...);

        '
    - pattern: 'let $WS = new Map(...);

        '
    - pattern: 'var $WS = new Map(...);

        '
  - pattern: "app.post('/prebuilds', ($REQ, $RES) => {\n  ...\n  const $WS_ID = `ws_${...}`;\n\
      \  const $PREBUILD_USER = 'prebuilds-system-user';\n  ...\n  const $SESSION_TOKEN\
      \ = $GEN_FUNC($PREBUILD_USER, $WS_ID);\n  ...\n  const $WS_OBJ = {\n    id:\
      \ $WS_ID,\n    ownerUserId: $PREBUILD_USER,\n    sessionToken: $SESSION_TOKEN,\n\
      \    isPrebuilt: true,\n    ...\n  };\n  ...\n  $WS.set($WS_ID, $WS_OBJ);\n\
      \  ...\n  const $TEMPLATE_DATA = {\n    workspace_id: $WS_ID,\n    coder_workspace_owner:\
      \ {\n      id: $PREBUILD_USER,\n      session_token: $SESSION_TOKEN\n    }\n\
      \  };\n  ...\n});\n"
  - pattern-either:
    - pattern: 'fs.writeFileSync(..., JSON.stringify($TEMPLATE_DATA, ...));

        '
    - pattern: 'fs.writeFile(..., JSON.stringify($TEMPLATE_DATA, ...), ...);

        '
  - pattern: "app.post('/workspaces/:id/claim', ($REQ2, $RES2) => {\n  ...\n  const\
      \ $WORKSPACE_ID = $REQ2.params.id;\n  const $USER_ID = $REQ2.body.userId;\n\
      \  const $WS2 = $WS.get($WORKSPACE_ID);\n  if (! $WS2 || ! $WS2.isPrebuilt)\
      \ {\n    return $RES2.status(404).json(...);\n  }\n  const $NEW_TOKEN = $GEN_FUNC($USER_ID,\
      \ $WORKSPACE_ID);\n  $WS2.ownerUserId = $USER_ID;\n  $WS2.claimedBy = $USER_ID;\n\
      \  $WS2.sessionToken = $NEW_TOKEN;\n  $WS.set($WORKSPACE_ID, $WS2);\n  ...\n\
      });\n"
  - pattern: "app.get('/workspaces/:id', ($REQ3, $RES3) => {\n  ...\n  const $WORKSPACE_ID2\
      \ = $REQ3.params.id;\n  const $TOKEN = $REQ3.headers['x-session-token'];\n \
      \ const $WS3 = $WS.get($WORKSPACE_ID2);\n  if (! $WS3) {\n    return $RES3.status(404).json(...);\n\
      \  }\n  if ($TOKEN !== $WS3.sessionToken) {\n    return $RES3.status(401).json(...);\n\
      \  }\n  $RES3.json(...);\n});"
