rules:
  - id: synthetic-cve202010221
    languages:
      - javascript
      - typescript
    message: >
      Posible inyección de comandos del sistema operativo (OS Command Injection)
      similar a CVE-2020-10221: se construye un comando de shell concatenando
      directamente datos controlados por el usuario (por ejemplo, parámetros de
      una petición HTTP) y se ejecuta con child_process.exec/execSync. Un atacante
      puede cerrar el contexto del comando e inyectar instrucciones arbitrarias
      (p.ej. "fileName=plantilla.txt; rm -rf /"), logrando ejecución remota de
      comandos. Valida y escapa estrictamente los parámetros o usa APIs que no
      invoquen un shell (spawn/execFile con argumentos separados).
    severity: ERROR
    patterns:
      - pattern-inside: |
          $APP.$METHOD($ROUTE, ($REQ, $RES) => {
            ...
          })
      - pattern-either:
          - pattern: |
              const $CMD = `...${$USER}...`;
              ...
              exec($CMD, ...);
          - pattern: |
              let $CMD = `...${$USER}...`;
              ...
              exec($CMD, ...);
          - pattern: |
              var $CMD = `...${$USER}...`;
              ...
              exec($CMD, ...);
          - pattern: |
              const $CMD = "..."+$USER+"...";
              ...
              exec($CMD, ...);
          - pattern: |
              let $CMD = "..."+$USER+"...";
              ...
              exec($CMD, ...);
          - pattern: |
              var $CMD = "..."+$USER+"...";
              ...
              exec($CMD, ...);
          - pattern: |
              exec(`...${$USER}...`, ...);
          - pattern: |
              exec("..."+$USER+"...", ...);
          - pattern: |
              const $CMD = `...${$USER}...`;
              ...
              execSync($CMD, ...);
          - pattern: |
              let $CMD = `...${$USER}...`;
              ...
              execSync($CMD, ...);
          - pattern: |
              var $CMD = `...${$USER}...`;
              ...
              execSync($CMD, ...);
          - pattern: |
              const $CMD = "..."+$USER+"...";
              ...
              execSync($CMD, ...);
          - pattern: |
              let $CMD = "..."+$USER+"...";
              ...
              execSync($CMD, ...);
          - pattern: |
              var $CMD = "..."+$USER+"...";
              ...
              execSync($CMD, ...);
          - pattern: |
              execSync(`...${$USER}...`, ...);
          - pattern: |
              execSync("..."+$USER+"...", ...);
      - pattern-inside: |
          $USER = $REQ.$BODY.$FIELD;
          ...
      - pattern-not: |
          $USER = $SANITIZER(...);
          ...
          exec($CMD, ...);
      - pattern-not: |
          $USER = $SANITIZER(...);
          ...
          execSync($CMD, ...);
    metadata:
      cwe: "CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2020-10221"