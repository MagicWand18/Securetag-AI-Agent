rules:
  - id: synthetic-cve201815811
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Uso de cifrado simétrico débil con clave/IV estáticos para proteger parámetros
      de entrada, similar al patrón explotado en CVE-2018-15811. Un atacante puede
      predecir o reproducir los tokens cifrados, derivar la clave y manipular
      identificadores de usuario u otros parámetros sensibles. Utiliza algoritmos
      modernos (por ejemplo, AES-256-GCM) con claves aleatorias seguras y IVs
      únicos por operación, y evita claves codificadas en el código fuente.
    metadata:
      cwe: "CWE-327: Use of a Broken or Risky Cryptographic Algorithm"
      owasp: "A02:2021 - Cryptographic Failures"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2018-15811"
    patterns:
      # 1) Detect uso de algoritmos de cifrado débiles/obsoletos
      - pattern-either:
          - pattern: crypto.createCipheriv("des-ede3-cbc", ..., ...)
          - pattern: crypto.createDecipheriv("des-ede3-cbc", ..., ...)
          - pattern: crypto.createCipheriv('des-ede3-cbc', ..., ...)
          - pattern: crypto.createDecipheriv('des-ede3-cbc', ..., ...)
          # Variante: algoritmo en variable constante
          - pattern: |
              const $ALGO = "des-ede3-cbc";
              ...
              crypto.createCipheriv($ALGO, ..., ...);
          - pattern: |
              const $ALGO = 'des-ede3-cbc';
              ...
              crypto.createCipheriv($ALGO, ..., ...);
          - pattern: |
              const $ALGO = "des-ede3-cbc";
              ...
              crypto.createDecipheriv($ALGO, ..., ...);
          - pattern: |
              const $ALGO = 'des-ede3-cbc';
              ...
              crypto.createDecipheriv($ALGO, ..., ...);

      # 2) Asegurar que la clave/IV son constantes estáticas (hard-coded)
      - pattern-either:
          # Clave fija como Buffer.from(...)
          - pattern: |
              const $KEY = Buffer.from($VAL, $ENC);
          # IV fijo como Buffer.from(...)
          - pattern: |
              const $IV = Buffer.from($VAL2, $ENC2);

      # 3) Vincular el uso de la clave/IV estáticas con el cifrado débil
      - pattern-either:
          - pattern: |
              const $ALGO = $ALGOVAL;
              const $KEY = Buffer.from($VAL, $ENC);
              const $IV = Buffer.from($VAL2, $ENC2);
              ...
              crypto.createCipheriv($ALGO, $KEY, $IV);
          - pattern: |
              const $ALGO = $ALGOVAL;
              const $KEY = Buffer.from($VAL, $ENC);
              const $IV = Buffer.from($VAL2, $ENC2);
              ...
              crypto.createDecipheriv($ALGO, $KEY, $IV);