rules:
- id: synthetic-cve20235631
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible XSS persistente (CVE-2023-5631): contenido HTML controlado por\
    \ el usuario se almacena y luego se inserta directamente en una respuesta HTML\
    \ sin escape ni sanitizaci\xF3n. Un atacante puede enviar HTML/JavaScript malicioso\
    \ (por ejemplo, en bodyHtml) que se ejecutar\xE1 cada vez que otro usuario visualice\
    \ el mensaje. Valida/sanitiza el HTML o esc\xE1palo antes de interpolarlo en plantillas.\n"
  metadata:
    cve: CVE-2023-5631
    source: CISA_KEV
    category: security
    technology:
    - nodejs
    - express
    vulnerability: xss
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM
    cwe: 'CWE-79: Improper Neutralization of Input During Web Page Generation'
    owasp: A03:2021 - Injection
    references:
    - https://cwe.mitre.org/data/definitions/20.html
  patterns:
  - pattern-either:
    - pattern: '$STORAGE.push({ ..., $FIELD, ... });

        '
    - pattern: '$STORAGE.push({ ..., $FIELD: $VAL, ... });

        '
  - pattern-inside: "app.post(..., (req, res) => {\n  ...\n  const { ..., $FIELD,\
      \ ... } = req.body;\n  ...\n});\n"
  - pattern-either:
    - pattern: "const $HTML = `\n  ...\n  ${$MSG.$FIELD}\n  ...\n`;\n...\nres.send($HTML);\n"
    - pattern: "let $HTML = `\n  ...\n  ${$MSG.$FIELD}\n  ...\n`;\n...\nres.send($HTML);\n"
    - pattern: "var $HTML = `\n  ...\n  ${$MSG.$FIELD}\n  ...\n`;\n...\nres.send($HTML);\n"
  - pattern-inside: "app.get(..., (req, res) => {\n  ...\n  const $MSG = $STORAGE[...];\n\
      \  ...\n});\n"
  - pattern: |
      res.setHeader('Content-Type', 'text/html', ...);
  fix: "Escapa o sanitiza el contenido HTML controlado por el usuario antes de interpolarlo\
    \ en la plantilla (por ejemplo, usando una librer\xEDa de sanitizaci\xF3n de HTML\
    \ o renderizando solo texto plano en lugar de HTML)."
