rules:
- id: synthetic-cve201610033
  languages:
  - javascript
  - typescript
  message: "Posible inyecci\xF3n de comandos tipo CVE-2016-10033: se construye una\
    \ cadena de shell para enviar correo (p.ej. usando `sendmail`) concatenando directamente\
    \ datos controlados por el usuario. Un atacante puede inyectar opciones adicionales\
    \ o comandos arbitrarios en los par\xE1metros de correo (como `to`, `subject`\
    \ o `message`), logrando ejecuci\xF3n remota de comandos. Valida y escapa estrictamente\
    \ los par\xE1metros o usa APIs que no dependan de la construcci\xF3n manual de\
    \ la l\xEDnea de comando.\n"
  severity: ERROR
  metadata:
    cve: CVE-2016-10033
    source: CISA_KEV
    category: command-injection
    technology:
    - nodejs
    - sendmail
    - mailer
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM
    cwe: 'CWE-20: Improper Input Validation'
    owasp: A03:2021 - Injection
    references:
    - https://cwe.mitre.org/data/definitions/20.html
  patterns:
  - pattern-either:
    - pattern: '$EXEC(`... | $SENDMAIL ...`);

        '
    - pattern: '$EXEC("... | " + $SENDMAIL + ...);

        '
    - pattern: '$EXEC($CMD);

        '
  - pattern-inside: 'const { exec, ... } = require(''child_process'');

      ...

      '
  - pattern-inside: '$EXEC = require(''child_process'').exec;

      ...

      '
  - pattern-inside: '$EXEC = require(''child_process'').execSync;

      ...

      '
  - pattern-inside: 'const $HTTP = require(''http'');

      ...

      '
  - pattern-inside: "$HTTP.createServer(($REQ, $RES) => {\n  ...\n});\n"
  - pattern-inside: 'let $BODY = '''';

      $REQ.on(''data'', $CHUNK => { $BODY += $CHUNK; });

      ...

      '
  - pattern-inside: "$REQ.on('end', () => {\n  ...\n  const $DATA = JSON.parse($BODY\
      \ || '{}');\n  ...\n});\n"
  - pattern-inside: 'const $TO = $DATA.to || '''';

      const $SUBJECT = $DATA.subject || '''';

      const $MESSAGE = $DATA.message || '''';

      ...

      '
  - pattern-inside: 'const $CMD = `...${$SUBJECT}...${$TO}...${$MESSAGE}...`;

      ...

      '
  - pattern-either:
    - pattern-inside: 'const $CMD = `... | /usr/sbin/sendmail ...`;

        ...

        '
    - pattern-inside: 'const $CMD = `... | /usr/bin/sendmail ...`;

        ...

        '
    - pattern-inside: 'const $CMD = `... | sendmail ...`;

        ...

        '
    - pattern-inside: 'const $CMD = "..." + "| /usr/sbin/sendmail" + "...";

        ...

        '
    - pattern-inside: 'const $CMD = "..." + "| /usr/bin/sendmail" + "...";

        ...

        '
    - pattern-inside: 'const $CMD = "..." + "| sendmail" + "...";

        ...

        '
  - pattern-not: '$EXEC("sendmail");

      '
  - pattern-not: $EXEC(".../sendmail", ...);
