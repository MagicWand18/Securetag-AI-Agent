rules:
- id: synthetic-cve20259942
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible carga de archivos sin restricciones asociada a CVE-2025-9942:\
    \ se detecta uso de `multer.diskStorage` con `destination` y `filename` personalizados,\
    \ combinado con un endpoint que acepta `upload.single(...)` sin validaci\xF3n\
    \ expl\xEDcita de tipo, extensi\xF3n o tama\xF1o del archivo. Un atacante remoto\
    \ podr\xEDa subir ficheros arbitrarios (por ejemplo, scripts ejecutables o webshells)\
    \ a un directorio del servidor, lo que puede derivar en ejecuci\xF3n de c\xF3\
    digo, sobreescritura de archivos o exposici\xF3n de datos sensibles. Revise que:\
    \ - se limite el tipo de archivo (mimetype/extensi\xF3n), - se impongan l\xED\
    mites de tama\xF1o, - se renombre el archivo de forma segura, - y el directorio\
    \ de subida no sea accesible directamente desde la web.\n"
  metadata:
    cve: CVE-2025-9942
    source: CISA_KEV
    category: security
    technology:
    - nodejs
    - express
    - multer
    likelihood: high
    impact: high
    references:
    - https://www.npmjs.com/package/multer
    confidence: MEDIUM
    cwe: 'CWE-20: Improper Input Validation'
    owasp: A03:2021 - Injection
  patterns:
  - pattern-either:
    - pattern: "const $M = require('multer');\n...\nconst $STORAGE = $M.diskStorage({\n\
        \  destination: (req, file, cb) => {\n    cb(null, $UPLOAD_DIR);\n  },\n \
        \ filename: (req, file, cb) => {\n    cb(null, file.originalname);\n  }\n\
        });\nconst $UPLOAD = $M({ storage: $STORAGE });\n"
    - pattern: "import $M from 'multer';\n...\nconst $STORAGE = $M.diskStorage({\n\
        \  destination: (req, file, cb) => {\n    cb(null, $UPLOAD_DIR);\n  },\n \
        \ filename: (req, file, cb) => {\n    cb(null, file.originalname);\n  }\n\
        });\nconst $UPLOAD = $M({ storage: $STORAGE });\n"
  - pattern-either:
    - pattern: "const $EXP = require('express');\n...\nconst $APP = $EXP();\n...\n\
        $APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), (req, res) => {\n  ...\n});\n"
    - pattern: "import $EXP from 'express';\n...\nconst $APP = $EXP();\n...\n$APP.$METHOD($ROUTE,\
        \ $UPLOAD.single($FIELD), (req, res) => {\n  ...\n});\n"
  fix: "Use `multer` con validaci\xF3n estricta de tipo y tama\xF1o (por ejemplo,\
    \ usando `fileFilter` y `limits`), renombre los archivos con identificadores generados\
    \ de forma segura en lugar de `file.originalname`, y aseg\xFArese de que el directorio\
    \ de subida no sea servible directamente por el servidor web."
