rules:
- id: synthetic-cve202336846
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible subida arbitraria de ficheros sin autenticaci\xF3n ni validaci\xF3\
    n usando express-fileupload. CVE-2023-36846 describe escenarios donde un endpoint\
    \ accesible sin control de acceso permite a un atacante subir ficheros controlados\
    \ (nombre, tipo y contenido) a directorios dentro de la aplicaci\xF3n (p.ej. `public/uploads`),\
    \ lo que facilita ejecuci\xF3n de c\xF3digo, plantillas maliciosas o sobrescritura\
    \ de recursos. Asegura autenticaci\xF3n, validaci\xF3n estricta de tipo/extensi\xF3\
    n, saneo de nombre de fichero y restricciones de ruta antes de llamar a `mv()`\
    \ o m\xE9todos equivalentes.\n"
  metadata:
    cve: CVE-2023-36846
    source: CISA_KEV
    category: file-upload
    likelihood: high
    references:
    - https://www.cisa.gov/known-exploited-vulnerabilities-catalog
    technology:
    - javascript
    - typescript
    - nodejs
    impact: HIGH
    confidence: MEDIUM
    cwe: 'CWE-20: Improper Input Validation'
    owasp: A03:2021 - Injection
  patterns:
  - pattern-either:
    - pattern: "const express = require('express');\nconst fileUpload = require('express-fileupload');\n\
        ...\nconst app = express();\napp.use(fileUpload(...));\n...\napp.$METHOD($ROUTE,\
        \ ($REQ, $RES) => {\n  ...\n  if (!$REQ.files || !$REQ.files.$FILE) {\n  \
        \  ...\n  }\n  const $UPLOADED = $REQ.files.$FILE;\n  ...\n  $UPLOADED.mv($TARGET,\
        \ ...);\n  ...\n});\n"
    - pattern: "const express = require('express');\nconst fileUpload = require('express-fileupload');\n\
        ...\nconst app = express();\napp.use(fileUpload(...));\n...\napp.$METHOD($ROUTE,\
        \ async ($REQ, $RES) => {\n  ...\n  if (!$REQ.files || !$REQ.files.$FILE)\
        \ {\n    ...\n  }\n  const $UPLOADED = $REQ.files.$FILE;\n  ...\n  $UPLOADED.mv($TARGET,\
        \ ...);\n  ...\n});\n"
  - metavariable-pattern:
      metavariable: $METHOD
      pattern-either:
      - pattern: post
      - pattern: all
  - metavariable-pattern:
      metavariable: $ROUTE
      pattern-either:
      - pattern: '''/user.php'''
      - pattern: '''/upload'''
      - pattern: '''/upload.php'''
      - pattern: '''/file'''
      - pattern: '''/files'''
  - pattern-not: |
      app.$METHOD($ROUTE, ($REQ, $RES) => {
        if ($REQ.user || $REQ.isAuthenticated && $REQ.isAuthenticated()) {
          ...
        }
        ...
      })
  - pattern-not: |
      app.$METHOD($ROUTE, ($REQ, $RES, $NEXT) => {
        if ($REQ.user || $REQ.isAuthenticated && $REQ.isAuthenticated()) {
          ...
        }
        ...
      })
