rules:
- id: synthetic-cve20246670
  languages:
  - javascript
  - typescript
  message: "Posible inyecci\xF3n SQL similar a CVE-2024-6670: se construye una consulta\
    \ SQL concatenando directamente par\xE1metros controlados por el usuario (por\
    \ ejemplo, username/password de un endpoint de login) en un SELECT sobre la tabla\
    \ de usuarios. Un atacante no autenticado puede manipular el valor de estos par\xE1\
    metros (por ejemplo, con ' OR '1'='1 o UNION SELECT ...) para extraer credenciales\
    \ cifradas u otros datos sensibles del \xFAnico usuario configurado. Usa siempre\
    \ consultas parametrizadas/preparadas en lugar de concatenar cadenas SQL.\n"
  severity: ERROR
  metadata:
    cwe: 'CWE-89: Improper Neutralization of Special Elements used in an SQL Command
      (''SQL Injection'')'
    owasp: A03:2021 - Injection
    category: security
    technology:
    - javascript
    - typescript
    - nodejs
    likelihood: HIGH
    impact: HIGH
    confidence: MEDIUM
    references:
    - https://nvd.nist.gov/vuln/detail/CVE-2024-6670
  patterns:
  - pattern-inside: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n})\n"
  - pattern-either:
    - pattern: 'const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COND`;

        '
    - pattern: 'let $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COND`;

        '
    - pattern: 'var $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $COND`;

        '
    - pattern: 'const $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE "
        + $COND;

        '
    - pattern: 'let $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " +
        $COND;

        '
    - pattern: 'var $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " +
        $COND;

        '
  - pattern-either:
    - pattern: 'const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = ''${$REQ.body.$PARAM}''
        AND $FIELD2 = ''${$REQ.body.$PARAM2}''`;

        '
    - pattern: 'let $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = ''${$REQ.body.$PARAM}''
        AND $FIELD2 = ''${$REQ.body.$PARAM2}''`;

        '
    - pattern: 'var $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = ''${$REQ.body.$PARAM}''
        AND $FIELD2 = ''${$REQ.body.$PARAM2}''`;

        '
    - pattern: 'const $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = ''${$REQ.body.$PARAM}''`;

        '
    - pattern: 'let $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = ''${$REQ.body.$PARAM}''`;

        '
    - pattern: 'var $SQL = `SELECT $COLUMNS FROM $TABLE WHERE $FIELD = ''${$REQ.body.$PARAM}''`;

        '
    - pattern: 'const $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE "
        + $FIELD + " = ''" + $REQ.body.$PARAM + "''";

        '
    - pattern: 'let $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " +
        $FIELD + " = ''" + $REQ.body.$PARAM + "''";

        '
    - pattern: 'var $SQL = "SELECT " + $COLUMNS + " FROM " + $TABLE + " WHERE " +
        $FIELD + " = ''" + $REQ.body.$PARAM + "''";

        '
  - pattern-either:
    - pattern: '$DB.query($SQL, ...);

        '
    - pattern: '$DB.execute($SQL, ...);

        '
    - pattern: "$DB.query($SQL, ($ERR, $RESULTS) => {\n  ...\n});\n"
    - pattern: "$DB.execute($SQL, ($ERR, $RESULTS) => {\n  ...\n})"
