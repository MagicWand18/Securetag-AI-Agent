rules:
- id: synthetic-cve20259941
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible carga de archivos insegura asociada a CVE-2025-9941: se usa `multer.diskStorage`\
    \ para guardar archivos subidos en un directorio accesible p\xFAblicamente usando\
    \ `file.originalname` como nombre final, sin validaci\xF3n de tipo, tama\xF1o\
    \ o extensi\xF3n. Un atacante puede subir archivos maliciosos (por ejemplo, scripts\
    \ ejecutables) y acceder a ellos directamente v\xEDa HTTP, lo que puede derivar\
    \ en ejecuci\xF3n de c\xF3digo, defacement o exfiltraci\xF3n de datos. Valida\
    \ estrictamente el tipo de archivo, tama\xF1o, extensi\xF3n y evita usar el nombre\
    \ original del archivo en rutas p\xFAblicas.\n"
  metadata:
    cve: CVE-2025-9941
    source: CISA_KEV
    category: security
    technology:
    - express
    - nodejs
    - multer
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM
    cwe: 'CWE-20: Improper Input Validation'
    owasp: A03:2021 - Injection
    references:
    - https://cwe.mitre.org/data/definitions/20.html
  patterns:
  - pattern-either:
    - pattern: |
        $M.diskStorage({
          destination: function ($REQ, $FILE, $CB) {
            $CB(null, $DEST);
          },
          filename: function ($REQ2, $FILE2, $CB2) {
            $CB2(null, $FILE2.originalname);
          }
        });
    - pattern: |
        $MULTER.diskStorage({
          ...,
          filename: function ($REQ, $FILE, $CB) {
            $CB(..., $FILE.originalname);
          }
        })
  - pattern-either:
    - pattern: "$APP.post($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES) => {\n  ...\n\
        })\n"
    - pattern: "$APP.post($ROUTE, $UPLOAD.single($FIELD), function ($REQ, $RES) {\n\
        \  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), ($REQ, $RES) => {\n \
        \ ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, $UPLOAD.single($FIELD), function ($REQ, $RES)\
        \ {\n  ...\n})\n"
  fix: "No uses `file.originalname` directamente como nombre final ni guardes archivos\
    \ subidos en rutas p\xFAblicas sin validaci\xF3n. Genera nombres aleatorios seguros,\
    \ aplica filtros de tipo MIME/extensi\xF3n, l\xEDmites de tama\xF1o y, si es posible,\
    \ almacena los archivos fuera del \xE1rbol p\xFAblico de la aplicaci\xF3n."
