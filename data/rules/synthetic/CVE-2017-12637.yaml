rules:
  - id: synthetic-cve201712637
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Posible vulnerabilidad de path traversal similar a CVE-2017-12637:
      se construye una ruta de archivo usando `path.join` con un directorio base
      y un valor potencialmente controlado por el usuario (por ejemplo, un
      parámetro de query como `file`), y luego se pasa directamente a
      `fs.readFile`/`fs.readFileSync` sin validación ni normalización adicional.
      Un atacante puede usar secuencias como "../" para escapar del directorio
      previsto y leer archivos arbitrarios, como ocurrió en CVE-2017-12637
      (exposición de ficheros sensibles vía parámetro `file` en un endpoint JS).
    metadata:
      cwe: "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2017-12637"
    patterns:
      # Aseguramos que se está usando fs.*readFile* en el archivo
      - pattern-inside: |
          const $FS = require('fs');
          ...
      # Aseguramos que se está usando path.join para construir rutas
      - pattern-inside: |
          const $PATH = require('path');
          ...
      # Patrón principal: ruta construida con path.join(baseDir, algo)
      # y luego usada directamente en fs.readFile / fs.readFileSync
      - pattern-either:
          - pattern: |
              const $BASE_DIR = $PATH.join($DIRNAME, $SUBDIR);
              ...
              const $REQ_FILE = $EXPR;
              ...
              const $FILE_PATH = $PATH.join($BASE_DIR, $REQ_FILE);
              ...
              $FS.readFile($FILE_PATH, $ENCODING, $CB);
          - pattern: |
              const $BASE_DIR = $PATH.join($DIRNAME, $SUBDIR);
              ...
              const $REQ_FILE = $EXPR;
              ...
              const $FILE_PATH = $PATH.join($BASE_DIR, $REQ_FILE);
              ...
              $FS.readFileSync($FILE_PATH, $ENCODING);
          - pattern: |
              const $BASE_DIR = $PATH.join($DIRNAME, $SUBDIR);
              ...
              const $FILE_PATH = $PATH.join($BASE_DIR, $REQ_FILE);
              ...
              $FS.readFile($FILE_PATH, $ENCODING, $CB);
          - pattern: |
              const $BASE_DIR = $PATH.join($DIRNAME, $SUBDIR);
              ...
              const $FILE_PATH = $PATH.join($BASE_DIR, $REQ_FILE);
              ...
              $FS.readFileSync($FILE_PATH, $ENCODING)