rules:
- id: synthetic-cve20256554
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Ejecuci\xF3n de c\xF3digo JavaScript controlado por el usuario mediante\
    \ `vm.runInNewContext` con un sandbox laxo. Esto permite que un atacante env\xED\
    e HTML/JS especialmente dise\xF1ado (por ejemplo, dentro de `<script>...</script>`)\
    \ que se ejecuta directamente en el motor V8. En presencia de vulnerabilidades\
    \ del motor (p.ej. type confusion), este patr\xF3n puede permitir escape de sandbox\
    \ y lectura/escritura arbitraria de memoria, como en CVE-2025-6554. Valida, restringe\
    \ o elimina la ejecuci\xF3n directa de c\xF3digo proporcionado por el usuario.\n"
  metadata:
    cve: CVE-2025-6554
    source: CISA_KEV
    category: security
    technology:
    - nodejs
    - vm
    cwe:
    - CWE-94
    - CWE-95
    references:
    - https://nodejs.org/api/vm.html
    likelihood: MEDIUM
    impact: HIGH
    confidence: MEDIUM
    owasp: A03:2021 - Injection
  patterns:
  - pattern-either:
    - pattern: 'vm.runInNewContext($USER_CODE, $SANDBOX, $OPTS)

        '
    - pattern: '$VM.runInNewContext($USER_CODE, $SANDBOX, $OPTS)

        '
  - pattern-inside: 'const $VM = require(''vm'');

      ...

      '
  - pattern-not: 'vm.runInNewContext($USER_CODE, $SANDBOX, { ...secureContext })

      '
  - metavariable-pattern:
      metavariable: $USER_CODE
      pattern: $REQ_BODY
  - pattern-inside: "$SERVER = require('http');\n...\n$SERVER.createServer(($REQ,\
      \ $RES) => {\n  ...\n})\n"
  fix: "Evita ejecutar c\xF3digo controlado por el usuario con `vm.runInNewContext`.\
    \ En su lugar, usa un motor de plantillas seguro, una lista blanca de operaciones\
    \ o un int\xE9rprete restringido. Si necesitas aislamiento, considera procesos\
    \ separados con l\xEDmites estrictos en lugar de `vm`."
