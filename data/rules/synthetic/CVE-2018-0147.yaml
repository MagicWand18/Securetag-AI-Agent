rules:
  - id: synthetic-cve20180147
    languages:
      - javascript
      - typescript
    message: >
      Uso inseguro de `vm.runInThisContext` con datos potencialmente controlados por el usuario.
      Esto puede permitir ejecución remota de código (RCE) de forma similar a CVE-2018-0147,
      donde datos deserializados o interpretados como código desde la entrada del cliente
      se ejecutan en el contexto de la aplicación. Valida, restringe o evita ejecutar
      directamente código proveniente de la entrada del usuario.
    severity: ERROR
    patterns:
      - pattern-inside: |
          const vm = require('vm');
          ...
      - pattern: |
          vm.runInThisContext($PAYLOAD)
      - pattern-not: |
          vm.runInThisContext("..." )
      - pattern-not: |
          vm.runInThisContext('...' )
    metadata:
      cwe: "CWE-94: Improper Control of Generation of Code ('Code Injection')"
      owasp: "A03:2021 - Injection"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2018-0147"