rules:
- id: synthetic-cve202120123
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: 'Posible Path Traversal (CVE-2021-20123): se construye una ruta de archivo
    a partir de entrada controlada por el usuario (p.ej., req.query/req.params/req.body)
    y luego se lee el archivo (fs.readFile / readFileSync / createReadStream) sin
    validar que la ruta resultante permanezca dentro de un directorio base. Esto permite
    usar secuencias como "../" para acceder a archivos arbitrarios y es altamente
    explotable (probabilidad 94%).'
  metadata:
    cwe: 'CWE-22: Improper Limitation of a Pathname to a Restricted Directory (''Path
      Traversal'')'
    owasp: A01:2021 - Broken Access Control
    category: security
    technology:
    - javascript
    - typescript
    - nodejs
    likelihood: HIGH
    impact: HIGH
    confidence: MEDIUM
    references:
    - https://nvd.nist.gov/vuln/detail/CVE-2021-20123
  pattern-either:
  - patterns:
    - pattern-inside: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n})\n"
    - pattern: '$TARGET = $PATH.join($BASE, $USER_INPUT)

        '
    - metavariable-regex:
        metavariable: $USER_INPUT
        regex: ^(\$REQ\.(query|params|body)(\.[A-Za-z0-9_$]+)?|\$REQ\[['"](query|params|body)['"]\](\[[^\]]+\])?)$
    - pattern-either:
      - pattern: $FS.readFile($TARGET, ...)
      - pattern: $FS.readFileSync($TARGET, ...)
      - pattern: $FS.createReadStream($TARGET, ...)
      - pattern: $FS.open($TARGET, ...)
      - pattern: $FS.openSync($TARGET, ...)
    - pattern-not: 'if (!$TARGET.startsWith($BASE)) { ... }

        '
  - patterns:
    - pattern-inside: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n})\n"
    - pattern: '$TARGET = $PATH.resolve($BASE, $USER_INPUT)

        '
    - metavariable-regex:
        metavariable: $USER_INPUT
        regex: ^(\$REQ\.(query|params|body)(\.[A-Za-z0-9_$]+)?|\$REQ\[['"](query|params|body)['"]\](\[[^\]]+\])?)$
    - pattern-either:
      - pattern: $FS.readFile($TARGET, ...)
      - pattern: $FS.readFileSync($TARGET, ...)
      - pattern: $FS.createReadStream($TARGET, ...)
      - pattern: $FS.open($TARGET, ...)
      - pattern: $FS.openSync($TARGET, ...)
    - pattern-not: 'if (!$TARGET.startsWith($BASE)) { ... }

        '
  - patterns:
    - pattern-inside: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n})\n"
    - pattern-either:
      - pattern: $FS.readFile($PATH.join($BASE, $USER_INPUT), ...)
      - pattern: $FS.readFileSync($PATH.join($BASE, $USER_INPUT), ...)
      - pattern: $FS.createReadStream($PATH.join($BASE, $USER_INPUT), ...)
      - pattern: $FS.open($PATH.join($BASE, $USER_INPUT), ...)
      - pattern: $FS.openSync($PATH.join($BASE, $USER_INPUT), ...)
      - pattern: $FS.readFile($PATH.resolve($BASE, $USER_INPUT), ...)
      - pattern: $FS.readFileSync($PATH.resolve($BASE, $USER_INPUT), ...)
      - pattern: $FS.createReadStream($PATH.resolve($BASE, $USER_INPUT), ...)
      - pattern: $FS.open($PATH.resolve($BASE, $USER_INPUT), ...)
      - pattern: $FS.openSync($PATH.resolve($BASE, $USER_INPUT), ...)
    - metavariable-regex:
        metavariable: $USER_INPUT
        regex: ^(\$REQ\.(query|params|body)(\.[A-Za-z0-9_$]+)?|\$REQ\[['"](query|params|body)['"]\](\[[^\]]+\])?)$
