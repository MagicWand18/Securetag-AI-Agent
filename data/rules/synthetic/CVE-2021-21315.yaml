rules:
- id: synthetic-cve202121315
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible carga din\xE1mica de m\xF3dulos controlada por el usuario (CVE-2021-21315).\
    \ El valor proveniente de la entrada del usuario se usa directamente en `require(...)`\
    \ sin validaci\xF3n ni lista blanca, lo que permite a un atacante cargar m\xF3\
    dulos arbitrarios del sistema (por ejemplo, `child_process`) o rutas relativas\
    \ para ejecutar c\xF3digo arbitrario en el servidor. Valida y restringe estrictamente\
    \ los m\xF3dulos permitidos (lista blanca est\xE1tica) o evita el `require` din\xE1\
    mico.\n"
  metadata:
    cve: CVE-2021-21315
    source: CISA_KEV
    category: security
    technology:
    - nodejs
    - express
    likelihood: high
    impact: high
    references:
    - https://nvd.nist.gov/vuln/detail/CVE-2021-21315
    confidence: MEDIUM
    cwe: 'CWE-20: Improper Input Validation'
    owasp: A03:2021 - Injection
  patterns:
  - pattern-either:
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const $DATA = $REQ.body;\n\
        \  ...\n  const $PLUGIN_PATH = $DATA.$FIELD;\n  ...\n  require($PLUGIN_PATH);\n\
        \  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const $PLUGIN_PATH\
        \ = $REQ.body.$FIELD;\n  ...\n  require($PLUGIN_PATH);\n  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const $DATA = $REQ.query;\n\
        \  ...\n  const $PLUGIN_PATH = $DATA.$FIELD;\n  ...\n  require($PLUGIN_PATH);\n\
        \  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const $PLUGIN_PATH\
        \ = $REQ.query.$FIELD;\n  ...\n  require($PLUGIN_PATH);\n  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const $DATA = $REQ.params;\n\
        \  ...\n  const $PLUGIN_PATH = $DATA.$FIELD;\n  ...\n  require($PLUGIN_PATH);\n\
        \  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const $PLUGIN_PATH\
        \ = $REQ.params.$FIELD;\n  ...\n  require($PLUGIN_PATH);\n  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const { $FIELD, ...$REST\
        \ } = $REQ.body;\n  ...\n  const $PLUGIN_PATH = $FIELD;\n  ...\n  require($PLUGIN_PATH);\n\
        \  ...\n})\n"
    - pattern: "$APP.$METHOD($ROUTE, ($REQ, $RES) => {\n  ...\n  const { $FIELD, ...$REST\
        \ } = $REQ.body || {};\n  ...\n  const $PLUGIN_PATH = $FIELD;\n  ...\n  require($PLUGIN_PATH);\n\
        \  ...\n})\n"
  fix: "No uses directamente valores de req.body/req.query/req.params en require().\
    \ Define una lista blanca est\xE1tica de m\xF3dulos permitidos y selecciona el\
    \ m\xF3dulo a partir de esa lista, o elimina el uso de require din\xE1mico controlado\
    \ por el usuario."
