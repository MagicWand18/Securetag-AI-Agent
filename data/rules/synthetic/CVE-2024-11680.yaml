rules:
  - id: synthetic-cve202411680
    languages:
      - javascript
      - typescript
    severity: ERROR
    message: >
      Endpoint de configuración sin autenticación ni control de acceso que mezcla
      ciegamente req.body en una configuración global y la persiste en disco.
      Este patrón reproduce CVE-2024-11680: un endpoint tipo "options" expone
      parámetros críticos (p.ej. allowRegistrations, rutas de subida, flags de
      seguridad) a cualquier usuario remoto, permitiendo activar funciones
      peligrosas o modificar rutas usadas posteriormente por otros endpoints.
      Asegura autenticación/autorización estricta, valida y limita los campos
      permitidos y evita persistir configuraciones sensibles desde datos de
      usuario sin controles.
    patterns:
      # 1) Debe ser un handler POST de Express (o framework similar)
      - pattern: |
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
          })

      # 2) Dentro del handler: tomar directamente req.body como "nueva configuración"
      - pattern-inside: |
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
            $NEWOPTS = $REQ.body;
            ...
          })

      # 3) Mezcla ciega de la configuración global con los datos de la petición
      #    usando spread o asignación directa (Object.assign / = { ...old, ...new })
      - pattern-either:
          - pattern-inside: |
              $APP.post($ROUTE, ($REQ, $RES) => {
                ...
                $NEWOPTS = $REQ.body;
                ...
                $CONFIG = {
                  ...$CONFIG,
                  ...$NEWOPTS
                };
                ...
              })
          - pattern-inside: |
              $APP.post($ROUTE, ($REQ, $RES) => {
                ...
                $NEWOPTS = $REQ.body;
                ...
                Object.assign($CONFIG, $NEWOPTS);
                ...
              })

      # 4) Persistencia en disco de la configuración resultante
      - pattern-inside: |
          const $FS = require('fs');
          ...
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
            $FS.writeFileSync($PATH, JSON.stringify($CONFIG, ...), ...);
            ...
          })

      # 5) No debe haber ninguna comprobación de autenticación/autorización básica
      #    en el handler (evita falsos positivos cuando hay controles explícitos)
      - pattern-not: |
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
            if ($REQ.user && $REQ.user.isAdmin) {
              ...
            }
            ...
          })
      - pattern-not: |
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
            if (!$REQ.isAuthenticated()) {
              ...
            }
            ...
          })
      - pattern-not: |
          $APP.post($ROUTE, ($REQ, $RES) => {
            ...
            if (!$REQ.user) {
              ...
            }
            ...
          })

    metadata:
      cwe: "CWE-284: Improper Access Control"
      owasp: "A01:2021 - Broken Access Control"
      category: "security"
      technology:
        - javascript
        - typescript
        - nodejs
      likelihood: "HIGH"
      impact: "HIGH"
      confidence: "MEDIUM"
      references:
        - "https://nvd.nist.gov/vuln/detail/CVE-2024-11680"