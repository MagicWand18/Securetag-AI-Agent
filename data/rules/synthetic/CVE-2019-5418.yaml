rules:
- id: synthetic-cve20195418
  languages:
  - javascript
  - typescript
  severity: ERROR
  message: "Posible vulnerabilidad similar a CVE-2019-5418: contenido de archivos\
    \ se lee desde el sistema de ficheros usando rutas derivadas directa o indirectamente\
    \ de cabeceras HTTP (por ejemplo, 'Accept') y se env\xEDa sin validaci\xF3n al\
    \ cliente. Esto puede permitir path traversal y divulgaci\xF3n arbitraria de archivos\
    \ si un atacante controla el valor de la cabecera. Valida y restringe estrictamente\
    \ las rutas permitidas antes de leer y devolver archivos.\n"
  metadata:
    cve: CVE-2019-5418
    source: CISA_KEV
    category: security
    technology:
    - nodejs
    - express
    likelihood: HIGH
    impact: HIGH
    vulnerability_class:
    - Path Traversal
    - File Disclosure
    confidence: MEDIUM
    cwe: 'CWE-22: Improper Limitation of a Pathname to a Restricted Directory'
    owasp: A01:2021 - Broken Access Control
    references:
    - https://cwe.mitre.org/data/definitions/20.html
  patterns:
  - pattern-either:
    - pattern: '$FS.readFile($PATH, ...);

        '
    - pattern: '$FS.readFileSync($PATH, ...);

        '
  - pattern-inside: "app.$METHOD($ROUTE, ($REQ, $RES, ... ) => {\n  ...\n});\n"
  - pattern-inside: 'const express = require(''express'');

      ...

      '
  - pattern-inside: 'const $REQ_HEADERS = $REQ.headers;

      ...

      '
  - pattern-either:
    - pattern-inside: 'const $HDR = $REQ.headers[$KEY];

        ...

        '
    - pattern-inside: 'const $HDR = $REQ.headers[$KEY] || $FALLBACK;

        ...

        '
  - pattern-either:
    - pattern-inside: 'const $HDR = $REQ.headers[$KEY] || $FALLBACK;

        ...

        const $TEMPLATE = $HDR.split('','')[0].trim();

        ...

        const $PATH = $PATHLIB.join($BASE, $TEMPLATE);

        ...

        '
    - pattern-inside: 'const $HDR = $REQ.headers[$KEY] || $FALLBACK;

        ...

        const $PATH = $PATHLIB.join($BASE, $HDR);

        ...

        '
  - metavariable-pattern:
      metavariable: $FS
      pattern: 'require(''fs'')

        '
  - metavariable-pattern:
      metavariable: $PATHLIB
      pattern: require('path')
