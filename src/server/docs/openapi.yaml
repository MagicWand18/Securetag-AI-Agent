openapi: 3.0.0
info:
  title: SecureTag AI API
  description: |
    # SecureTag AI - Documentación Técnica y Guía de Integración

    Bienvenido a la documentación oficial de SecureTag AI. Esta guía detalla la arquitectura, capacidades, seguridad y proceso de integración de nuestra plataforma de Auditoría de Código de Nueva Generación (Next-Gen SAST).

    ---

    ## 1. Visión General

    SecureTag AI redefine el análisis estático de seguridad (SAST) combinando herramientas de escaneo líderes en la industria con un motor de Inteligencia Artificial Cognitiva.

    A diferencia de los escáneres tradicionales, SecureTag AI:
    1.  **Detecta** vulnerabilidades en el código fuente.
    2.  **Analiza** el contexto arquitectónico mediante IA.
    3.  **Valida** los hallazgos para reducir falsos positivos.
    4.  **Recomienda** soluciones precisas y accionables.

    ---

    ## 2. Arquitectura y Seguridad

    Su instancia de SecureTag AI opera bajo una arquitectura de aislamiento estricto ("Tenant Isolation"), garantizando que sus datos y código permanezcan protegidos.

    ### 2.1 Componentes del Sistema
    *   **SecureTag API**: Puerta de enlace segura para la gestión de auditorías.
    *   **Analysis Engine**: Orquestador de herramientas SAST con capacidad de "Resilient Scanning" para grandes repositorios.
    *   **AI Security Core**: Modelo cognitivo (`securetag-v1`) optimizado para ciberseguridad, alojado en infraestructura privada (GPU).
    *   **Automated Research Pipeline**: Sistema de detección de amenazas Zero-Day que monitorea fuentes globales y genera reglas de detección proactivas.

    ### 2.2 Seguridad de Infraestructura y Datos
    *   **Aislamiento de Red**: Base de datos y componentes críticos en red privada sin exposición pública.
    *   **Contenedores Endurecidos**: Procesos ejecutados sin privilegios (non-root).
    *   **Protección de Datos**: Migraciones atómicas y backups diarios cifrados (AES-256).

    ### 2.3 Seguridad Aplicativa (AppSec)

    SecureTag implementa una defensa en profundidad para proteger su instancia y sus datos.

    1.  **Headers Defensivos**:
        *   Todas las respuestas incluyen cabeceras de seguridad de grado bancario (`HSTS`, `CSP` estricto, `X-XSS-Protection`) para proteger a los usuarios.

    2.  **Rate Limiting Inteligente**:
        *   Protección global contra ataques de denegación de servicio (DoS).
        *   Límites estrictos en endpoints sensibles (ej. subida de archivos) para evitar abusos.

    3.  **Validación de Archivos**:
        *   **Integridad**: Verificación de *Magic Bytes* para asegurar que solo archivos ZIP válidos sean procesados.
        *   **Reputación Global**: Consulta a redes de inteligencia de amenazas para detectar y bloquear archivos con malware conocido antes de aceptarlos.

    4.  **Política de Protección Activa (Advanced Banning)**:
        Sistema de "Tolerancia Cero" con modelo *Fail Fast*:
        *   **IP Address**: Bloqueo de infraestructura en la puerta de entrada (Latencia cero).
        *   **Credenciales (API Key)**: Inhabilitación automática de la llave utilizada.
        *   **Cuenta (Tenant)**: Suspensión preventiva de la organización en casos graves.
        *   **Identidad de Usuario (Strike System)**: Mecanismo de "Three-Strikes" donde infracciones menores se acumulan; al superar el umbral, se bloquea al usuario y se revocan sus sesiones activas.

    5.  **Auditoría de Inteligencia Artificial (AI Guardrails)**:
        *   **Protección contra Manipulación**: Detección de intentos de *Prompt Injection* o *Jailbreaking* en el contexto proporcionado.
        *   **Registro Forense**: Todo intento de ataque se registra en un log inmutable (`security_events`).
        *   **Respuesta Activa**: Inhabilitación automática de la API Key por 24 horas ante ataques confirmados contra la IA.

    ---

    ## 3. Capacidades Principales (Core Capabilities)

    ### Análisis Estático Profundo (SAST)
    Detección exhaustiva de vulnerabilidades en código fuente con soporte para múltiples lenguajes (TypeScript, Python, Java, etc.).

    ### Context-Aware Analysis
    El motor de IA analiza la arquitectura del proyecto (frameworks, librerías, patrones) para entender el contexto antes de auditar, mejorando la precisión de los resultados.

    ### Deep Code Vision
    *Exclusivo Plan Enterprise*
    Extiende la ventana de contexto de la IA para analizar el código circundante (importaciones, validaciones previas), permitiendo distinguir vulnerabilidades reales de falsos positivos con precisión humana.

    ### Architectural Flow (Cross-file Analysis)
    *Exclusivo Plan Enterprise*
    Motor de rastreo de flujo de datos entre archivos capaz de detectar cadenas de ataque complejas que atraviesan múltiples capas de la aplicación (ej. Controlador -> Servicio -> Base de Datos).

    ### Global Threat Intelligence
    Integración con el *Automated Research Pipeline* para la detección de vulnerabilidades recientes (Zero-Day) mediante reglas sintéticas generadas automáticamente a partir de inteligencia de amenazas global.

    ---

    ## 4. Inteligencia Avanzada (Advanced Intelligence)

    Funcionalidades potenciadas por IA que requieren el uso de **Security Credits**.

    ### 4.1 AI Double Check ("Segunda Opinión")
    *Disponible para todos los planes (Free, Premium, Enterprise)*

    Somete los hallazgos críticos a un panel de IAs externas de clase mundial para una validación adicional.

    **Costos (Créditos por hallazgo):**
    *   **Standard (1 crédito)**: Modelos de alta eficiencia. Ideal para CI/CD.
    *   **Pro (2 créditos)**: Razonamiento avanzado. Ideal para auditorías.
    *   **Max (3 créditos)**: Razonamiento SOTA (State-of-the-Art). Ideal para infraestructura crítica.

    ### 4.2 Generative Custom Rules
    *Disponible para planes Premium y Enterprise*

    Motor de generación de reglas SAST a medida, basado en el stack tecnológico específico de su proyecto.

    **Modelos Disponibles:**
    *   **Plan Premium**: Modelos `standard` y `pro`.
    *   **Plan Enterprise**: Modelos `standard`, `pro` y `max`.

    **Estructura de Costos:**
    1.  **Processing Fee**: 1 crédito por intento de generación.
    2.  **Success Fee**: Cobro adicional solo si la regla es válida y funcional.
        *   Standard: +2 créditos.
        *   Pro: +4 créditos.
        *   Max: +9 créditos.

    ---

    ## 5. Guía Técnica de Integración

    ### 5.1 Credenciales
    *   **Endpoint Base**: `http://143.198.61.64:8080`
    *   **Autenticación**: Header `X-API-Key: <SU_API_KEY>`

    ### 5.2 Endpoints Principales

    #### Subir Código (`POST /codeaudit/upload`)
    Envía un archivo ZIP para iniciar una auditoría.

    **Ejemplo de Solicitud (cURL):**
    ```bash
    curl -X POST "http://143.198.61.64:8080/codeaudit/upload" \
      -H "X-API-Key: SU_API_KEY_AQUI" \
      -F "file=@./mi-proyecto.zip" \
      -F "project_alias=backend-core" \
      -F "profile=auto" \
      -F "custom_rules=true" \
      -F "custom_rules_qty=3" \
      -F "custom_rule_model=standard"
    ```

    **Parámetros del Formulario (Multipart/Form-Data):**

    | Parámetro | Tipo | Requerido | Descripción | Valores Permitidos | Default |
    | :--- | :--- | :---: | :--- | :--- | :--- |
    | `file` | Binary | **Sí** | Archivo ZIP con el código fuente. | Archivo `.zip` válido | - |
    | `project_alias` | String | No | Identificador legible del proyecto. | Alfanumérico, guiones, guion bajo (3-50 caracteres). Ej: `backend-core` | - |
    | `profile` | String | No | Perfil de escaneo. | `auto` | `auto` |
    | `double_check` | String | No | **[DEPRECATED]** Activa la "Segunda Opinión" con IA externa. Use `/api/v1/findings/double-check`. | `critical`, `high`, `medium`, `low`, `all`, `false` | `false` |
    | `double_check_level` | String | No | **[DEPRECATED]** Profundidad y costo del análisis Double Check. | `standard` (1 cr), `pro` (2 cr), `max` (3 cr) | `standard` |
    | `custom_rules` | Boolean | No | Activa la generación de reglas personalizadas. | `true`, `false` | `false` |
    | `custom_rules_qty` | Integer | No | Cantidad de reglas a intentar generar. | 1 - 10 | 3 |
    | `custom_rule_model` | String | No | Modelo de IA para generación de reglas. | `standard`, `pro` (Premium/Ent), `max` (Ent) | `standard` |

    **Ejemplos de Respuesta:**

    *Exito (Tarea Encolada):*
    ```json
    {
      "ok": true,
      "taskId": "550e8400-e29b-41d4-a716-446655440000",
      "status": "queued",
      "projectId": "3b4926f1-a15a-4b33-9f2d-4ae88427e583",
      "isRetest": true
    }
    ```

    *Error de Seguridad (Bloqueo de Amenaza):*
    ```json
    {
      "ok": false,
      "error": "Security check failed: Security Policy Violation: File identified as potential threat."
    }
    ```

    #### Consultar Estado (`GET /codeaudit/:taskId`)
    Obtiene el estado y resultados de la auditoría.

    **Posibles Estados:**
    *   `queued`: En espera.
    *   `running`: Análisis en progreso.
    *   `completed`: Finalizado (incluye reporte).
    *   `failed`: Error en el proceso.

    **Ejemplos de Respuesta:**

    *En Progreso:*
    ```json
    {
      "ok": true,
      "status": "running",
      "taskId": "550e8400-...",
      "progress": "45%",
      "eta": "120s"
    }
    ```

    *Completado (Resumen):*
    ```json
    {
      "ok": true,
      "status": "completed",
      "taskId": "550e8400-...",
      "progress": "100%",
      "eta": "0s",
      "result": {
        "summary": {
          "severity": { "high": 12, "medium": 5, "low": 20 },
          "findingsCount": 37
        },
        "findings": [ ... ]
      }
    }
    ```

    #### Accesos Directos y Reportes Web

    Facilite el acceso a la información sin recordar IDs específicos.

    *   **Última Auditoría Completada**:
        *   API: `GET /codeaudit/latest`
        *   Web: `GET /codeaudit/latest?format=html` (Redirección automática al reporte visual).

    *   **Índice de Auditorías**:
        *   Web: `GET /codeaudit/index` (Tabla HTML con historial de tareas y estados).

    #### Historial y Proyectos

    Gestione y consulte el historial de auditorías organizadas por proyecto.

    **1. Listar Proyectos (`GET /projects`)**
    Obtiene una lista de todos los proyectos registrados.

    ```bash
    curl -X GET "http://143.198.61.64:8080/projects" -H "X-API-Key: SU_API_KEY_AQUI"
    ```

    **2. Historial de Proyecto (`GET /projects/:alias/history`)**
    Consulta todos los escaneos realizados sobre un alias específico.

    ```bash
    curl -X GET "http://143.198.61.64:8080/projects/backend-core/history" -H "X-API-Key: SU_API_KEY_AQUI"
    ```

    **Respuesta de Ejemplo:**
    ```json
    {
      "ok": true,
      "projectId": "3b4926f1-a15a-4b33-9f2d-4ae88427e583",
      "history": [
        {
          "taskId": "550e8400-...",
          "status": "completed",
          "created_at": "2025-12-06T10:00:00Z",
          "is_retest": true
        },
        {
          "taskId": "123f5678-...",
          "status": "completed",
          "created_at": "2025-12-01T09:30:00Z",
          "is_retest": false
        }
      ]
    }
    ```

    ---

    ## 6. Interpretación de Resultados

    El reporte JSON incluye un arreglo de `findings`. El campo más importante es `analysis_json`, que contiene la evaluación de la IA:

    *   **triage**: Veredicto (`True Positive`, `False Positive`, `Needs Review`).
    *   **reasoning**: Explicación técnica del hallazgo en el contexto de su código.
    *   **recommendation**: Solución sugerida.
    *   **severity_adjustment**: Ajuste dinámico de la severidad basado en el impacto real.
    *   **double_check**: (Si se activó) Resultado de la segunda opinión externa.

    ---

    ## 7. Soporte

    Para asistencia técnica, dudas sobre integración o reporte de incidentes, contacte a su administrador de cuenta SecureTag o al equipo de soporte técnico.

    ---
    *Documento generado el: 2025-12-23*
  version: 1.0.0
servers:
  - url: /
    description: API Server

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
  schemas:
    Error:
      type: object
      properties:
        ok:
          type: boolean
          example: false
        error:
          type: string
          example: "Error message"
    TaskResponse:
      type: object
      properties:
        ok:
          type: boolean
        taskId:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, running, completed, failed]
        projectId:
          type: string
          format: uuid
        isRetest:
          type: boolean
        progress:
          type: string
          description: "Percentage of completion (e.g., '45%')"
          example: "45%"
        eta:
          type: string
          description: "Estimated time remaining (e.g., '120s')"
          example: "120s"
    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        alias:
          type: string
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
          format: date-time
    TaskHistory:
      type: object
      properties:
        taskId:
          type: string
          format: uuid
        status:
          type: string
        created_at:
          type: string
          format: date-time
        finished_at:
          type: string
          format: date-time
        is_retest:
          type: boolean
        previous_task_id:
          type: string
          format: uuid
        critical:
          type: integer
          description: Count of critical vulnerabilities
        high:
          type: integer
          description: Count of high vulnerabilities
        medium:
          type: integer
          description: Count of medium vulnerabilities
        low:
          type: integer
          description: Count of low vulnerabilities
        info:
          type: integer
          description: Count of info vulnerabilities
        totalVulns:
          type: integer
          description: Total count of vulnerabilities

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        username:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        jobTitle:
          type: string
        phoneNumber:
          type: string
        about:
          type: string
        avatarUrl:
          type: string
        role:
          type: string
        tenantId:
          type: string
          format: uuid

security:
  - ApiKeyAuth: []

paths:
  /dashboard/stats:
    get:
      summary: Get Dashboard Metrics
      description: Returns aggregated statistics for the user's dashboard (credits, projects, active scans, vulnerability distribution).
      security:
        - ApiKeyAuth: []
      responses:
        200:
          description: Dashboard metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  stats:
                    type: object
                    properties:
                      credits: { type: integer }
                      activeScans: { type: integer }
                      totalVulns: { type: integer }
                      totalProjects: { type: integer }
                  severity:
                    type: object
                    properties:
                      critical: { type: integer }
                      high: { type: integer }
                      medium: { type: integer }
                      low: { type: integer }
                      info: { type: integer }
                  recentScans:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        project: { type: string }
                        status: { type: string }
                        date: { type: string }
                        critical: { type: integer }
                        high: { type: integer }
                        medium: { type: integer }
                        low: { type: integer }
                        info: { type: integer }
                  missingKey:
                    type: boolean
        401:
          description: Unauthorized
        500:
          description: Server Error

  /reports/{taskId}/{type}:
    get:
      summary: Download Professional Reports
      description: |
        Generates and downloads audit reports in various formats.
        Supported types: 'executive' (PDF), 'technical' (PDF), 'json', 'xml'.
      security:
        - ApiKeyAuth: []
      parameters:
        - in: path
          name: taskId
          schema:
            type: string
            format: uuid
          required: true
          description: Unique identifier of the audit task
        - in: path
          name: type
          schema:
            type: string
            enum: [executive, technical, json, xml]
          required: true
          description: Type of report to generate
      responses:
        200:
          description: Report generated successfully
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                type: object
                description: Full audit data structure
            application/xml:
              schema:
                type: string
                description: JUnit/XML compatible format
        400:
          description: Invalid request or unsupported report type
        401:
          description: Unauthorized
        404:
          description: Task not found
        500:
          description: Server Error (Generation failed)

  /api/v1/auth/sync:
    post:
      summary: Synchronize User Identity (Frontend <-> Backend)
      description: |
        Internal endpoint used by Frontend Server to register or sync a user with the Backend Core.
        If user exists, returns their tenant/user IDs.
        If user is new, creates a Personal Tenant and Admin User.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                name:
                  type: string
                source:
                  type: string
      responses:
        200:
          description: User synced successfully (Existing)
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id: { type: string, format: uuid }
                  tenant_id: { type: string, format: uuid }
                  role: { type: string }
                  is_new: { type: boolean }
        201:
          description: User created successfully (New)
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id: { type: string, format: uuid }
                  tenant_id: { type: string, format: uuid }
                  role: { type: string }
                  is_new: { type: boolean }
        400:
          description: Invalid Input
        401:
          description: Unauthorized (Missing System Secret)

  /api/v1/findings/double-check:
    post:
      summary: Perform On-Demand AI Double Check
      description: |
        Executes an AI-powered validation ("Second Opinion") on a specific finding.
        Requires 'security credits'. Deducts credits only if analysis is successful.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - finding_id
              properties:
                finding_id:
                  type: string
                  format: uuid
                  description: ID of the finding to analyze
                model:
                  type: string
                  enum: [standard, pro, max]
                  default: standard
                  description: AI Model complexity level (affects credit cost)
      responses:
        200:
          description: Analysis successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean, example: true }
                  analysis:
                    type: object
                    properties:
                      triage:
                        type: string
                        example: "False Positive"
                      reasoning:
                        type: string
                        example: "El código utiliza una variable sanitizada previamente..."
                      confidence:
                        type: string
                        example: "High"
                  credits_deducted:
                    type: integer
                    example: 1
        400:
          description: Invalid request or missing evidence (code_snippet)
        401:
          description: Unauthorized
        402:
          description: Insufficient credits or Payment Required
        404:
          description: Finding not found
        500:
          description: Server Error

  /healthz:
    get:
      summary: System Health Check
      security: []
      responses:
        200:
          description: System is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true

  /healthz/db:
    get:
      summary: Database Health Check
      security: []
      responses:
        200:
          description: Database is connected
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
                  db:
                    type: string
                    example: "connected"
        503:
          description: Database is disconnected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /codeaudit/upload:
    post:
      summary: Upload code for SAST analysis
      description: |
        Upload a ZIP file containing source code for security analysis.
        Supports advanced features like Double Check (AI 2nd opinion) and Generative Custom Rules.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: ZIP file containing source code
                project_alias:
                  type: string
                  description: Alias for the project (e.g., "backend-core")
                profile:
                  type: string
                  description: Scan profile (e.g., "auto", "security")
                double_check:
                  type: string
                  enum: [critical, high, medium, low, all, "false"]
                  default: "false"
                  deprecated: true
                  description: |
                    [DEPRECATED] Use on-demand double check via /api/v1/findings/double-check instead.
                    Enable AI Second Opinion validation.
                    Values: 'critical', 'high', 'medium', 'low', 'all' (activates for specified severities and above), or 'false' to disable.
                double_check_level:
                  type: string
                  enum: [standard, pro, max]
                  default: standard
                  deprecated: true
                  description: |
                    [DEPRECATED] Use on-demand double check via /api/v1/findings/double-check instead.
                    Depth and cost of the Double Check analysis.
                    - standard: Fast Reasoning (1 credit)
                    - pro: Advanced Reasoning (2 credits)
                    - max: SOTA Reasoning (3 credits)
                custom_rules:
                  type: boolean
                  default: false
                  description: Enable Generative Custom Rules creation based on project stack.
                custom_rules_qty:
                  type: integer
                  minimum: 1
                  maximum: 10
                  default: 3
                  description: Number of custom rules to attempt to generate.
                custom_rule_model:
                  type: string
                  enum: [standard, pro, max]
                  default: standard
                  description: |
                    AI Model for custom rule generation.
                    - standard: Fast
                    - pro: Complex (Premium/Enterprise)
                    - max: Deep/Edge Cases (Enterprise)
      responses:
        202:
          description: Task accepted and queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        400:
          description: Bad Request or Security Violation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                security_error:
                  value:
                    ok: false
                    error: "Security Policy Violation: File identified as potential threat."
        403:
          description: Access Denied (Banned)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                ip_ban:
                  value:
                    ok: false
                    error: "Access denied. IP address temporarily banned due to security violations."
                apikey_ban:
                  value:
                    ok: false
                    error: "Access denied. API Key has been permanently banned due to security violations."
                tenant_ban:
                  value:
                    ok: false
                    error: "Access denied. Tenant account suspended due to Terms of Service violation."
        429:
          description: Rate Limit Exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                ok: false
                error: "Upload limit exceeded. Please wait."
        503:
          description: Service Unavailable (DB Issue)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /codeaudit/latest:
    get:
      summary: Get latest completed scan
      description: Retrieves the ID of the most recently completed audit task. Can return JSON or redirect to the HTML report.
      parameters:
        - in: query
          name: format
          schema:
            type: string
            enum: [json, html]
          description: Response format (default json, use html for browser redirect)
      responses:
        200:
          description: Latest task ID found
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  taskId:
                    type: string
                    format: uuid
        302:
          description: Redirect to HTML report
        404:
          description: No completed tasks found
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  error:
                    type: string

  /codeaudit/index:
    get:
      summary: List all scans
      description: Returns an HTML page listing all audit tasks for the current tenant.
      responses:
        200:
          description: HTML list of audits
          content:
            text/html:
              schema:
                type: string
        503:
          description: Service Unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /codeaudit/{taskId}:
    get:
      summary: Get scan status and results
      parameters:
        - in: path
          name: taskId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        200:
          description: Scan completed or status
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  status:
                    type: string
                  taskId:
                    type: string
                  progress:
                    type: string
                    description: "Percentage of completion"
                    example: "100%"
                  eta:
                    type: string
                    description: "Estimated time remaining"
                    example: "0s"
                  result:
                    type: object
                    description: Full scan result (findings, summary, diff)
        202:
          description: Scan in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        404:
          description: Task not found
        503:
          description: Service Unavailable

  /projects:
    get:
      summary: List all projects
      responses:
        200:
          description: List of projects
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  projects:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
        503:
          description: Service Unavailable

  /projects/{alias}/history:
    get:
      summary: Get scan history for a project
      parameters:
        - in: path
          name: alias
          required: true
          schema:
            type: string
            description: Project alias or UUID
      responses:
        200:
          description: Project history
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  projectId:
                    type: string
                  history:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskHistory'
        404:
          description: Project not found
        503:
          description: Service Unavailable

  /api/v1/tenant/me:
    get:
      summary: Get Tenant Info
      description: Retrieve information about the current tenant (organization).
      security:
        - ApiKeyAuth: []
      tags:
        - Tenant
      responses:
        '200':
          description: Tenant information retrieved successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  plan:
                    type: string
                    enum: [free, premium, enterprise]
                  credits_balance:
                    type: integer
                  created_at:
                    type: string
                    format: date-time
        '401':
          description: Unauthorized (Invalid API Key).
        '500':
          description: Internal Server Error.

  /api/v1/tenant/users:
    get:
      summary: List Tenant Users
      description: Retrieve a list of all users belonging to the tenant.
      security:
        - ApiKeyAuth: []
      tags:
        - Tenant
      responses:
        '200':
          description: List of users retrieved successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    email:
                      type: string
                      format: email
                    role:
                      type: string
                      enum: [admin, member]
                    created_at:
                      type: string
                      format: date-time
                    last_login:
                      type: string
                      format: date-time
        '401':
          description: Unauthorized.
        '500':
          description: Internal Server Error.

  /api/v1/tenant/invite:
    post:
      summary: Invite User
      description: Invite a new user to the tenant. Only admins can perform this action.
      security:
        - ApiKeyAuth: []
      tags:
        - Tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [admin, member]
                  default: member
      responses:
        '201':
          description: User invited successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  email:
                    type: string
                  role:
                    type: string
                  created_at:
                    type: string
                    format: date-time
        '400':
          description: Invalid input or user already exists.
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden (Non-admin user).
        '409':
          description: User already in tenant.
        '500':
          description: Internal Server Error.

  /api/v1/tenant/users/{id}:
    delete:
      summary: Remove User
      description: Remove a user from the tenant. Only admins can perform this action.
      security:
        - ApiKeyAuth: []
      tags:
        - Tenant
      parameters:
        - in: path
          name: id
          schema:
            type: string
            format: uuid
          required: true
          description: ID of the user to remove
      responses:
        '200':
          description: User removed successfully.
        '400':
          description: Cannot remove yourself.
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden (Non-admin user).
        '404':
          description: User not found.
        '500':
          description: Internal Server Error.

  /api/v1/tenant/users/{id}/role:
    put:
      summary: Update User Role
      description: Update a user's role (e.g., promote to admin). Only admins can perform this action.
      security:
        - ApiKeyAuth: []
      tags:
        - Tenant
      parameters:
        - in: path
          name: id
          schema:
            type: string
            format: uuid
          required: true
          description: ID of the user to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role
              properties:
                role:
                  type: string
                  enum: [admin, member]
      responses:
        '200':
          description: User role updated successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  role:
                    type: string
        '400':
          description: Invalid input.
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden.
        '404':
          description: User not found.
        '500':
          description: Internal Server Error.
